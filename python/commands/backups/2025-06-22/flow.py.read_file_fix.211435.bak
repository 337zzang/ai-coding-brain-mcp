#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
FLOW Command - AI Coding Brain MCP
/flow ëª…ë ¹ì–´ ì²˜ë¦¬

ì‘ì„±ì¼: 2025-06-20
"""

import os
from datetime import datetime
import json
import datetime as dt
from pathlib import Path
from typing import Dict, Any, Optional

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from core.context_manager import get_context_manager
from core.config import get_paths_from_config
from api.public import initialize_context
from core.project_summary import generate_project_context_summary

# ===========================================
# FLOW ëª…ë ¹ì–´
# ===========================================

def cmd_flow(project_name: str = None, existing_context: Dict[str, Any] = None) -> Dict[str, Any]:
    """/flow ëª…ë ¹ì–´ - í”„ë¡œì íŠ¸ ì „í™˜"""
    
    paths = get_paths_from_config()
    memory_root = str(paths['memory_root'])
    
    if not project_name:
        # í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ
        print("\nğŸ“‹ ë“±ë¡ëœ í”„ë¡œì íŠ¸ ëª©ë¡:")
        print("="*60)
        
        project_count = 0
        if os.path.exists(memory_root):
            import re
            version_patterns = [
                r'^[a-zA-Z]+-\d+\.\d+\.\d+$',
                r'^app-\d+\.\d+\.\d+$',
                r'^project-\d+\.\d+\.\d+$',
                r'^v\d+\.\d+\.\d+$'
            ]
            
            for item in sorted(os.listdir(memory_root)):
                is_version_pattern = any(re.match(pattern, item) for pattern in version_patterns)
                if is_version_pattern:
                    continue
                    
                item_path = os.path.join(memory_root, item)
                if os.path.isdir(item_path) and item != 'common':
                    # ìƒˆë¡œìš´ ìºì‹œ íŒŒì¼ ìœ„ì¹˜ í™•ì¸
                    cache_file = os.path.join(item_path, '.cache', 'cache_core.json')
                    if os.path.exists(cache_file):
                        try:
                            with open(cache_file, 'r', encoding='utf-8') as f:
                                cache_data = json.load(f)
                                actual_path = cache_data.get('project_path', 'Unknown')
                                last_accessed = cache_data.get('updated_at', 'Unknown')
                                
                                current_marker = " ğŸ”¥" if get_context_manager().project_name == item else ""
                                print(f"  â€¢ {item}{current_marker}")
                                print(f"    ğŸ“ ê²½ë¡œ: {actual_path}")
                                print(f"    ğŸ• ìµœê·¼ ì ‘ê·¼: {last_accessed[:10] if last_accessed != 'Unknown' else 'Unknown'}")
                                project_count += 1
                        except:
                            print(f"  â€¢ {item} (ìºì‹œ ì½ê¸° ì‹¤íŒ¨)")
        
        if project_count == 0:
            print("  ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            print(f"\nì´ {project_count}ê°œì˜ í”„ë¡œì íŠ¸")
            
        print("\nì‚¬ìš©ë²•: /flow [í”„ë¡œì íŠ¸ëª…]")
        return {
            'success': True,
            'message': 'í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ ì™„ë£Œ',
            'project_count': project_count,
            'action': 'list_projects'
        }
    
    # ì´ì „ ì»¨í…ìŠ¤íŠ¸ ì €ì¥
    if get_context_manager().context and get_context_manager().project_name:
        import re
        version_patterns = [
            r'^[a-zA-Z]+-\d+\.\d+\.\d+$',
            r'^app-\d+\.\d+\.\d+$',
            r'^project-\d+\.\d+\.\d+$',
            r'^v\d+\.\d+\.\d+$'
        ]
        is_version_pattern = any(re.match(pattern, get_context_manager().project_name) for pattern in version_patterns)
        
        if not is_version_pattern:
            prev_cache_dir = os.path.join(memory_root, get_context_manager().project_name, '.cache')
            if os.path.exists(prev_cache_dir):
                get_context_manager().save()
    
    # Memory í´ë”ì—ì„œ í”„ë¡œì íŠ¸ ìºì‹œ í™•ì¸
    project_cache_dir = os.path.join(memory_root, project_name, '.cache')
    cache_file = os.path.join(project_cache_dir, 'cache_core.json')
    
    project_path = None
    location = 'unknown'
    
    if os.path.exists(cache_file):
        # ìºì‹œì—ì„œ í”„ë¡œì íŠ¸ ê²½ë¡œ ì½ê¸°
        try:
            with open(cache_file, 'r', encoding='utf-8') as f:
                cache_data = json.load(f)
                cached_path = cache_data.get('project_path')
                
                if cached_path and os.path.exists(cached_path):
                    project_path = Path(cached_path)
                    location = 'cached'
                    print(f"\nâœ… Memoryì—ì„œ í”„ë¡œì íŠ¸ ì°¾ìŒ: {project_name}")
        except Exception as e:
            print(f"\nâš ï¸ ìºì‹œ ì½ê¸° ì‹¤íŒ¨: {e}")
    
    # ìºì‹œì— ì—†ê±°ë‚˜ ê²½ë¡œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ì°¾ê¸°
    if not project_path:
        desktop_path = paths['project_path'] / project_name
        if desktop_path.exists():
            project_path = desktop_path
            location = 'desktop'
        else:
            if os.path.basename(os.getcwd()) == project_name:
                project_path = Path(os.getcwd())
                location = 'current'
            else:
                if existing_context:
                    project_path = Path(os.getcwd())
                    location = 'current'
                else:
                    print(f"\nâŒ í”„ë¡œì íŠ¸ '{project_name}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                    return {
                        'success': False,
                        'message': f'í”„ë¡œì íŠ¸ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {project_name}',
                        'project_name': project_name
                    }
    
    # ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½
    directory_changed = False
    directory_error = None
    
    try:
        # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
        if not os.path.exists(str(project_path)):
            print(f"âš ï¸ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {project_path}")
            # ë””ë ‰í† ë¦¬ ìƒì„± ì‹œë„
            try:
                os.makedirs(str(project_path), exist_ok=True)
                print(f"âœ… í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±ë¨: {project_path}")
            except Exception as create_err:
                print(f"âŒ ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨: {create_err}")
                directory_error = str(create_err)
        
        # ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œë„
        os.chdir(str(project_path))
        current_dir = os.getcwd()
        if os.path.samefile(current_dir, str(project_path)):
            print(f"ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½ ì„±ê³µ: {project_path}")
            directory_changed = True
        else:
            print(f"âš ï¸ ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹¤íŒ¨: í˜„ì¬ {current_dir}")
            directory_error = "ë””ë ‰í† ë¦¬ ë³€ê²½ í›„ ê²½ë¡œ ë¶ˆì¼ì¹˜"
    except Exception as e:
        print(f"\nâš ï¸ ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹¤íŒ¨: {e}")
        directory_error = str(e)
        # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ìºì‹œëŠ” ì‚¬ìš© ê°€ëŠ¥)
    
    # ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    if 'context' in globals():
        globals()['context'].clear()
    
    context = initialize_context(
        project_path=str(project_path),
        project_name=project_name,
        memory_root=memory_root,
        existing_context=existing_context
    )
    
    print(f"\nâœ… í”„ë¡œì íŠ¸ '{project_name}'ë¡œ ì „í™˜ ì™„ë£Œ!")
    print(f"ğŸ“ ì‘ì—… ê²½ë¡œ: {project_path} ({location})")
    if directory_error:
        print(f"âš ï¸ ë””ë ‰í† ë¦¬ ê´€ë ¨ ê²½ê³ : {directory_error}")
    print(f"ğŸ’¾ ìºì‹œ ê²½ë¡œ: {memory_root}/{project_name}/.cache/")
    print(f"ğŸ“Š ìºì‹œ ë²„ì „: {context.get('version', 'unknown')}")
    print(f"ğŸ“ˆ ë¶„ì„ëœ íŒŒì¼: {len(context.get('analyzed_files', {}))}ê°œ")
    
    tasks = context.get('tasks', {})
    if isinstance(tasks, dict):
        next_count = len(tasks.get('next', []))
        done_count = len(tasks.get('done', []))
        print(f"ğŸ“‹ ë‚¨ì€ ì‘ì—…: {next_count}ê°œ")
        print(f"âœ… ì™„ë£Œëœ ì‘ì—…: {done_count}ê°œ")

    
    # í˜„ì¬ ê³„íš ì •ë³´ í‘œì‹œ
    plan = context.get('plan')
    if plan:
        print(f"\nğŸ“… í˜„ì¬ ê³„íš: {plan.get('name', 'N/A')}")
        current_task_id = context.get('current_task')
        if current_task_id:
            # í˜„ì¬ ì‘ì—… ì°¾ê¸°
            for phase_id, phase in plan.get('phases', {}).items():
                for task in phase.get('tasks', []):
                    if task.get('id') == current_task_id:
                        print(f"ğŸ¯ í˜„ì¬ ì‘ì—…: [{task['id']}] {task.get('title', 'N/A')}")
                        print(f"   ìƒíƒœ: {task.get('status', 'pending')}")
                        break
        
        # Phaseë³„ ì§„í–‰ ìƒí™©
        print("\nğŸ“Š Phaseë³„ ì§„í–‰ ìƒí™©:")
        for phase_id, phase in plan.get('phases', {}).items():
            tasks = phase.get('tasks', [])
            completed = sum(1 for t in tasks if t.get('status') == 'completed')
            in_progress = sum(1 for t in tasks if t.get('status') == 'in_progress')
            
            status_icon = "âœ…" if phase.get('status') == 'completed' else "ğŸ”„" if in_progress > 0 else "ğŸ“"
            print(f"   {status_icon} {phase.get('name', phase_id)}: {completed}/{len(tasks)} ì™„ë£Œ")

    # ê¸€ë¡œë²Œ context ì—…ë°ì´íŠ¸ - ê°œì„ ëœ ë°©ë²•
    # 1. í˜„ì¬ ëª¨ë“ˆì˜ globals() ì—…ë°ì´íŠ¸
    if 'context' in globals():
        globals()['context'].update(context)
    else:
        globals()['context'] = context

    # ğŸ§  í”„ë¡œì íŠ¸ ì§€í˜œ ê´€ë¦¬ ì‹œìŠ¤í…œ (í•­ìƒ ì‹¤í–‰)
    # 1. project_vision.md ë¡œë“œ
    vision_path = os.path.join(project_path, "project_vision.md")
    if os.path.exists(vision_path):
        try:
            vision_content = read_file(vision_path)
            context['project_vision'] = {
                'content': vision_content[:500] + "..." if len(vision_content) > 500 else vision_content,
                'sections': [],
                'last_loaded': datetime.now().isoformat(),
                'file_path': 'project_vision.md'
            }
            print("ğŸ“Œ project_vision.md ë¡œë“œ ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ project_vision.md ë¡œë“œ ì‹¤íŒ¨: {e}")

    # 2. project_wisdom ì´ˆê¸°í™” ë˜ëŠ” ë¡œë“œ
    if 'project_wisdom' not in context:
        context['project_wisdom'] = {
            'error_patterns': {},
            'common_mistakes': {},
            'best_practices': [],
            'last_updated': datetime.now().isoformat()
        }
    
    # 3. ì „ì—­ context ì¬ì—…ë°ì´íŠ¸ (wisdom í¬í•¨)
    if 'context' in globals():
        globals()['context'].update(context)

# ëª…ë ¹ì–´ ì²˜ë¦¬ í•¨ìˆ˜ë“¤ (cmd_plan, cmd_task, cmd_next)ì€ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ...


# ===========================================
# ë©”ì¸ ì§„ì…ì 
# ===========================================

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1:
        command = ' '.join(sys.argv[1:])
        # process_command(command)
    else:
        print("AI Coding Brain v7.0 (ìºì‹œ êµ¬ì¡° ê°œì„ )")
        print("ì‚¬ìš©ë²•: python claude_code_ai_brain.py [ëª…ë ¹ì–´]")
        print("ëª…ë ¹ì–´: /flow, /plan, /task, /next, /save")

