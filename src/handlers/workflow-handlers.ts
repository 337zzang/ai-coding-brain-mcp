"import { ToolResult } from '../types/tool-interfaces';\nimport { logger } from '../services/logger';\n// import { getActiveReplSession } from './repl-session-manager'; // Not exported\n\ninterface FlowProjectResult {\n    success: boolean;\n    project_name?: string;\n    path?: string;\n    git_branch?: string;\n    workflow_status?: any;\n    error?: string;\n    details?: any;\n}\n\nexport async function handleFlowProject(params: { project_name: string }): Promise<ToolResult> {\n    const code = `\n# ê°œì„ ëœ flow_project í•¸ë“¤ëŸ¬ - ëª…ì‹œì  ì—ëŸ¬ ì²˜ë¦¬\nimport sys\nimport os\nimport json\nimport traceback\nfrom pathlib import Path\n\nproject_name = \"${params.project_name}\"\nresult = {\n    \"success\": False,\n    \"project_name\": project_name,\n    \"error\": None,\n    \"details\": {}\n}\n\n# ë¡œê·¸ ì¶œë ¥ì„ ì–µì œí•˜ê¸° ìœ„í•œ ì„¤ì •\nimport logging\nlogging.getLogger().setLevel(logging.CRITICAL)\n\n# stdout ìº¡ì²˜ë¥¼ ìœ„í•œ ì„¤ì •\nfrom io import StringIO\ncaptured_output = StringIO()\n\ntry:\n    # 1. Python ê²½ë¡œ ì„¤ì •\n    current_dir = Path.cwd()\n    python_dir = current_dir / 'python'\n    if python_dir.exists() and str(python_dir) not in sys.path:\n        sys.path.insert(0, str(python_dir))\n\n    # 2. enhanced_flow import\n    try:\n        from enhanced_flow import cmd_flow_with_context\n    except ImportError as e:\n        result[\"error\"] = f\"enhanced_flow ëª¨ë“ˆ import ì‹¤íŒ¨: {str(e)}\"\n        result[\"details\"][\"import_error\"] = traceback.format_exc()\n        print(f\"JSON_RESULT_START{json.dumps(result, ensure_ascii=False)}JSON_RESULT_END\")\n        sys.exit(1)\n\n    # 3. stdout ë¦¬ë‹¤ì´ë ‰íŠ¸\n    original_stdout = sys.stdout\n    sys.stdout = captured_output\n    \n    try:\n        # 4. í”„ë¡œì íŠ¸ ì „í™˜ ì‹¤í–‰\n        flow_result = cmd_flow_with_context(project_name)\n\n        if flow_result and isinstance(flow_result, dict):\n            result[\"success\"] = True\n            result[\"path\"] = flow_result.get(\"context\", {}).get(\"project_path\", os.getcwd())\n            result[\"git_branch\"] = flow_result.get(\"context\", {}).get(\"git\", {}).get(\"branch\", \"unknown\")\n            result[\"workflow_status\"] = flow_result.get(\"workflow_status\", {})\n            # ì¶”ê°€ ë°ì´í„° ìˆ˜ì§‘ (README, file_directory, workflow)\n            project_path = flow_result.get(\"path\", \".\")\n            if not project_path:\n                project_path = flow_result.get(\"context\", {}).get(\"project_path\", \".\")\n            \n            # 1. flow_project_view ë°ì´í„° ìˆ˜ì§‘\n            flow_project_view = {}\n            \n            # README.md ì½ê¸°\n            try:\n                readme_path = Path(project_path) / \"README.md\"\n                if readme_path.exists():\n                    with open(readme_path, 'r', encoding='utf-8') as f:\n                        flow_project_view[\"readme\"] = f.read()\n                else:\n                    flow_project_view[\"readme\"] = \"âš ï¸ README.md not found\"\n            except Exception as e:\n                flow_project_view[\"readme\"] = f\"âš ï¸ Error reading README.md: {str(e)}\"\n            \n            # file_directory.md ì½ê¸°\n            try:\n                file_dir_path = Path(project_path) / \"file_directory.md\"\n                if file_dir_path.exists():\n                    with open(file_dir_path, 'r', encoding='utf-8') as f:\n                        flow_project_view[\"fileDirectoryMd\"] = f.read()\n                else:\n                    flow_project_view[\"fileDirectoryMd\"] = \"âš ï¸ file_directory.md not found\"\n            except Exception as e:\n                flow_project_view[\"fileDirectoryMd\"] = f\"âš ï¸ Error reading file_directory.md: {str(e)}\"\n            \n            # workflow ì •ë³´ ì½ê¸°\n            try:\n                workflow_path = Path(project_path) / \"memory\" / \"workflow.json\"\n                if not workflow_path.exists():\n                    workflow_path = Path(project_path) / \"memory\" / \"workflow_data.json\"\n                if workflow_path.exists():\n                    with open(workflow_path, 'r', encoding='utf-8') as f:\n                        flow_project_view[\"workflowDetail\"] = f.read()\n                else:\n                    flow_project_view[\"workflowDetail\"] = \"âš ï¸ workflow files not found\"\n            except Exception as e:\n                flow_project_view[\"workflowDetail\"] = f\"âš ï¸ Error reading workflow: {str(e)}\"\n            \n            # flow_project_viewë¥¼ ê²°ê³¼ì— ì¶”ê°€\n            flow_result[\"flow_project_view\"] = flow_project_view\n            \n            # 2. file_access_historyë¥¼ ìµœê·¼ 5ê°œë¡œ ì œí•œ\n            if \"context\" in flow_result and \"file_access_history\" in flow_result.get(\"context\", {}):\n                history = flow_result[\"context\"][\"file_access_history\"]\n                if isinstance(history, list) and len(history) > 5:\n                    # ìµœê·¼ 5ê°œë§Œ ì„ íƒí•˜ê³  ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ë¨¼ì €)\n                    flow_result[\"context\"][\"file_access_history\"] = history[-5:][::-1]\n            \n            result[\"details\"] = flow_result\n        else:\n            result[\"error\"] = f\"ì˜ˆìƒì¹˜ ëª»í•œ ë°˜í™˜ê°’: {type(flow_result)}\"\n            result[\"details\"][\"return_value\"] = str(flow_result)\n\n    except Exception as e:\n        result[\"error\"] = f\"í”„ë¡œì íŠ¸ ì „í™˜ ì¤‘ ì˜¤ë¥˜: {str(e)}\"\n        result[\"details\"][\"traceback\"] = traceback.format_exc()\n        result[\"details\"][\"exception_type\"] = type(e).__name__\n    finally:\n        # stdout ë³µì›\n        sys.stdout = original_stdout\n        captured_logs = captured_output.getvalue()\n        result[\"details\"][\"logs\"] = captured_logs\n\n    # 5. ê²°ê³¼ ì¶œë ¥ (JSONë§Œ ì¶œë ¥)\n    print(f\"JSON_RESULT_START{json.dumps(result, ensure_ascii=False)}JSON_RESULT_END\")\n\nexcept Exception as e:\n    # ìµœìƒìœ„ ì˜ˆì™¸ ì²˜ë¦¬\n    result[\"error\"] = f\"ì¹˜ëª…ì  ì˜¤ë¥˜: {str(e)}\"\n    result[\"details\"][\"fatal_traceback\"] = traceback.format_exc()\n    print(f\"JSON_RESULT_START{json.dumps(result, ensure_ascii=False)}JSON_RESULT_END\")\n    sys.exit(1)`;\n\n    try {\n        // ExecuteCodeHandlerë¥¼ ì‚¬ìš©í•˜ì—¬ Python ì½”ë“œ ì‹¤í–‰\n        const { ExecuteCodeHandler } = await import('./execute-code-handler');\n        const toolResult = await ExecuteCodeHandler.handleExecuteCode({ code, language: 'python' });\n        \n        // ToolResultì—ì„œ ì‹¤ì œ ê²°ê³¼ ì¶”ì¶œ\n        let execResult: any;\n        try {\n            // toolResult.content[0].textëŠ” JSON ë¬¸ìì—´\n            const resultText = toolResult.content[0]?.text || '';\n            execResult = JSON.parse(resultText);\n        } catch (e) {\n            logger.error('Failed to parse ExecuteCodeHandler result:', e);\n            return {\n                content: [{\n                    type: 'text',\n                    text: `âŒ ê²°ê³¼ í˜•ì‹ ì˜¤ë¥˜\\n\\n${toolResult.content[0]?.text || ''}`\n                }]\n            };\n        }\n        \n        // ì—ëŸ¬ í™•ì¸\n        if (!execResult.success || execResult.error) {\n            logger.error('Python execution failed:', execResult.error);\n            return {\n                content: [{\n                    type: 'text',\n                    text: `âŒ Python ì‹¤í–‰ ì‹¤íŒ¨\\n\\nì—ëŸ¬: ${execResult.error || 'Unknown error'}\\n\\n${execResult.stderr || ''}`\n                }]\n            };\n        }\n\n        // stdoutì—ì„œ JSON ê²°ê³¼ ì¶”ì¶œ\n        let result: FlowProjectResult;\n        try {\n            // stdoutì—ì„œ JSON_RESULT_STARTì™€ JSON_RESULT_END ë§ˆì»¤ë¡œ ê°ì‹¸ì§„ JSON ì¶”ì¶œ\n            const stdout = execResult.stdout || '';\n            const jsonMatch = stdout.match(/JSON_RESULT_START(.+?)JSON_RESULT_END/s);\n\n            if (jsonMatch && jsonMatch[1]) {\n                result = JSON.parse(jsonMatch[1]);\n            } else {\n                throw new Error('No valid JSON found in output');\n            }\n        } catch (parseError) {\n            logger.error('Failed to parse result:', parseError);\n            return {\n                content: [{\n                    type: 'text',\n                    text: `âŒ ê²°ê³¼ íŒŒì‹± ì‹¤íŒ¨\\n\\nì¶œë ¥:\\n${execResult.stdout}\\n\\nì—ëŸ¬:\\n${execResult.stderr}`\n                }]\n            };\n        }\n\n        // ê²°ê³¼ ì²˜ë¦¬\n        if (!result.success) {\n            logger.error('Flow project failed:', result.error);\n            return {\n                content: [{\n                    type: 'text',\n                    text: `âŒ í”„ë¡œì íŠ¸ ì „í™˜ ì‹¤íŒ¨: ${params.project_name}\\n\\nì—ëŸ¬: ${result.error}\\n\\n${result.details?.traceback ? '\\nìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\\n' + result.details.traceback : ''}`\n                }]\n            };\n        }\n\n        // ì„±ê³µ ì‘ë‹µ - ì‹¤ì œ ë°ì´í„°ë¥¼ í¬í•¨í•˜ì—¬ ë°˜í™˜\n        const successMessage = `âœ… í”„ë¡œì íŠ¸ ì „í™˜ ì„±ê³µ: ${result.project_name}`;\n        \n        // ì „ì²´ ê²°ê³¼ ë°ì´í„° êµ¬ì„±\n        const responseData = {\n            success: true,\n            project_name: result.project_name,\n            path: result.path || 'Unknown',\n            git_branch: result.git_branch || 'Unknown',\n            context: result.details?.context || {},\n            workflow_status: result.workflow_status || {},\n            message: successMessage\n        };\n\n        // Pythonì˜ flat êµ¬ì¡°ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •\n        const workflowInfo = result.workflow_status?.status === 'active' ?\n            `\\nğŸ“‹ í™œì„± ì›Œí¬í”Œë¡œìš°: ${result.workflow_status.plan_name || 'Unknown'}\\n` +\n            `   ì§„í–‰ë¥ : ${result.workflow_status.completed_tasks || 0}/${result.workflow_status.total_tasks || 0}` :\n            '\\nâš ï¸ í™œì„± ì›Œí¬í”Œë¡œìš° ì—†ìŒ';\n\n        return {\n            content: [{\n                type: 'text',\n                text: successMessage + '\\n\\n' + \n                      `ğŸ“ ê²½ë¡œ: ${responseData.path}\\n` +\n                      `ğŸŒ¿ Git ë¸Œëœì¹˜: ${responseData.git_branch}` +\n                      workflowInfo\n            }, {\n                type: 'text',\n                text: '```json\\n' + JSON.stringify(responseData, null, 2) + '\\n```'\n            }]\n        };\n\n    } catch (error) {\n        logger.error('handleFlowProject error:', error);\n        return {\n            content: [{\n                type: 'text',\n                text: `âŒ í•¸ë“¤ëŸ¬ ì˜¤ë¥˜\\n\\n${error instanceof Error ? error.message : String(error)}`\n            }]\n        };\n    }\n}\n\n// ê¸°íƒ€ ì›Œí¬í”Œë¡œìš° ê´€ë ¨ í•¸ë“¤ëŸ¬ë“¤...\n"