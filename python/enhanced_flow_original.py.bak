

# WorkflowManager/Commands ì‹±ê¸€í„´ ì´ˆê¸°í™”
_workflow_mgr = None
_workflow_cmd = None

def get_workflow_commands():
    """WorkflowCommands ì‹±ê¸€í„´ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜"""
    global _workflow_mgr, _workflow_cmd
    if _workflow_cmd is None:
        try:
            from workflow import WorkflowManager, WorkflowCommands
            _workflow_mgr = WorkflowManager()
            _workflow_cmd = WorkflowCommands(_workflow_mgr)
        except ImportError as e:
            print(f"âš ï¸ WorkflowCommands ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            return None
    return _workflow_cmd



# WorkflowManager/Commands ì‹±ê¸€í„´ ì´ˆê¸°í™”
_workflow_mgr = None
_workflow_cmd = None

def get_workflow_commands():
    """WorkflowCommands ì‹±ê¸€í„´ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜"""
    global _workflow_mgr, _workflow_cmd
    if _workflow_cmd is None:
        try:
            from workflow import WorkflowManager, WorkflowCommands
            _workflow_mgr = WorkflowManager()
            _workflow_cmd = WorkflowCommands(_workflow_mgr)
        except ImportError as e:
            print(f"âš ï¸ WorkflowCommands ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            return None
    return _workflow_cmd

"""
í”„ë¡œì íŠ¸ ì „í™˜ ë° ê´€ë¦¬ ê¸°ëŠ¥
ìƒˆë¡œìš´ ContextManagerì™€ í†µí•©ë©ë‹ˆë‹¤.
"""
import os
import builtins
from pathlib import Path
from datetime import datetime, timedelta
import json
# ì ˆëŒ€ ì„í¬íŠ¸ ì‚¬ìš© (JSON REPLì—ì„œ ì‚¬ìš©ë¨)
from core.path_utils import get_project_root, get_cache_dir, get_file_directory_cache_path
from workflow_display import show_workflow_status_improved
from workflow_display import show_workflow_status_improved

def flow_project(name):
    """í”„ë¡œì íŠ¸ ì „í™˜ - cmd_flow_with_contextë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"""
    return cmd_flow_with_context(name)

def check_and_update_file_directory(project_name: str):
    """file_directory ìºì‹œë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    cache_path = get_file_directory_cache_path(project_name)
    needs_update = True
    if cache_path.exists():
        try:
            with open(cache_path, 'r', encoding='utf-8') as f:
                cache_data = json.load(f)
            generated_at = datetime.fromisoformat(cache_data.get('generated_at', ''))
            if datetime.now() - generated_at < timedelta(hours=24):
                needs_update = False
                print('  âœ“ file_directory ìºì‹œê°€ ìœ íš¨í•©ë‹ˆë‹¤.')
        except:
            pass
    if needs_update:
        print('  ğŸ”„ file_directory ì¬ìƒì„± ì¤‘...')
        generate_file_directory(project_name)

def generate_file_directory(project_name: str):
    """í”„ë¡œì íŠ¸ì˜ íŒŒì¼ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    project_root = get_project_root(project_name)
    ignore_patterns = {'.git', 'node_modules', '__pycache__', 'dist', 'build', '.venv', 'venv'}
    file_list = []
    for root, dirs, files in os.walk(project_root):
        dirs[:] = [d for d in dirs if d not in ignore_patterns]
        for file in files:
            rel_path = Path(root).relative_to(project_root) / file
            file_list.append(str(rel_path).replace('\\', '/'))
    cache_data = {'file_list': file_list, 'content': '\n'.join(file_list), 'generated_at': datetime.now().isoformat(), 'file_count': len(file_list), 'project_name': project_name}
    cache_path = get_file_directory_cache_path(project_name)
    with open(cache_path, 'w', encoding='utf-8') as f:
        json.dump(cache_data, f, indent=2, ensure_ascii=False)
    print(f'  âœ“ file_directory ìƒì„± ì™„ë£Œ ({len(file_list)}ê°œ íŒŒì¼)')

def show_workflow_status():
    """í˜„ì¬ ì›Œí¬í”Œë¡œìš° ìƒíƒœë¥¼ í‘œì‹œí•©ë‹ˆë‹¤."""
    try:
        if 'helpers' in builtins.__dict__:
            context_data = builtins.__dict__['helpers'].get_context()
            workflow_data = context_data.get('workflow_data', {})
        else:
            workflow_data = {}
        if not workflow_data:
            return
        if 'current_plan_id' in workflow_data and 'plans' in workflow_data:
            plan_id = workflow_data['current_plan_id']
            if plan_id and plan_id in workflow_data['plans']:
                plan = workflow_data['plans'][plan_id]
                print(f"\nğŸ“‹ í˜„ì¬ ê³„íš: {plan['name']}")
                if plan.get('tasks'):
                    current_task = next((t for t in plan['tasks'] if t['status'] != 'completed'), None)
                    if current_task:
                        print(f"   ğŸ¯ í˜„ì¬ ì‘ì—…: {current_task['title']}")
                        print(f"      ìƒíƒœ: {current_task['status']}")
    except Exception as e:
        print(f'âš ï¸ ì›Œí¬í”Œë¡œìš° ìƒíƒœ í‘œì‹œ ì¤‘ ì˜¤ë¥˜: {e}')

def cmd_flow_with_context(project_name):
    """í”„ë¡œì íŠ¸ ì „í™˜ ë° ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ì•ˆì •í™” ë²„ì „)"""
    import os
    import sys
    import json
    import builtins
    from pathlib import Path
    import subprocess
    from datetime import datetime
    
    # ğŸ”’ helpers ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤
    helpers = builtins.__dict__.get('helpers')
    if not helpers:
        print('âš ï¸ ê²½ê³ : helpers ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
        # ë…ë¦½ ì‹¤í–‰ í™˜ê²½ì„ ìœ„í•œ ìµœì†Œí•œì˜ ê¸°ëŠ¥ ì œê³µ
        try:
            # ê°€ëŠ¥í•˜ë©´ AIHelpersë¥¼ ì§ì ‘ ìƒì„±
            sys.path.insert(0, os.path.join(os.getcwd(), 'python'))
            from ai_helpers import AIHelpers
            helpers = AIHelpers()
            print("âœ… ì„ì‹œ helpers ê°ì²´ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")
        except ImportError as ie:
            print(f"âŒ helpers ìƒì„± ì‹¤íŒ¨: {ie}")
            # helpers ì—†ì´ë„ ê¸°ë³¸ ê¸°ëŠ¥ì€ ë™ì‘í•˜ë„ë¡ í•¨
            helpers = None
    print(f"\n{'=' * 50}")
    print(f'ğŸš€ í”„ë¡œì íŠ¸ ì „í™˜: {project_name}')
    print(f"{'=' * 50}\n")
    base_path = Path.home() / 'Desktop'
    project_path = base_path / project_name
    if not project_path.exists():
        print(f'âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: {project_path}')
        return {'success': False, 'error': 'Project directory not found'}
    try:
        # ğŸ”’ ì•ˆì „í•œ ì»¨í…ìŠ¤íŠ¸ ë°±ì—…
        if helpers and hasattr(helpers, 'get_context'):
            current_context = helpers.get_context()
            if current_context:
                current_project = current_context.get('project_name', 'unknown')
                if current_project and current_project != 'unknown' and (current_project != project_name):
                    backup_file = f"memory/context_backup_{current_project}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
                    os.makedirs('memory', exist_ok=True)
                    with open(backup_file, 'w', encoding='utf-8') as f:
                        json.dump(current_context, f, indent=2)
                    print(f'ğŸ’¾ ì´ì „ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ë°±ì—…: {backup_file}')
    except Exception as e:
        print(f'âš ï¸ ì»¨í…ìŠ¤íŠ¸ ë°±ì—… ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ê³„ì†): {e}')
    os.chdir(str(project_path))
    print(f'âœ… ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½: {os.getcwd()}')
    project_str = str(project_path)
    if project_str not in sys.path:
        sys.path.insert(0, project_str)
    context_file = project_path / 'memory' / 'context.json'
    if context_file.exists():
        try:
            with open(context_file, 'r', encoding='utf-8') as f:
                context_data = json.load(f)
            print(f'âœ… ê¸°ì¡´ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ')
        except Exception as e:
            print(f'âš ï¸ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨, ìƒˆë¡œ ìƒì„±: {e}')
            context_data = {}
    else:
        print('ğŸ“ ìƒˆ ì»¨í…ìŠ¤íŠ¸ ìƒì„±')
        context_data = {}
    context_data.update({'project_name': project_name, 'project_path': str(project_path), 'last_accessed': datetime.now().isoformat()})
    try:
        # ğŸ”’ ì•ˆì „í•œ ì»¨í…ìŠ¤íŠ¸ ì €ì¥
        if helpers and hasattr(helpers, 'get_context') and hasattr(helpers, 'save_context'):
            current = helpers.get_context()
            if current is not None:
                current.update(context_data)
                helpers.save_context()
                print(f'âœ… ì»¨í…ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ')
            else:
                print('âš ï¸ ì»¨í…ìŠ¤íŠ¸ê°€ Noneì…ë‹ˆë‹¤. ìƒˆë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.')
                # ì»¨í…ìŠ¤íŠ¸ ì§ì ‘ ì €ì¥
                os.makedirs('memory', exist_ok=True)
                with open('memory/context.json', 'w', encoding='utf-8') as f:
                    json.dump(context_data, f, indent=2)
                print('âœ… ì»¨í…ìŠ¤íŠ¸ ì§ì ‘ ì €ì¥ ì™„ë£Œ')
        else:
            # helpersê°€ ì—†ëŠ” ê²½ìš° ì§ì ‘ ì €ì¥
            print('âš ï¸ helpersë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ì§ì ‘ ì €ì¥í•©ë‹ˆë‹¤.')
            os.makedirs('memory', exist_ok=True)
            with open('memory/context.json', 'w', encoding='utf-8') as f:
                json.dump(context_data, f, indent=2)
            print('âœ… ì»¨í…ìŠ¤íŠ¸ ì§ì ‘ ì €ì¥ ì™„ë£Œ')
    except Exception as e:
        print(f'âš ï¸ ì»¨í…ìŠ¤íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜: {e}')
    files_to_load = [('ê³„íš', 'project_plan.md'), ('ì‘ì—…', 'current_tasks.md'), ('ë¸Œë¦¬í•‘', 'project_briefing.md'), ('ë¶„ì„', 'code_analysis.md')]
    loaded_files = {}
    for name, filename in files_to_load:
        file_path = project_path / filename
        if file_path.exists():
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    loaded_files[name] = f.read()
                print(f'âœ… {name} ë¡œë“œ: {filename}')
            except Exception as e:
                print(f'âš ï¸ {name} ë¡œë“œ ì‹¤íŒ¨: {e}')
    try:
        print('\nğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡° ì—…ë°ì´íŠ¸ ì¤‘...')
        subprocess.run([sys.executable, 'python/project_context_builder.py', '--update-file-directory'], cwd=str(project_path), capture_output=True, text=True)
        print('âœ… file_directory.md ì—…ë°ì´íŠ¸ ì™„ë£Œ')
    except Exception as e:
        print(f'âš ï¸ file_directory.md ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}')
    print(f"\n{'=' * 50}")
    print(f'ğŸ“‹ í”„ë¡œì íŠ¸ ë¸Œë¦¬í•‘: {project_name}')
    print(f"{'=' * 50}")
    if 'ê³„íš' in loaded_files:
        print(f"\nğŸ“Œ í”„ë¡œì íŠ¸ ê³„íš:\n{loaded_files['ê³„íš'][:500]}...")
    if 'ì‘ì—…' in loaded_files:
        print(f"\nğŸ“Œ í˜„ì¬ ì‘ì—…:\n{loaded_files['ì‘ì—…'][:300]}...")
    # Git ìƒíƒœ í™•ì¸ (git_manager ì‚¬ìš©)
    try:
        from git_version_manager import GitVersionManager
        git_mgr = GitVersionManager()
        git_status = git_mgr.git_status()
        
        if git_status.get('success'):
            modified_count = len(git_status.get('modified', []))
            print(f'\nğŸŒ¿ Git ìƒíƒœ: {modified_count}ê°œ íŒŒì¼ ë³€ê²½')
            
            if modified_count > 0:
                print('ë³€ê²½ëœ íŒŒì¼:')
                for file in git_status['modified'][:5]:
                    print(f'  {file}')
                if modified_count > 5:
                    print(f'  ... ì™¸ {modified_count - 5}ê°œ')
        else:
            # Git ì‚¬ìš© ë¶ˆê°€ ì‹œ ì¡°ìš©íˆ ë„˜ì–´ê°
            print('\nâ„¹ï¸ Git ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    except ImportError:
        # git_version_managerë¥¼ importí•  ìˆ˜ ì—†ëŠ” ê²½ìš°
        print('\nâ„¹ï¸ Git ë§¤ë‹ˆì €ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    except Exception as e:
        # ê¸°íƒ€ ì˜ˆì™¸ëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬
        print(f'\nâ„¹ï¸ Git ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
    print(f"\n{'=' * 50}")
    print(f'âœ… í”„ë¡œì íŠ¸ ì „í™˜ ì™„ë£Œ!')
    print(f"{'=' * 50}\n")
    show_workflow_status_improved()
    return {'success': True, 'project': project_name, 'path': str(project_path), 'context': context_data, 'loaded_files': list(loaded_files.keys())}

    """workflow.json ê¸°ë°˜ ì›Œí¬í”Œë¡œìš° ì§„í–‰ í˜„í™© í‘œì‹œ"""
    from pathlib import Path
    import json
    import textwrap
    
    wf_path = Path('memory/workflow.json')
    if not wf_path.exists():
        print('â„¹ï¸  ì›Œí¬í”Œë¡œìš°ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
        print('   ğŸ’¡ /plan ëª…ë ¹ìœ¼ë¡œ ìƒˆ ê³„íšì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
        return
        
    try:
        data = json.loads(wf_path.read_text(encoding='utf-8'))
        current_id = data.get('current_plan_id')
        
        if not current_id:
            print('â„¹ï¸  í™œì„± í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.')
            print('   ğŸ’¡ /plan ëª…ë ¹ìœ¼ë¡œ ìƒˆ ê³„íšì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
            return
            
        # plansëŠ” ë°°ì—´ì´ë¯€ë¡œ ì§ì ‘ íƒìƒ‰
        plan = next((p for p in data.get('plans', []) if p['id'] == current_id), None)
        if not plan:
            print('âš ï¸  í”Œëœ ì •ë³´ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.')
            return
            
        tasks = plan.get('tasks', [])
        done = sum(1 for t in tasks if t.get('status') == 'completed')
        
        # ì¶œë ¥
        bar = 'â”' * 50
        print(f"\n{bar}")
        print(f"ğŸ“‹ ì›Œí¬í”Œë¡œìš°: {plan['name']} ({done}/{len(tasks)} ì™„ë£Œ)")
        
        if plan.get('description'):
            print(f"ğŸ“ ì„¤ëª…: {textwrap.shorten(plan['description'], 70)}")
            
        if tasks:
            print("\nğŸ“Œ ì‘ì—… ëª©ë¡:")
            for i, t in enumerate(tasks, 1):
                status_icon = 'âœ…' if t.get('status') == 'completed' else 'ğŸ”§' if t.get('status') == 'in_progress' else 'â³'
                approval = ' (ìŠ¹ì¸ë¨)' if t.get('approval_status') == 'approved' else ''
                print(f"   {i}. {status_icon} {t['title']}{approval}")
                
        print(f"{bar}")
        print("ğŸ’¡ /statusë¡œ ìƒì„¸ ì •ë³´, /nextë¡œ ë‹¤ìŒ ì‘ì—… ì§„í–‰\n")
    except Exception as e:
        print(f'âš ï¸  ì›Œí¬í”Œë¡œìš° ìƒíƒœ í‘œì‹œ ì¤‘ ì˜¤ë¥˜: {e}')



def show_workflow_status_improved():
    """workflow.json ê¸°ë°˜ ì›Œí¬í”Œë¡œìš° ì§„í–‰ í˜„í™© í‘œì‹œ"""
    from pathlib import Path
    import json
    import textwrap
    
    wf_path = Path('memory/workflow.json')
    if not wf_path.exists():
        print('â„¹ï¸  ì›Œí¬í”Œë¡œìš°ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
        print('   ğŸ’¡ /plan ëª…ë ¹ìœ¼ë¡œ ìƒˆ ê³„íšì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
        return
        
    try:
        data = json.loads(wf_path.read_text(encoding='utf-8'))
        current_id = data.get('current_plan_id')
        
        if not current_id:
            print('â„¹ï¸  í™œì„± í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.')
            print('   ğŸ’¡ /plan ëª…ë ¹ìœ¼ë¡œ ìƒˆ ê³„íšì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
            return
            
        # plansëŠ” ë°°ì—´ì´ë¯€ë¡œ ì§ì ‘ íƒìƒ‰
        plan = next((p for p in data.get('plans', []) if p['id'] == current_id), None)
        if not plan:
            print('âš ï¸  í”Œëœ ì •ë³´ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.')
            return
            
        tasks = plan.get('tasks', [])
        done = sum(1 for t in tasks if t.get('status') == 'completed')
        
        # ì¶œë ¥
        bar = 'â”' * 50
        print(f"\n{bar}")
        print(f"ğŸ“‹ ì›Œí¬í”Œë¡œìš°: {plan['name']} ({done}/{len(tasks)} ì™„ë£Œ)")
        
        if plan.get('description'):
            print(f"ğŸ“ ì„¤ëª…: {textwrap.shorten(plan['description'], 70)}")
            
        if tasks:
            print("\nğŸ“Œ ì‘ì—… ëª©ë¡:")
            for i, t in enumerate(tasks, 1):
                status_icon = 'âœ…' if t.get('status') == 'completed' else 'ğŸ”§' if t.get('status') == 'in_progress' else 'â³'
                approval = ' (ìŠ¹ì¸ë¨)' if t.get('approval_status') == 'approved' else ''
                print(f"   {i}. {status_icon} {t['title']}{approval}")
                
        print(f"{bar}")
        print("ğŸ’¡ /statusë¡œ ìƒì„¸ ì •ë³´, /nextë¡œ ë‹¤ìŒ ì‘ì—… ì§„í–‰\n")
    except Exception as e:
        print(f'âš ï¸  ì›Œí¬í”Œë¡œìš° ìƒíƒœ í‘œì‹œ ì¤‘ ì˜¤ë¥˜: {e}')


def get_file_directory_structure(project_name: str=None):
    """íŒŒì¼ ë””ë ‰í† ë¦¬ êµ¬ì¡°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    if not project_name:
        project_name = Path.cwd().name
    cache_path = get_file_directory_cache_path(project_name)
    if cache_path.exists():
        try:
            with open(cache_path, 'r', encoding='utf-8') as f:
                cache_data = json.load(f)
            return cache_data.get('content', '')
        except:
            pass
    generate_file_directory(project_name)
    if cache_path.exists():
        with open(cache_path, 'r', encoding='utf-8') as f:
            cache_data = json.load(f)
        return cache_data.get('content', '')
    return ''

class EnhancedFlow:
    """ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±ì„ ìœ„í•œ ë˜í¼ í´ë˜ìŠ¤"""

    def __init__(self):
        pass

    def list_all_projects(self):
        """í”„ë¡œì íŠ¸ ëª©ë¡ ë°˜í™˜ (í˜¸í™˜ì„±)"""
        try:
            if 'helpers' in builtins.__dict__:
                ctx = builtins.__dict__['helpers'].get_context()
                project_name = ctx.get('project_name', Path.cwd().name)
                return [{'name': project_name, 'path': str(get_project_root(project_name)), 'active': True}]
        except:
            pass
        return []

    def cmd_flow_with_context(self, project_name: str):
        """í”„ë¡œì íŠ¸ ì „í™˜ (í˜¸í™˜ì„±)"""
        return flow_project(project_name)

    def get_file_directory_structure(self, project_name: str=None):
        """íŒŒì¼ ë””ë ‰í† ë¦¬ êµ¬ì¡° ë°˜í™˜ (í˜¸í™˜ì„±)"""
        return get_file_directory_structure(project_name)