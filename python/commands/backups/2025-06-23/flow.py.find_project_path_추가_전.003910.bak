#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
FLOW Command - AI Coding Brain MCP
/flow ëª…ë ¹ì–´ ì²˜ë¦¬


# Wisdom ì‹œìŠ¤í…œ í†µí•©
try:
    from ..project_wisdom import get_wisdom_manager
    from ..wisdom_hooks import get_wisdom_hooks
    WISDOM_AVAILABLE = True
except ImportError:
    WISDOM_AVAILABLE = False

ì‘ì„±ì¼: 2025-06-20
"""

import os
import json
import datetime as dt
from pathlib import Path
from typing import Dict, Any, Optional

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from core.context_manager import get_context_manager
from core.config import get_paths_from_config
from api.public import initialize_context
from core.project_summary import generate_project_context_summary

# ===========================================
# FLOW ëª…ë ¹ì–´
# ===========================================


def get_last_activity_time(context):
    """ìµœê·¼ ì‘ì—… ì‹œê°„ ê³„ì‚°"""
    work_tracking = context.get('work_tracking', {})
    if work_tracking and 'file_access' in work_tracking:
        last_times = []
        for file_data in work_tracking['file_access'].values():
            if file_data.get('last_read'):
                last_times.append(file_data['last_read'])
            if file_data.get('last_write'):
                last_times.append(file_data['last_write'])
        if last_times:
            return max(last_times)
    return None

def get_most_accessed_files(context, limit=5):
    """ê°€ì¥ ë§ì´ ì ‘ê·¼í•œ íŒŒì¼ ëª©ë¡"""
    work_tracking = context.get('work_tracking', {})
    if work_tracking and 'file_access' in work_tracking:
        file_access = work_tracking['file_access']
        sorted_files = sorted(
            file_access.items(),
            key=lambda x: x[1].get('read_count', 0) + x[1].get('write_count', 0),
            reverse=True
        )
        return [
            {
                'file': path,
                'read_count': data.get('read_count', 0),
                'write_count': data.get('write_count', 0)
            }
            for path, data in sorted_files[:limit]
        ]
    return []

def get_recent_edits(context, limit=5):
    """ìµœê·¼ ìˆ˜ì • ë‚´ì—­"""
    work_tracking = context.get('work_tracking', {})
    if work_tracking and 'function_edits' in work_tracking:
        edits = []
        for func_name, data in work_tracking['function_edits'].items():
            edits.append({
                'function': func_name,
                'file': data.get('file_path'),
                'last_edit': data.get('last_edit'),
                'edit_count': data.get('edit_count', 0)
            })
        # ìµœê·¼ ìˆ˜ì • ìˆœìœ¼ë¡œ ì •ë ¬
        edits.sort(key=lambda x: x.get('last_edit', ''), reverse=True)
        return edits[:limit]
    return []

def get_tasks_completed_today(tasks):
    """ì˜¤ëŠ˜ ì™„ë£Œëœ ì‘ì—… ìˆ˜"""
    if not tasks or 'done' not in tasks:
        return 0
    
    from datetime import datetime, date
    today = date.today()
    count = 0
    
    for task in tasks.get('done', []):
        if 'completed_at' in task:
            try:
                completed_date = datetime.fromisoformat(task['completed_at'].replace('Z', '+00:00')).date()
                if completed_date == today:
                    count += 1
            except:
                pass
    return count

def get_phase_progress(plan):
    """í˜„ì¬ Phaseì˜ ì§„í–‰ë¥ """
    if not plan or 'current_phase' not in plan:
        return None
    
    current_phase_id = plan['current_phase']
    phases = plan.get('phases', {})
    
    if current_phase_id in phases:
        phase = phases[current_phase_id]
        tasks = phase.get('tasks', [])
        if not tasks:
            return 0
        completed = sum(1 for task in tasks if task.get('status') == 'completed')
        return {
            'completed': completed,
            'total': len(tasks),
            'percentage': round(completed / len(tasks) * 100, 1)
        }
    return None



def cmd_flow(project_name: str = None, existing_context: Dict[str, Any] = None) -> Dict[str, Any]:
    """/flow ëª…ë ¹ì–´ - í”„ë¡œì íŠ¸ ì „í™˜"""
    
    # ë²„ì „ íŒ¨í„´ ì •ì˜ (í•¨ìˆ˜ ì´ˆë°˜ì— ì •ì˜)
    import re
    version_patterns = [
        r'^[a-zA-Z]+-\d+\.\d+\.\d+$',
        r'^app-\d+\.\d+\.\d+$',
        r'^project-\d+\.\d+\.\d+$',
        r'^v\d+\.\d+\.\d+$'
    ]
    
    # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ê°€ ë²„ì „ íŒ¨í„´ì¸ì§€ í™•ì¸
    current_dir_name = os.path.basename(os.getcwd())
    is_version_pattern = any(re.match(pattern, current_dir_name) for pattern in version_patterns)
    
    if is_version_pattern:
        print(f"âš ï¸ í˜„ì¬ ë””ë ‰í† ë¦¬ '{current_dir_name}'ëŠ” ë²„ì „ íŒ¨í„´ì…ë‹ˆë‹¤.")
        print("   MCP ì„œë²„ê°€ ì˜ëª»ëœ ìœ„ì¹˜ì—ì„œ ì‹¤í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤.")
        
        # configì—ì„œ ì‹¤ì œ í”„ë¡œì íŠ¸ ê²½ë¡œ ì°¾ê¸°
        from ..core.config import get_paths_from_config
        paths = get_paths_from_config()
        
        # project_nameì´ ì£¼ì–´ì§„ ê²½ìš°, í•´ë‹¹ í”„ë¡œì íŠ¸ ì°¾ê¸°
        if project_name:
            print(f"   í”„ë¡œì íŠ¸ '{project_name}'ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤...")
        else:
            print("   í”„ë¡œì íŠ¸ëª…ì„ ì§€ì •í•´ì£¼ì„¸ìš”.")
            return {"success": False, "message": "ë²„ì „ íŒ¨í„´ ë””ë ‰í† ë¦¬ì—ì„œëŠ” í”„ë¡œì íŠ¸ëª…ì„ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤"}
    else:
        # ê¸°ì¡´ ê²½ë¡œ ì„¤ì • ë¡œì§
        paths = get_paths_from_config()
    
    memory_root = str(paths['memory_root'])
    
    if not project_name:
        # í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ
        print("\nğŸ“‹ ë“±ë¡ëœ í”„ë¡œì íŠ¸ ëª©ë¡:")
        print("="*60)
        
        project_count = 0
        if os.path.exists(memory_root):
            import re
            version_patterns = [
                r'^[a-zA-Z]+-\d+\.\d+\.\d+$',
                r'^app-\d+\.\d+\.\d+$',
                r'^project-\d+\.\d+\.\d+$',
                r'^v\d+\.\d+\.\d+$'
            ]
            
            for item in sorted(os.listdir(memory_root)):
                is_version_pattern = any(re.match(pattern, item) for pattern in version_patterns)
                if is_version_pattern:
                    continue
                    
                item_path = os.path.join(memory_root, item)
                if os.path.isdir(item_path) and item != 'common':
                    # ìƒˆë¡œìš´ ìºì‹œ íŒŒì¼ ìœ„ì¹˜ í™•ì¸
                    cache_file = os.path.join(item_path, '.cache', 'cache_core.json')
                    if os.path.exists(cache_file):
                        try:
                            with open(cache_file, 'r', encoding='utf-8') as f:
                                cache_data = json.load(f)
                                actual_path = cache_data.get('project_path', 'Unknown')
                                last_accessed = cache_data.get('updated_at', 'Unknown')
                                
                                current_marker = " ğŸ”¥" if get_context_manager().project_name == item else ""
                                print(f"  â€¢ {item}{current_marker}")
                                print(f"    ğŸ“ ê²½ë¡œ: {actual_path}")
                                print(f"    ğŸ• ìµœê·¼ ì ‘ê·¼: {last_accessed[:10] if last_accessed != 'Unknown' else 'Unknown'}")
                                project_count += 1
                        except:
                            print(f"  â€¢ {item} (ìºì‹œ ì½ê¸° ì‹¤íŒ¨)")
        
        if project_count == 0:
            print("  ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            print(f"\nì´ {project_count}ê°œì˜ í”„ë¡œì íŠ¸")
            
        print("\nì‚¬ìš©ë²•: /flow [í”„ë¡œì íŠ¸ëª…]")
        return {
            'success': True,
            'message': 'í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ ì™„ë£Œ',
            'project_count': project_count,
            'action': 'list_projects'
        }
    
    # ì´ì „ ì»¨í…ìŠ¤íŠ¸ ì €ì¥
    if get_context_manager().context and get_context_manager().project_name:
        import re
        version_patterns = [
            r'^[a-zA-Z]+-\d+\.\d+\.\d+$',
            r'^app-\d+\.\d+\.\d+$',
            r'^project-\d+\.\d+\.\d+$',
            r'^v\d+\.\d+\.\d+$'
        ]
        is_version_pattern = any(re.match(pattern, get_context_manager().project_name) for pattern in version_patterns)
        
        if not is_version_pattern:
            prev_cache_dir = os.path.join(memory_root, get_context_manager().project_name, '.cache')
            if os.path.exists(prev_cache_dir):
                get_context_manager().save()
    
    # Memory í´ë”ì—ì„œ í”„ë¡œì íŠ¸ ìºì‹œ í™•ì¸
    project_cache_dir = os.path.join(memory_root, project_name, '.cache')
    cache_file = os.path.join(project_cache_dir, 'cache_core.json')
    
    project_path = None
    location = 'unknown'
    
    if os.path.exists(cache_file):
        # ìºì‹œì—ì„œ í”„ë¡œì íŠ¸ ê²½ë¡œ ì½ê¸°
        try:
            with open(cache_file, 'r', encoding='utf-8') as f:
                cache_data = json.load(f)
                cached_path = cache_data.get('project_path')
                
                if cached_path and os.path.exists(cached_path):
                    project_path = Path(cached_path)
                    location = 'cached'
                    print(f"\nâœ… Memoryì—ì„œ í”„ë¡œì íŠ¸ ì°¾ìŒ: {project_name}")
        except Exception as e:
            print(f"\nâš ï¸ ìºì‹œ ì½ê¸° ì‹¤íŒ¨: {e}")
    
    # ìºì‹œì— ì—†ê±°ë‚˜ ê²½ë¡œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ì°¾ê¸°
    if not project_path:
        desktop_path = paths['project_path'] / project_name
        if desktop_path.exists():
            project_path = desktop_path
            location = 'desktop'
        else:
            if os.path.basename(os.getcwd()) == project_name:
                project_path = Path(os.getcwd())
                location = 'current'
            else:
                if existing_context:
                    project_path = Path(os.getcwd())
                    location = 'current'
                else:
                    print(f"\nâŒ í”„ë¡œì íŠ¸ '{project_name}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                    return {
                        'success': False,
                        'message': f'í”„ë¡œì íŠ¸ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {project_name}',
                        'project_name': project_name
                    }
    
    # ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½
    directory_changed = False
    directory_error = None
    
    try:
        # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
        if not os.path.exists(str(project_path)):
            print(f"âš ï¸ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {project_path}")
            # ë””ë ‰í† ë¦¬ ìƒì„± ì‹œë„
            try:
                os.makedirs(str(project_path), exist_ok=True)
                print(f"âœ… í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±ë¨: {project_path}")
            except Exception as create_err:
                print(f"âŒ ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨: {create_err}")
                directory_error = str(create_err)
        
        # ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œë„
        os.chdir(str(project_path))
        current_dir = os.getcwd()
        if os.path.samefile(current_dir, str(project_path)):
            print(f"ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½ ì„±ê³µ: {project_path}")
            directory_changed = True
        else:
            print(f"âš ï¸ ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹¤íŒ¨: í˜„ì¬ {current_dir}")
            directory_error = "ë””ë ‰í† ë¦¬ ë³€ê²½ í›„ ê²½ë¡œ ë¶ˆì¼ì¹˜"
    except Exception as e:
        print(f"\nâš ï¸ ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹¤íŒ¨: {e}")
        directory_error = str(e)
        # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ìºì‹œëŠ” ì‚¬ìš© ê°€ëŠ¥)
    
    # ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    if 'context' in globals():
        globals()['context'].clear()
    
    context = initialize_context(
        project_path=str(project_path),
        project_name=project_name,
        memory_root=memory_root,
        existing_context=existing_context
    )
    
    print(f"\nâœ… í”„ë¡œì íŠ¸ '{project_name}'ë¡œ ì „í™˜ ì™„ë£Œ!")
    print(f"ğŸ“ ì‘ì—… ê²½ë¡œ: {project_path} ({location})")
    if directory_error:
        print(f"âš ï¸ ë””ë ‰í† ë¦¬ ê´€ë ¨ ê²½ê³ : {directory_error}")
    print(f"ğŸ’¾ ìºì‹œ ê²½ë¡œ: {memory_root}/{project_name}/.cache/")
    print(f"ğŸ“Š ìºì‹œ ë²„ì „: {context.get('version', 'unknown')}")
    print(f"ğŸ“ˆ ë¶„ì„ëœ íŒŒì¼: {len(context.get('analyzed_files', {}))}ê°œ")
    
    tasks = context.get('tasks', {})
    if isinstance(tasks, dict):
        next_count = len(tasks.get('next', []))
        done_count = len(tasks.get('done', []))
        print(f"ğŸ“‹ ë‚¨ì€ ì‘ì—…: {next_count}ê°œ")
        print(f"âœ… ì™„ë£Œëœ ì‘ì—…: {done_count}ê°œ")

    
    # í˜„ì¬ ê³„íš ì •ë³´ í‘œì‹œ
    plan = context.get('plan')
    if plan:
        print(f"\nğŸ“… í˜„ì¬ ê³„íš: {plan.get('name', 'N/A')}")
        current_task_id = context.get('current_task')
        if current_task_id:
            # í˜„ì¬ ì‘ì—… ì°¾ê¸°
            for phase_id, phase in plan.get('phases', {}).items():
                for task in phase.get('tasks', []):
                    if task.get('id') == current_task_id:
                        print(f"ğŸ¯ í˜„ì¬ ì‘ì—…: [{task['id']}] {task.get('title', 'N/A')}")
                        print(f"   ìƒíƒœ: {task.get('status', 'pending')}")
                        break
        
        # Phaseë³„ ì§„í–‰ ìƒí™©
        print("\nğŸ“Š Phaseë³„ ì§„í–‰ ìƒí™©:")
        for phase_id, phase in plan.get('phases', {}).items():
            tasks = phase.get('tasks', [])
            completed = sum(1 for t in tasks if t.get('status') == 'completed')
            in_progress = sum(1 for t in tasks if t.get('status') == 'in_progress')
            
            status_icon = "âœ…" if phase.get('status') == 'completed' else "ğŸ”„" if in_progress > 0 else "ğŸ“"
            print(f"   {status_icon} {phase.get('name', phase_id)}: {completed}/{len(tasks)} ì™„ë£Œ")

    # ê¸€ë¡œë²Œ context ì—…ë°ì´íŠ¸
    if 'context' in globals():
        globals()['context'].update(context)
    else:
        globals()['context'] = context
    
    
    # í´ë” êµ¬ì¡° ìë™ ìºì‹± (ìƒˆë¡œ ì¶”ê°€)
    try:
        # auto_tracking_wrapperì˜ cache_project_structure ì§ì ‘ í˜¸ì¶œ
        from auto_tracking_wrapper import cache_project_structure
        
        print("\nğŸ” í”„ë¡œì íŠ¸ êµ¬ì¡° ìºì‹± ì¤‘...")
        structure = cache_project_structure(str(project_path))
        if structure:
            print(f"âœ… í´ë” êµ¬ì¡° ìºì‹œ ì™„ë£Œ: {structure['total_files']}ê°œ íŒŒì¼, {structure['total_dirs']}ê°œ ë””ë ‰í† ë¦¬")
                
            # ì£¼ìš” ë””ë ‰í† ë¦¬ í‘œì‹œ
            if 'structure' in structure and '/' in structure['structure']:
                root = structure['structure']['/']
            if 'children' in root:
                dirs = [d for d in root['children'] if structure['structure'].get(f"/{d}", {}).get('type') == 'directory']
                files = root.get('files', [])
                        
                print("\nğŸ“ í”„ë¡œì íŠ¸ ì£¼ìš” êµ¬ì¡°:")
                print(f"   ë””ë ‰í† ë¦¬ ({len(dirs)}ê°œ):")
                for d in sorted(dirs)[:10]:  # ìƒìœ„ 10ê°œë§Œ
                    dir_info = structure['structure'].get(f"/{d}", {})
                    file_count = dir_info.get('file_count', 0)
                    print(f"      ğŸ“‚ {d}/ ({file_count}ê°œ íŒŒì¼)")
                if len(dirs) > 10:
                    print(f"      ... ì™¸ {len(dirs) - 10}ê°œ ë””ë ‰í† ë¦¬")
                        
                # ë£¨íŠ¸ì˜ ì£¼ìš” íŒŒì¼ë“¤
                important_files = [f for f in files if f.endswith(('.md', '.json', '.py', '.ts', '.js')) and not f.startswith('.')]
                if important_files:
                    print(f"\n   ì£¼ìš” íŒŒì¼ ({len(important_files)}ê°œ):")
                    for f in sorted(important_files)[:5]:
                        print(f"      ğŸ“„ {f}")
                    if len(important_files) > 5:
                        print(f"      ... ì™¸ {len(important_files) - 5}ê°œ íŒŒì¼")
    except Exception as e:
        import traceback
        print(f"âš ï¸ í´ë” êµ¬ì¡° ìºì‹± ì‹¤íŒ¨: {e}")
        print(f"ìƒì„¸ ì—ëŸ¬: {traceback.format_exc()}")
    

    # í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ í‘œì‹œ
    try:
        summary = generate_project_context_summary(context)
        print(summary)
    except Exception as e:
        print(f"\nâš ï¸ ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {e}")
    
    pending_count = len(tasks.get('next', [])) if isinstance(tasks, dict) else 0
    completed_count = len(tasks.get('done', [])) if isinstance(tasks, dict) else 0
    
    return {
        'success': True,
        'message': f'í”„ë¡œì íŠ¸ \'{project_name}\' ì „í™˜ ì™„ë£Œ',
        'project_name': project_name,
        'project_root': str(project_path),
        'directory_changed': directory_changed,
        'directory_error': directory_error,
        'cache_info': {
            'analyzed_files': len(context.get('analyzed_files', {})),
            'pending_tasks': pending_count,
            'completed_tasks': completed_count,
            'cache_version': context.get('version', 'unknown')
        },
'context': {
            'project_name': context.get('project_name'),
            'project_id': context.get('project_id'), 
            'project_path': context.get('project_path'),
            'memory_root': context.get('memory_root'),
            'created_at': context.get('created_at'),
            'updated_at': context.get('updated_at'),
            'version': context.get('version'),
            'current_focus': context.get('current_focus'),
            'current_task': context.get('current_task'),
            'progress': context.get('progress'),
            'current_phase': plan.get('current_phase') if plan else None,
            'error_log': context.get('error_log', [])[-5:],  # ìµœê·¼ 5ê°œë§Œ
            'metadata': context.get('metadata'),
            # ì¤‘ìš” ì •ë³´ ì¶”ê°€
            'analyzed_files': {
                path: {
                    'language': info.get('language'),
                    'functions': info.get('function_names', []),
                    'classes': info.get('class_names', []),
                    'last_analyzed': info.get('last_analyzed')
                }
                for path, info in context.get('analyzed_files', {}).items()
            },
            'recent_work': {
                'last_activity': get_last_activity_time(context),
                'most_accessed_files': get_most_accessed_files(context, 5),
                'recent_edits': get_recent_edits(context, 5)
            },
            'tasks': {
                'current': context.get('current_task'),
                'next': tasks.get('next', [])[:3] if tasks else [],  # ë‹¤ìŒ 3ê°œ ì‘ì—…
                'completed_today': get_tasks_completed_today(tasks)
            },
            'plan_summary': {
                'name': plan.get('name') if plan else None,
                'current_phase': plan.get('current_phase') if plan else None,
                'phase_progress': get_phase_progress(plan) if plan else None
            },
            'file_access_history': context.get('file_access_history', [])[-10:]  # ìµœê·¼ 10ê°œë§Œ
        }  # ê· í˜•ì¡íŒ context
    }
# ëª…ë ¹ì–´ ì²˜ë¦¬ í•¨ìˆ˜ë“¤ (cmd_plan, cmd_task, cmd_next)ì€ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ...


# ===========================================
# ë©”ì¸ ì§„ì…ì 
# ===========================================

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1:
        command = ' '.join(sys.argv[1:])
        # process_command(command)
    else:
        print("AI Coding Brain v7.0 (ìºì‹œ êµ¬ì¡° ê°œì„ )")
        print("ì‚¬ìš©ë²•: python claude_code_ai_brain.py [ëª…ë ¹ì–´]")
        print("ëª…ë ¹ì–´: /flow, /plan, /task, /next, /save")
