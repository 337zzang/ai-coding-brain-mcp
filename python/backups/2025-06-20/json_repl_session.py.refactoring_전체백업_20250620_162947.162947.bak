#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ğŸš€ JSON REPL Session for AI Coding Brain v5.0
==============================================

Claude Desktopê³¼ í†µì‹ í•˜ëŠ” ê°„ì†Œí™”ëœ JSON REPL ì„¸ì…˜
- claude_code_ai_brainê³¼ ì§ì ‘ í†µí•©
- ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³´í˜¸ (AIHelpers í´ë˜ìŠ¤)
- ìµœì†Œ ì˜ì¡´ì„±, í•µì‹¬ ê¸°ëŠ¥ë§Œ ìœ ì§€

ì‘ì„±ì¼: 2025-06-14
"""

import sys
import os
import json
import io
import traceback
import time
import datetime as dt
import platform
import subprocess
from pathlib import Path
from typing import Dict, Any, Optional
from contextlib import redirect_stdout, redirect_stderr

# ê¸°ë³¸ ê²½ë¡œ ì„¤ì •
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.insert(0, current_dir)

# ============================================================================
# ğŸ›¡ï¸ AIHelpers - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³´í˜¸ëœ í—¬í¼ í•¨ìˆ˜ ëª¨ìŒ
# ============================================================================

class AIHelpers:
    """AI Coding Brain í—¬í¼ í•¨ìˆ˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤"""
    
    def __init__(self):
        self._load_helpers()
        
    def _load_helpers(self):
        """í—¬í¼ í•¨ìˆ˜ë“¤ì„ ë¡œë“œ"""
        try:
            # Context ê´€ë¦¬ (claude_code_ai_brainì—ì„œ)
                        # TODO: claude_code_ai_brain_v7ë¡œ ì „í™˜ í•„ìš”
            from claude_code_ai_brain import (
                cmd_flow, initialize_context, save_context,
                update_cache, get_value,
                track_file_access, track_function_edit,
                get_work_tracking_summary, _context_manager,
                cmd_plan, cmd_task, cmd_next
            )
            
            self.cmd_flow = cmd_flow
            self.initialize_context = initialize_context
            self.save_context = save_context
            self.update_cache = update_cache
            self.get_value = get_value
            self.track_file_access = track_file_access
            self.track_function_edit = track_function_edit
            self.get_work_tracking_summary = get_work_tracking_summary
            self._context_manager = _context_manager
            self.cmd_plan = cmd_plan
            self.cmd_task = cmd_task
            self.cmd_next = cmd_next
            
        except ImportError as e:
            print(f"âš ï¸ claude_code_ai_brain ë¡œë“œ ì‹¤íŒ¨: {e}")
            self._context_manager = None
        
        try:
            # íŒŒì¼ ì‘ì—… ë° ì½”ë“œ ë¶„ì„ (auto_tracking_wrapperì—ì„œ)
            from auto_tracking_wrapper import (
                create_file, read_file, backup_file, restore_backup,
                replace_block, insert_block,
                parse_with_snippets, get_snippet_preview,
                scan_directory, search_files_advanced, search_code_content
            )
            
            # íŒŒì¼ ì‘ì—…
            self.create_file = create_file
            self.read_file = read_file
            self.backup_file = backup_file
            self.restore_backup = restore_backup
            
            # ì½”ë“œ ìˆ˜ì •
            self.replace_block = replace_block
            self.insert_block = insert_block
            
            # ì½”ë“œ ë¶„ì„
            self.parse_with_snippets = parse_with_snippets
            self.get_snippet_preview = get_snippet_preview
            
            # ê²€ìƒ‰

            self.scan_directory = scan_directory
            self.search_files_advanced = search_files_advanced
            self.search_code_content = search_code_content
        
        except ImportError as e:
            print(f"âš ï¸ auto_tracking_wrapper ë¡œë“œ ì‹¤íŒ¨: {e}")
    
    def get_context(self):
        """í˜„ì¬ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ë°˜í™˜"""
        if self._context_manager and self._context_manager.context:
            return self._context_manager.context
        return None
    
    def list_functions(self):
        """ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ ëª©ë¡ í‘œì‹œ"""
        funcs = [attr for attr in dir(self) 
                if not attr.startswith('_') and callable(getattr(self, attr))]
        print(f"ğŸ”§ ì‚¬ìš© ê°€ëŠ¥í•œ í—¬í¼ í•¨ìˆ˜ ({len(funcs)}ê°œ):")
        for func in sorted(funcs):
            print(f"  â€¢ helpers.{func}()")
        return funcs
    
    def __repr__(self):
        return "<AIHelpers: íŒŒì¼ì‘ì—…, ì½”ë“œë¶„ì„, ê²€ìƒ‰ ë“± í—¬í¼ í•¨ìˆ˜>"

# ============================================================================
# ğŸŒ ì „ì—­ ë³€ìˆ˜
# ============================================================================

repl_globals = {}
execution_count = 0
session_start = dt.datetime.now()

# ============================================================================
# ğŸš€ ì´ˆê¸°í™”
# ============================================================================

def initialize_repl():
    """REPL í™˜ê²½ ì´ˆê¸°í™”"""
    global repl_globals
    
    print("ğŸš€ JSON REPL Session v5.0 ì´ˆê¸°í™” ì¤‘...")
    
    # 1. helpers ê°ì²´ ìƒì„±
    helpers = AIHelpers()
    repl_globals['helpers'] = helpers
    repl_globals['h'] = helpers  # ì§§ì€ ë³„ì¹­
    
    # 2. ìì£¼ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ë“¤ì„ ì „ì—­ì—ë„ ë…¸ì¶œ (ì„ íƒì )
    critical_funcs = {
        'cmd_flow': helpers.cmd_flow,
        'save_context': helpers.save_context,
        'create_file': helpers.create_file,
        'read_file': helpers.read_file,
        'backup_file': helpers.backup_file,
        'replace_block': helpers.replace_block,
        'cmd_plan': helpers.cmd_plan,
        'cmd_task': helpers.cmd_task,
        'cmd_next': helpers.cmd_next
    }
    
    for name, func in critical_funcs.items():
        if callable(func):
            repl_globals[name] = func
    
    # 3. ê¸°ë³¸ ëª¨ë“ˆë“¤
    import numpy as np
    import pandas as pd
    
    repl_globals.update({
        'os': os,
        'sys': sys,
        'json': json,
        'Path': Path,
        'datetime': dt,
        'np': np,
        'pd': pd,
        'time': time,
    })
    
    # 4. context ì—°ê²°
    context = helpers.get_context()
    if context:
        repl_globals['context'] = context
    
    # 5. í”„ë¡œì íŠ¸ ìë™ ì´ˆê¸°í™” (í˜„ì¬ ë””ë ‰í† ë¦¬)
    try:
        project_path = os.getcwd()
        project_name = os.path.basename(project_path)
        if hasattr(helpers, 'initialize_context'):
            context = helpers.initialize_context(project_path, project_name)
            repl_globals['context'] = context
            print(f"âœ… í”„ë¡œì íŠ¸ '{project_name}' ìë™ ì´ˆê¸°í™”")
    except Exception as e:
        print(f"âš ï¸ í”„ë¡œì íŠ¸ ìë™ ì´ˆê¸°í™” ê±´ë„ˆëœ€: {e}")
    
    print("âœ… REPL ì´ˆê¸°í™” ì™„ë£Œ!")
    print("ğŸ’¡ ì‚¬ìš©ë²•: helpers.create_file('test.py') ë˜ëŠ” h.save_context()")
    print("ğŸ“‹ í•¨ìˆ˜ ëª©ë¡: helpers.list_functions()")

# ============================================================================
# ğŸ’» ì½”ë“œ ì‹¤í–‰
# ============================================================================

def execute_code(code: str) -> Dict[str, Any]:
    """Python ì½”ë“œ ì‹¤í–‰"""
    global execution_count
    
    stdout_capture = io.StringIO()
    stderr_capture = io.StringIO()
    start_time = time.time()
    
    try:
        with redirect_stdout(stdout_capture), redirect_stderr(stderr_capture):
            # ì½”ë“œ ì‹¤í–‰
            exec(code, repl_globals)
            
        execution_count += 1
        
        # ìë™ ì €ì¥ (10íšŒë§ˆë‹¤)
        if execution_count % 10 == 0 and 'save_context' in repl_globals:
            try:
                repl_globals['save_context']()
            except:
                pass
        
        # ë³€ìˆ˜ ê°œìˆ˜ ê³„ì‚°
        user_vars = [k for k in repl_globals.keys() 
                    if not k.startswith('_') and k not in ['__builtins__']]
        
        return {
            "success": True,
            "stdout": stdout_capture.getvalue(),
            "stderr": stderr_capture.getvalue(),
            "execution_time": time.time() - start_time,
            "variable_count": len(user_vars),
            "execution_count": execution_count,
            "session_mode": "JSON_REPL",
            "note": "JSON REPL Session - Variables persist"
        }
        
    except Exception as e:
        execution_count += 1
        
        return {
            "success": False,
            "stdout": stdout_capture.getvalue(),
            "stderr": stderr_capture.getvalue() + f"\n{type(e).__name__}: {str(e)}\n{traceback.format_exc()}",
            "execution_time": time.time() - start_time,
            "variable_count": len(repl_globals),
            "execution_count": execution_count,
            "error": str(e),
            "error_type": type(e).__name__,
            "session_mode": "JSON_REPL"
        }

# ============================================================================
# ğŸ”Œ JSON í†µì‹ 
# ============================================================================

def read_json_input() -> Optional[str]:
    """EOT ë¬¸ìë¡œ ì¢…ë£Œë˜ëŠ” JSON ì…ë ¥ ì½ê¸°"""
    try:
        input_data = ""
        while True:
            char = sys.stdin.read(1)
            if not char:  # EOF
                return None
            if char == '\x04':  # EOT
                break
            input_data += char
        
        return input_data.strip()
    except Exception:
        return None

def send_json_response(response: Dict[str, Any]):
    """JSON ì‘ë‹µ ì „ì†¡ (EOT ë¬¸ìë¡œ ì¢…ë£Œ)"""
    try:
        response['timestamp'] = dt.datetime.now().isoformat()
        response_json = json.dumps(response, ensure_ascii=False)
        sys.stdout.write(response_json)
        sys.stdout.write('\x04')  # EOT
        sys.stdout.flush()
    except Exception as e:
        error_response = {
            "success": False,
            "error": f"Response encoding error: {str(e)}",
            "error_type": "ResponseError"
        }
        sys.stdout.write(json.dumps(error_response))
        sys.stdout.write('\x04')
        sys.stdout.flush()

# ============================================================================
# ğŸ”„ ë©”ì¸ ë£¨í”„
# ============================================================================

def main():
    """ë©”ì¸ ì‹¤í–‰ ë£¨í”„"""
    # Windows UTF-8 ì„¤ì •
    if platform.system() == 'Windows':
        try:
            subprocess.run(['chcp', '65001'], shell=True, capture_output=True)
        except:
            pass
    
    # ìŠ¤íŠ¸ë¦¼ ì¸ì½”ë”© ì„¤ì •
    if hasattr(sys.stdout, 'reconfigure'):
        # Python 3.7+ 
        sys.stdout.reconfigure(encoding='utf-8', errors='replace')
    else:
        # êµ¬ë²„ì „ Pythonì„ ìœ„í•œ ëŒ€ì²´ ë°©ë²•
        import codecs
        sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'replace')
    
    if hasattr(sys.stderr, 'reconfigure'):
        # Python 3.7+
        sys.stderr.reconfigure(encoding='utf-8', errors='replace')
    else:
        # êµ¬ë²„ì „ Pythonì„ ìœ„í•œ ëŒ€ì²´ ë°©ë²•
        import codecs
        sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'replace')
    
    # ì´ˆê¸°í™”
    initialize_repl()
    
    # ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸
    print("__READY__", flush=True)
    
    # ë©”ì¸ ë£¨í”„
    try:
        while True:
            # JSON ì…ë ¥ ì½ê¸°
            code_input = read_json_input()
            if code_input is None:
                break
            
            try:
                # ìš”ì²­ íŒŒì‹±
                request = json.loads(code_input)
                request_id = request.get('id')
                code = request.get('code', '')
                language = request.get('language', 'python')
                
                if language != 'python':
                    response = {
                        "success": False,
                        "error": f"Unsupported language: {language}",
                        "error_type": "LanguageError"
                    }
                else:
                    # ì½”ë“œ ì‹¤í–‰
                    response = execute_code(code)
                    response['language'] = language
                
                # ìš”ì²­ ID ìœ ì§€
                if request_id:
                    response['id'] = request_id
                    
            except json.JSONDecodeError as e:
                response = {
                    "success": False,
                    "error": f"Invalid JSON: {str(e)}",
                    "error_type": "JSONDecodeError"
                }
            
            # ì‘ë‹µ ì „ì†¡
            send_json_response(response)
    
    except KeyboardInterrupt:
        print("\nğŸ‘‹ JSON REPL Session ì¢…ë£Œ", file=sys.stderr)
    except Exception as e:
        print(f"\nâŒ ì¹˜ëª…ì  ì˜¤ë¥˜: {e}", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
    finally:
        # ì¢…ë£Œ ì‹œ ì»¨í…ìŠ¤íŠ¸ ì €ì¥
        try:
            if 'save_context' in repl_globals:
                repl_globals['save_context']()
                print("âœ… ìµœì¢… ì»¨í…ìŠ¤íŠ¸ ì €ì¥", file=sys.stderr)
        except:
            pass

# ============================================================================
# ğŸ¯ ì‹¤í–‰
# ============================================================================

if __name__ == "__main__":
    main()
