# ì›Œí¬í”Œë¡œìš° ë¶„ì„ 3

ì•„ë˜ ë‚´ìš©ì€ â€œí”„ë¡œì íŠ¸ë³„ ì™„ì „ ë…ë¦½í˜• ì›Œí¬í”Œë¡œìš° V2â€ë¥¼ ëª©í‘œë¡œ í•œ ì œì•ˆì„œì…ë‹ˆë‹¤.  
(ì˜ˆì‹œëŠ” Pythonìœ¼ë¡œ ì‘ì„±ëœ í˜„ì¬ ì½”ë“œ ê¸°ë°˜ì„ ì „ì œë¡œ í•˜ì§€ë§Œ, NodeÂ·Go ë“± íƒ€ ìŠ¤íƒì—ì„œë„ ë™ì¼í•œ ì»¨ë²¤ì…˜ì„ ìœ ì§€í•  ìˆ˜ ìˆê²Œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1) .ai-brain í´ë” êµ¬ì¡° ìµœì í™”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ <project-root>/  
 â””â”€ ğŸ“ .ai-brain/              # ëª¨ë“  AI-ë©”íƒ€ë°ì´í„°ë¥¼ ì´ê³³ì— ê³ ì •  
     â”œâ”€ workflow.json          # ë‹¨ì¼ ë§ˆìŠ¤í„° íŒŒì¼(ì‘ì—…Â·íˆìŠ¤í† ë¦¬Â·ìºì‹œ í†µí•©)  
     â”œâ”€ history/               # â€˜ì•„ì¹´ì´ë¸Œâ€™ ìƒíƒœê°€ ëœ ì›Œí¬í”Œë¡œìš° ìŠ¤ëƒ…ìƒ·  
     â”‚    â””â”€ 2024-03-20T13-00-34.json  
     â”œâ”€ cache/                 # ìš©ëŸ‰ í° ì„ì‹œ ë°ì´í„° (LLM ë¶„ì„ ê²°ê³¼, ë²¡í„° ë“±)  
     â”‚    â”œâ”€ dir-scan.json  
     â”‚    â””â”€ embedding.bin  
     â”œâ”€ checkpoints/           # ë©”ì‹œì§€Â·ìƒíƒœ ì²´í¬í¬ì¸íŠ¸(ë¡¤ë°±ìš©)  
     â”‚    â””â”€ cp_00023.json  
     â”œâ”€ logs/                  # ë””ë²„ê·¸Â·ì—ëŸ¬ ë¡œê·¸  
     â””â”€ README.md              # í´ë” ì„¤ê³„ ì„¤ëª…ì„œ(ìë™ ìƒì„±)  

í•µì‹¬ ì•„ì´ë””ì–´  
â€¢ â€œë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(workflow.json) + ëª©ì ë³„ ì„¸ì»¨ë”ë¦¬ ì €ì¥ì†Œ(historyÂ·cacheÂ·checkpoints)â€ êµ¬ì¡°ë¡œ ë‹¨ìˆœí™”  
â€¢ íŒŒì¼/ì„œë¸Œí´ë” ì´ë¦„ì€ ê°€ê¸‰ì  OS í˜¸í™˜ Â· Git Friendly(ê³µë°±Â·í•œê¸€ ë¯¸ì‚¬ìš©)  
â€¢ .ai-brain í•˜ìœ„ë§Œ .gitignore => ì½”ë“œì™€ ë°ì´í„° ë¶„ë¦¬  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2) workflow.json ìŠ¤í‚¤ë§ˆ ì„¤ê³„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì „ì²´ë¥¼ í•˜ë‚˜ì˜ JSONì— ë„£ë˜ â‘ ëŸ°íƒ€ì„ ìƒíƒœ, â‘¡íˆìŠ¤í† ë¦¬ ë©”íƒ€, â‘¢ìºì‹œ/ì§€í‘œ ë¥¼ ëª…ì‹œì ìœ¼ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.

```jsonc
{
  "version": "2.1",
  /* â‘  ëŸ°íƒ€ì„ ìƒíƒœ (Stateless Serviceê°€ í•„ìš”í•  ìµœì†Œ ë°ì´í„°) */
  "session": {
    "status": "R",            // N=new, R=running, P=paused, D=done, X=cancelled
    "title": "Landing-page ë¦¬íŒ©í„°ë§",
    "started_at": "2024-03-20T12:58:03Z",
    "current_task": 3         // id ê°’, null ì´ë©´ ëŒ€ê¸°
  },

  /* â‘¡ íƒœìŠ¤í¬ ëª©ë¡ */
  "tasks": [
    {"id":1,"name":"CSS reset ë„ì…","tags":["style"],"done":true},
    {"id":2,"name":"Hero ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸í™”","tags":["react"],"done":true},
    {"id":3,"name":"ì ‘ê·¼ì„± ê°ì‚¬","tags":["a11y"],"done":false}
  ],

  /* â‘¢ íˆìŠ¤í† ë¦¬(ìš”ì•½ë³¸). ìŠ¤ëƒ…ìƒ· íŒŒì¼ì€ /history í´ë”ì— í’€ ë°±ì—… */
  "history": [
     {"at":"2024-02-01T11:22","title":"v1 ë°°í¬","done":true,"tasks":14},
     {"at":"2024-02-10T09:15","title":"ë‹¤êµ­ì–´í™”","done":true,"tasks":23}
  ],

  /* â‘£ ìºì‹œ/í†µê³„ (LLM ì˜ì‚¬ê²°ì •Â·UI í‘œì‹œìš©, ì‚­ì œí•´ë„ ë¬´ë°©) */
  "cache": {
    "dir_scan": { "total_files": 112, "scanned_at": "2024-03-20T12:00" },
    "embedding": { "vector_db": "sqlite", "updated": "2024-03-19T17:33" }
  }
}
```

ì„¤ê³„ ì›ì¹™  
â€¢ ìƒìœ„ ë ˆë²¨ í‚¤ë¥¼ `session / tasks / history / cache` ë„¤ êµ¬ì—­ìœ¼ë¡œ ê³ ì •  
â€¢ ë¯¸ë‹ˆë©ˆ í‚¤ ê¸¸ì´(ì¶•ì•½)ì™€ ê°€ë…ì„±ì˜ ê· í˜• â€“ ë‚´ë¶€ ì†ì„±ì€ 1~2 ê¸€ìë¡œ ì••ì¶• ê°€ëŠ¥í•˜ì§€ë§Œ ìƒìœ„ ë¸”ë¡ì€ ëª…ì‹œì ìœ¼ë¡œ ë‘”ë‹¤  
â€¢ ê° ë¸”ë¡ì€ ë…ë¦½ì ìœ¼ë¡œ TTL(Time-to-Live) ì •ì±… ì ìš©í•´ ìë™ ì •ë¦¬ ê°€ëŠ¥  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3) fp() í•¨ìˆ˜ì™€ wf() í•¨ìˆ˜ì˜ ìƒí˜¸ì‘ìš©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ fp()  âŸ¶  â€œí”„ë¡œì íŠ¸ ì „í™˜â€ ì±…ì„  
 â€‰1. ë°”íƒ•í™”ë©´ or ìš”ì²­ ê²½ë¡œì—ì„œ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ íƒìƒ‰  
 â€‰2. os.chdir() í›„ .ai-brain/workflow.json ë¡œë”© (ì—†ìœ¼ë©´ init)  
 â€‰3. GlobalContextManager.save_project_context() í˜¸ì¶œ  
 â€‰4. ë‚´ë¶€ì ìœ¼ë¡œ wf("/reload") ë¥¼ ìë™ í˜¸ì¶œí•´ ì›Œí¬í”Œë¡œìš° ë§¤ë‹ˆì €ì— ì„¸ì…˜ ë°”ì¸ë”©  

â€¢ wf()  âŸ¶  â€œí˜„ì¬ ì„¸ì…˜ ì¡°ì‘â€ ì±…ì„  
 â€‰â€“ task / start / done / status / report ë“± ëª¨ë“  ëª…ë ¹ì€ í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ .ai-brain/workflow.json ì„ ë‹¨ì¼ ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤ë¡œ ì‚¬ìš©  
 â€‰â€“ fp() ì—†ì´ wf() ë‹¨ë… í˜¸ì¶œ ì‹œ: í˜„ì¬ working dir ì— .ai-brain ì—†ìœ¼ë©´ ìë™ ìƒì„±í•˜ê³  ì´ˆê¸°í™”  

êµ¬í˜„ íŒ  
```python
def wf(cmd: str):
    session = WorkSession()          # ë‚´ë¶€ì ìœ¼ë¡œ get_workflow_path() ì‚¬ìš©
    return workflow_integrated(cmd, session=session)
```
ãƒ»WorkSession ê°ì²´ë¥¼ ì™¸ë¶€ì—ì„œ ì£¼ì… ê°€ëŠ¥í•˜ê²Œ í•´ í…ŒìŠ¤íŠ¸/REPL ìš©ì´  
ãƒ»fp() ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ë„ ë™ì¼ ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ë¯€ë¡œ ë ˆì´ìŠ¤ì»¨ë””ì…˜ ì—†ìŒ  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4) íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ë° ìºì‹œ ì „ëµ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(1) íˆìŠ¤í† ë¦¬ ë¡œí…Œì´ì…˜  
   â€¢ `session.status` ê°€ D(done) ë˜ëŠ” X(cancelled) ë¡œ ë°”ë€Œë©´  
     â€“ í˜„ì¬ workflow.json ì„ /history/YYYY-MM-DDThh-mm-ss.json ìœ¼ë¡œ ë³µì‚¬  
     â€“ workflow.json â†’ â€˜historyâ€™ ë°°ì—´ì— summary push  
     â€“ history í´ë”ëŠ” ìµœê·¼ 100ê°œë§Œ ë‚¨ê¸°ê³  ì‚­ì œ(ì„ íƒ)  

(2) ìºì‹œ TTL  
   â€¢ /cache í•˜ìœ„ ëª¨ë“  íŒŒì¼ì€ â€œë§ˆì§€ë§‰ ì‚¬ìš© ì‹œê°â€ ë©”íƒ€ë¥¼ íŒŒì¼ì¡´ì¬ ë˜ëŠ” side-car íŒŒì¼ì— ê¸°ë¡  
   â€¢ nì¼(ì˜ˆ: 14ì¼) ì´ìƒ ì ‘ê·¼ ì—†ìœ¼ë©´ ìë™ ì‚­ì œ â€“ ìºì‹œ ë¯¸ì¡´ì¬ì‹œ lazy rebuild  

(3) ì²´í¬í¬ì¸íŠ¸(ëŒ€ìš©ëŸ‰ ì •ì )  
   â€¢ /checkpoints ëŠ” ì›Œí¬í”Œë¡œìš° ì§„í–‰ ì¤‘ AI ëŒ€í™”Â·í”„ë¡¬í”„íŠ¸ ë“±ì„ full snapshot  
   â€¢ ë²ˆí˜¸Â·ë‚ ì§œ í˜¼í•© ë„¤ì´ë°(cp_00042.json) => ì •ë ¬ ìš©ì´  
   â€¢ Git ì»¤ë°‹ ì‹œì ì— ìë™ ì²­ì†Œ or ì™¸ë¶€ S3 ì—…ë¡œë“œ ì „ëµ ì„ íƒ ê°€ëŠ¥  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5) ê¸°ì¡´ workflow.json ë§ˆì´ê·¸ë ˆì´ì…˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ì¡´ íŒŒì¼ì€ ëŒ€ë¶€ë¶„ `tasks / history / usage_stats` ë“± ë¶€ë¶„ì ìœ¼ë¡œë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.  
ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œë‚˜ë¦¬ì˜¤(í•œ ë²ˆë§Œ ì‹¤í–‰):

```python
def migrate_legacy_workflow(project_root="."):
    old_path = Path(project_root) / "workflow.json"
    new_dir  = Path(project_root) / ".ai-brain"
    new_dir.mkdir(exist_ok=True)
    new_path = new_dir / "workflow.json"

    if not old_path.exists() or new_path.exists():
        return "âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶ˆí•„ìš” ë˜ëŠ” ì´ë¯¸ ì™„ë£Œ"

    with open(old_path, encoding="utf-8") as f:
        old = json.load(f)

    # 1) session
    session = {
        "status": "R",
        "title": old.get("description") or old.get("name") or "Untitled",
        "started_at": datetime.now().isoformat(),
        "current_task": None
    }

    # 2) tasks (ê°€ëŠ¥í•œ í‚¤ ë³€í™˜)
    raw_tasks = old.get("tasks") or []
    tasks = []
    for i, t in enumerate(raw_tasks, 1):
        tasks.append({
            "id": i,
            "name": t.get("name", f"task_{i}"),
            "tags": t.get("tags", []),
            "done": t.get("done", False)
        })

    # 3) history
    history = old.get("history", [])

    # 4) cache (usage_stats â†’ cache.stats ë¡œ ì´ê´€)
    cache = {
        "stats": old.get("usage_stats", {}),
        "migrated": True,
        "migrated_at": datetime.now().isoformat()
    }

    new_data = {
        "version": "2.1",
        "session": session,
        "tasks": tasks,
        "history": history,
        "cache": cache
    }

    with open(new_path, "w", encoding="utf-8") as f:
        json.dump(new_data, f, indent=2, ensure_ascii=False)

    # ë°±ì—… & ì•ˆë‚´
    old_path.rename(old_path.with_suffix(".json.bak"))
    print(f"âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ â†’ {new_path}")
    return "migration_done"
```

â€¢ fp() í˜¸ì¶œ ì‹œ, ì‹ ê·œ êµ¬ì¡°ê°€ ì—†ìœ¼ë©´ ìœ„ migrate í•¨ìˆ˜ê°€ **ìë™** ì‹¤í–‰ë˜ë„ë¡ Hook  
â€¢ .bak íŒŒì¼ì€ 30ì¼ í›„ ìë™ ì‚­ì œ(í¬ë¡  or ì²« ì‹¤í–‰ì‹œ check)  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ìš”ì•½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ .ai-brain ë””ë ‰í† ë¦¬ í•œ ê³³ì— â€œsession + history + cache + checkpointsâ€ë¥¼ ëª¨ì•„ **í”„ë¡œì íŠ¸ ì™„ì „ ë…ë¦½**ì„ ë‹¬ì„±  
â€¢ workflow.jsonì€ 4-ë¸”ë¡(session/tasks/history/cache) í‘œì¤€ ìŠ¤í‚¤ë§ˆë¡œ í†µì¼  
â€¢ fp() = í”„ë¡œì íŠ¸ ì „í™˜ í•µ / wf() = ì„¸ì…˜ ì•¡ì…˜ í•µ â†’ ì„œë¡œ ëŠìŠ¨í•˜ê²Œ ì—°ê²°  
â€¢ íˆìŠ¤í† ë¦¬ì™€ ìºì‹œëŠ” LRU + TTL ê¸°ë°˜ í´ë¦¬ë„ˆë¡œ ìë™ ìŠ¬ë¦¼í™”  
â€¢ ë ˆê±°ì‹œ íŒŒì¼ì€ ìµœì´ˆ ì „í™˜ ì‹œ ë¬´ì¤‘ë‹¨ ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ .bak ë³´ì¡´  

ì´ ì„¤ê³„ë¥¼ ì ìš©í•˜ë©´  
1) Git ë ˆí¬ì§€í† ë¦¬ì— ì½”ë“œë§Œ ë‚¨ê³  AI-ë©”íƒ€ëŠ” íˆ¬ëª…í•˜ê²Œ ê²©ë¦¬ë˜ë©°  
2) ë©€í‹° í”„ë¡œì íŠ¸Â·ë©€í‹° ì„¸ì…˜ì„ ì¶©ëŒ ì—†ì´ ë‹¤ë£° ìˆ˜ ìˆê³   
3) ê¸°ì¡´ ì‚¬ìš©ìë„ ë³„ë‹¤ë¥¸ ìˆ˜ì‘ì—… ì—†ì´ V2ë¡œ ì—…ê·¸ë ˆì´ë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.