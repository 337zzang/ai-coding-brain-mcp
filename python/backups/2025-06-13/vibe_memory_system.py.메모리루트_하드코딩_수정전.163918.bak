#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ğŸ§  Vibe Memory System v3.0 - í†µí•© ë©”ëª¨ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ
============================================
4ê°œ ë¬¸ì„œ ìë™ ê´€ë¦¬ ì‹œìŠ¤í…œ í†µí•© ë²„ì „

ì£¼ìš” ê¸°ëŠ¥:
1. ìºì‹œ ê´€ë¦¬ (.cache/cache_*.json)
2. ë©”ëª¨ë¦¬ë±…í¬ ë™ê¸°í™”
3. 4ê°œ í”„ë¡œì íŠ¸ ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸
   - coding_flow.md: í˜„ì¬ ì‘ì—… ìƒíƒœ
   - progress.md: ì§„í–‰ ìƒí™© (feature_roadmap.md ëŒ€ì²´)
   - project_vision.md: í”„ë¡œì íŠ¸ ì„¤ëª…
   - file_directory.md: íŒŒì¼ êµ¬ì¡°
"""

import os
import json
import shutil
from datetime import datetime
from typing import Dict, Any, Optional, List, Tuple, Callable


class VibeMemoryManager:
    """í†µí•© ë©”ëª¨ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ"""
    
    def __init__(self, context: Dict[str, Any], project_name: Optional[str] = None):
        """ì´ˆê¸°í™”
        
        Args:
            context: í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
            project_name: í”„ë¡œì íŠ¸ ì´ë¦„ (ê¸°ë³¸ê°’: contextì—ì„œ ì¶”ì¶œ)
        """
        self.context = context
        self.project_name = project_name or context.get('project_name', 'ai-coding-brain-mcp')
        
        # ê²½ë¡œ ì„¤ì •
        self.project_path = context.get('project_path', os.getcwd())
        self.memory_root = self._get_memory_root()
        self.memory_bank_dir = os.path.join(self.memory_root, self.project_name)
        
        # ë””ë ‰í† ë¦¬ ìƒì„±
        self._ensure_directories()
        
        # contextì— ê²½ë¡œ ì •ë³´ ì¶”ê°€
        context['memory_path'] = self.memory_bank_dir
        context['memory_bank'] = {
            'root': self.memory_root,
            'project': self.memory_bank_dir
        }
        
        print(f"âœ… VibeMemoryManager ì´ˆê¸°í™” ì™„ë£Œ: {self.project_name}")
    
    def _get_memory_root(self) -> str:
        """ë©”ëª¨ë¦¬ ë£¨íŠ¸ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°"""
        # Windows ê²½ë¡œ
        if os.name == 'nt':
            return r"C:\Users\Administrator\Desktop\memory"
        # Unix ê³„ì—´
        else:
            return os.path.expanduser("~/Desktop/memory")
    
    def _ensure_directories(self):
        """í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±"""
        os.makedirs(self.memory_bank_dir, exist_ok=True)
        os.makedirs(os.path.join(self.memory_bank_dir, '.cache'), exist_ok=True)
        os.makedirs(os.path.join(self.project_path, '.cache'), exist_ok=True)
    
    def save_context(self) -> bool:
        """ì»¨í…ìŠ¤íŠ¸ ì €ì¥ - ìºì‹œ + 4ê°œ ë¬¸ì„œ ëª¨ë‘ ì—…ë°ì´íŠ¸
        
        Returns:
            bool: ì„±ê³µ ì—¬ë¶€
        """
        try:
            print("\nğŸ’¾ ì»¨í…ìŠ¤íŠ¸ ì €ì¥ ì‹œì‘...")
            
            # 1. ìºì‹œ ì €ì¥
            cache_saved = self._save_cache()
            
            # 2. ë©”ëª¨ë¦¬ë±…í¬ ë™ê¸°í™”
            if cache_saved:
                sync_success = self._sync_to_memory_bank()
            else:
                sync_success = False
            
            # 3. 4ê°œ ë¬¸ì„œ ì—…ë°ì´íŠ¸
            docs_updated = self._update_all_docs()
            
            if cache_saved and sync_success and docs_updated:
                print("âœ… ì»¨í…ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ!")
                return True
            else:
                print("âš ï¸ ì¼ë¶€ ì €ì¥ ì‹¤íŒ¨")
                return False
                
        except Exception as e:
            print(f"âŒ save_context ì˜¤ë¥˜: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def _save_cache(self) -> bool:
        """ìºì‹œ íŒŒì¼ ì €ì¥"""
        try:
            # JSON ì§ë ¬í™” ê°€ëŠ¥í•œ ë°ì´í„°ë§Œ í•„í„°ë§
            serializable_context = self._prepare_serializable_context()
            
            # ë¡œì»¬ ìºì‹œ ì €ì¥
            cache_file = os.path.join(self.project_path, '.cache', f'cache_{self.project_name}.json')
            
            with open(cache_file, 'w', encoding='utf-8') as f:
                json.dump(serializable_context, f, indent=2, ensure_ascii=False)
            
            print(f"   âœ… ìºì‹œ ì €ì¥: {os.path.relpath(cache_file, self.project_path)}")
            return True
            
        except Exception as e:
            print(f"   âŒ ìºì‹œ ì €ì¥ ì‹¤íŒ¨: {e}")
            return False
    
    def _sync_to_memory_bank(self) -> bool:
        """ë©”ëª¨ë¦¬ë±…í¬ë¡œ ë™ê¸°í™”"""
        try:
            local_cache = os.path.join(self.project_path, '.cache', f'cache_{self.project_name}.json')
            memory_cache = os.path.join(self.memory_bank_dir, '.cache', f'cache_{self.project_name}.json')
            
            if os.path.exists(local_cache):
                shutil.copy2(local_cache, memory_cache)
                print(f"   âœ… ë©”ëª¨ë¦¬ë±…í¬ ë™ê¸°í™” ì™„ë£Œ")
                return True
            else:
                print(f"   âŒ ë¡œì»¬ ìºì‹œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {local_cache}")
                return False
            
        except Exception as e:
            print(f"   âŒ ë™ê¸°í™” ì‹¤íŒ¨: {e}")
            return False
    
    def _update_all_docs(self) -> bool:
        """4ê°œ ë¬¸ì„œ ëª¨ë‘ ì—…ë°ì´íŠ¸"""
        print("   ğŸ“„ í”„ë¡œì íŠ¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸...")
        
        results = [
            self._update_coding_flow(),
            self._update_progress(),
            self._update_project_vision(),
            self._update_file_directory()
        ]
        
        success_count = sum(results)
        print(f"   âœ… ë¬¸ì„œ ì—…ë°ì´íŠ¸: {success_count}/4ê°œ ì™„ë£Œ")
        
        return all(results)
    
    def _update_coding_flow(self) -> bool:
        """coding_flow.md - í˜„ì¬ ì‘ì—… ìƒíƒœ"""
        try:
            content = f"""# AI Coding Brain - í˜„ì¬ ì‘ì—…

## ğŸ¯ í˜„ì¬ Focus
{self.context.get('current_focus', 'Not set')}

## ğŸ”„ ì§„í–‰ ì¤‘ì¸ ì‘ì—…
"""
            # ì§„í–‰ ì¤‘ì¸ Phase ì‘ì—…ë“¤
            if 'phase_reports' in self.context:
                for phase_name, report in self.context['phase_reports'].items():
                    if 'end_time' not in report:  # ì§„í–‰ ì¤‘
                        content += f"\n### {phase_name}\n"
                        ops = report.get('operations', [])[-5:]  # ìµœê·¼ 5ê°œ
                        for op in ops:
                            status = "âœ…" if op['result'] == 'success' else "âŒ"
                            content += f"- {status} {op['operation']}\n"
            
            # ë‹¤ìŒ ì‘ì—…ë“¤
            content += "\n## ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„\n"
            next_tasks = self.context.get('tasks', {}).get('next', [])
            for i, task in enumerate(next_tasks[:5], 1):
                content += f"{i}. {task}\n"
            
            # ë©”ëª¨ ì„¹ì…˜
            content += "\n## ğŸ“ ë©”ëª¨\n"
            content += "- save_context() í˜¸ì¶œ ì‹œ 4ê°œ ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸\n"
            content += "- ë°±ì—… ì—†ì´ ì§ì ‘ ì €ì¥\n"
            
            content += f"\nìµœì¢… ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
            
            self._save_file('coding_flow.md', content)
            return True
            
        except Exception as e:
            print(f"     âŒ coding_flow.md ì‹¤íŒ¨: {e}")
            return False
    
    def _update_progress(self) -> bool:
        """progress.md - ì§„í–‰ ìƒí™©"""
        try:
            tasks = self.context.get('tasks', {})
            done_count = len(tasks.get('done', []))
            next_count = len(tasks.get('next', []))
            total_count = done_count + next_count
            progress = (done_count / total_count * 100) if total_count > 0 else 0
            
            content = f"""# AI Coding Brain - ì§„í–‰ ìƒí™©

## ğŸ“Š ì „ì²´ ì§„í–‰ë¥ 
- ì™„ë£Œ: {done_count}ê°œ
- ë‚¨ìŒ: {next_count}ê°œ
- ì§„í–‰ë¥ : {progress:.1f}%

## ğŸ¯ Phase ì§„í–‰ ìƒí™©
"""
            # Phaseë³„ ìƒì„¸ ì •ë³´
            if 'phase_reports' in self.context:
                for phase_name, report in self.context['phase_reports'].items():
                    content += f"\n### {phase_name}\n"
                    
                    if 'start_time' in report:
                        content += f"- ì‹œì‘: {report['start_time'].strftime('%Y-%m-%d %H:%M')}\n"
                    
                    if 'end_time' in report:
                        content += f"- ì¢…ë£Œ: {report['end_time'].strftime('%Y-%m-%d %H:%M')}\n"
                        content += f"- ì†Œìš”: {report.get('duration', 0):.1f}ì´ˆ\n"
                    else:
                        content += f"- ìƒíƒœ: ì§„í–‰ ì¤‘\n"
                    
                    content += f"- ì„±ê³µ: {len(report.get('successes', []))}ê°œ\n"
                    content += f"- ì‹¤íŒ¨: {len(report.get('errors', []))}ê°œ\n"
                    
                    # ë©”íŠ¸ë¦­ì´ ìˆìœ¼ë©´ í‘œì‹œ
                    if report.get('metrics'):
                        content += "- ì£¼ìš” ì„±ê³¼:\n"
                        for key, value in report['metrics'].items():
                            content += f"  â€¢ {key}: {value}\n"
            
            # ìµœê·¼ ì™„ë£Œ ì‘ì—…
            content += "\n## ğŸ“‹ ìµœê·¼ ì™„ë£Œ ì‘ì—…\n"
            for task in tasks.get('done', [])[-10:]:
                content += f"- âœ… {task}\n"
            
            # ì˜¤ë¥˜ í˜„í™©
            if 'error_log' in self.context:
                unresolved = [e for e in self.context['error_log'] if e.get('status') == 'unresolved']
                if unresolved:
                    content += f"\n## âš ï¸ ë¯¸í•´ê²° ì˜¤ë¥˜ ({len(unresolved)}ê°œ)\n"
                    for error in unresolved[-5:]:
                        content += f"- [{error['phase']}] {error['error_type']}: {error['error_message'][:50]}...\n"
            
            content += f"\nìµœì¢… ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
            
            self._save_file('progress.md', content)
            return True
            
        except Exception as e:
            print(f"     âŒ progress.md ì‹¤íŒ¨: {e}")
            return False
    
    def _update_project_vision(self) -> bool:
        """project_vision.md - í”„ë¡œì íŠ¸ ì„¤ëª…"""
        try:
            content = f"""# AI Coding Brain MCP - í”„ë¡œì íŠ¸ ë¹„ì „

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”
MCP (Model Context Protocol) ê¸°ë°˜ í†µí•© ê°œë°œ ì§€ì› ì‹œìŠ¤í…œ

## ğŸ“Š í˜„ì¬ ìƒíƒœ
- ë¶„ì„ëœ íŒŒì¼: {len(self.context.get('analyzed_files', {}))}ê°œ
- ì‹¬ë³¼ ì¸ë±ìŠ¤: {len(self.context.get('symbol_index', {}))}ê°œ
- ì™„ë£Œëœ ì‘ì—…: {len(self.context.get('tasks', {}).get('done', []))}ê°œ
- ì§„í–‰ ì¤‘ ì‘ì—…: {len(self.context.get('tasks', {}).get('next', []))}ê°œ

## ğŸ”§ í•µì‹¬ ê¸°ëŠ¥
1. **ìë™ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬**: ì‘ì—… ìƒíƒœ ìë™ ì €ì¥/ë³µì›
2. **í†µí•© ê²€ìƒ‰ ì‹œìŠ¤í…œ**: ì½”ë“œ, ë©”ëª¨ë¦¬, ìºì‹œ í†µí•© ê²€ìƒ‰
3. **Phase ê¸°ë°˜ ì‘ì—… ê´€ë¦¬**: ì²´ê³„ì ì¸ í”„ë¡œì íŠ¸ ì§„í–‰
4. **SimplEdit ì•ˆì „ ìˆ˜ì •**: ë°±ì—…ê³¼ í•¨ê»˜í•˜ëŠ” ì•ˆì „í•œ ì½”ë“œ ìˆ˜ì •

## ğŸ“¦ ì£¼ìš” ëª¨ë“ˆ
"""
            # ë¶„ì„ëœ ì£¼ìš” íŒŒì¼ë“¤
            analyzed = self.context.get('analyzed_files', {})
            for path, info in list(analyzed.items())[:10]:
                filename = os.path.basename(path)
                func_count = len(info.get('functions', []))
                class_count = len(info.get('classes', []))
                content += f"- **{filename}**: í•¨ìˆ˜ {func_count}ê°œ, í´ë˜ìŠ¤ {class_count}ê°œ\n"
            
            if len(analyzed) > 10:
                content += f"- ... ì™¸ {len(analyzed) - 10}ê°œ íŒŒì¼\n"
            
            # í†µê³„
            content += f"""
## ğŸ“ˆ í”„ë¡œì íŠ¸ í†µê³„
- ì „ì²´ Python íŒŒì¼: {len(self.context.get('project_files', {}).get('files', {}))}ê°œ
- ë¶„ì„ ì™„ë£Œìœ¨: {(len(analyzed) / max(1, len(self.context.get('project_files', {}).get('files', {})))) * 100:.1f}%
- ì „ì²´ í•¨ìˆ˜: {sum(len(info.get('functions', [])) for info in analyzed.values())}ê°œ
- ì „ì²´ í´ë˜ìŠ¤: {sum(len(info.get('classes', [])) for info in analyzed.values())}ê°œ
"""
            
            content += f"\nìµœì¢… ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
            
            self._save_file('project_vision.md', content)
            return True
            
        except Exception as e:
            print(f"     âŒ project_vision.md ì‹¤íŒ¨: {e}")
            return False
    
    def _update_file_directory(self) -> bool:
        """file_directory.md - íŒŒì¼ êµ¬ì¡°"""
        try:
            content = f"""# AI Coding Brain - í”„ë¡œì íŠ¸ êµ¬ì¡°

ìµœì¢… ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}

## ğŸ“ Python ëª¨ë“ˆ ëª©ë¡

| ê²½ë¡œ | ì„¤ëª… | ìˆ˜ì •ì¼ |
|------|------|--------|
"""
            if 'project_files' in self.context:
                files = self.context['project_files'].get('files', {})
                for file_path, info in sorted(files.items()):
                    content += f"| {file_path} | {info['description']} | {info['modified']} |\n"
            
            # í†µê³„
            total_files = len(self.context.get('project_files', {}).get('files', {}))
            analyzed_files = len(self.context.get('analyzed_files', {}))
            
            content += f"""

## ğŸ“Š í†µê³„
- Python íŒŒì¼: {total_files}ê°œ
- ë¶„ì„ ì™„ë£Œ: {analyzed_files}ê°œ
- ë¯¸ë¶„ì„: {total_files - analyzed_files}ê°œ

## ğŸ“Œ ì£¼ìš” ë””ë ‰í† ë¦¬
- `/python/` - í•µì‹¬ Python ëª¨ë“ˆë“¤
- `/src/` - TypeScript/JavaScript ì†ŒìŠ¤
- `/backups/` - ë°±ì—… íŒŒì¼ë“¤
- `/dist/` - ë¹Œë“œ ê²°ê³¼ë¬¼
- `/.cache/` - ìºì‹œ íŒŒì¼ë“¤
"""
            
            self._save_file('file_directory.md', content)
            return True
            
        except Exception as e:
            print(f"     âŒ file_directory.md ì‹¤íŒ¨: {e}")
            return False
    
    def _save_file(self, filename: str, content: str):
        """íŒŒì¼ ì €ì¥ (ë°±ì—… ì—†ì´)"""
        file_path = os.path.join(self.memory_bank_dir, filename)
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(content)
    
    def _prepare_serializable_context(self) -> Dict[str, Any]:
        """JSON ì§ë ¬í™” ê°€ëŠ¥í•œ context ì¤€ë¹„"""
        skip_keys = ['error_tracker', 'phase_reporter', 'change_tracker', 'flow_options']
        serializable = {}
        
        for key, value in self.context.items():
            if key in skip_keys:
                continue
            
            serializable[key] = self._convert_to_serializable(value)
        
        return serializable
    
    def _convert_to_serializable(self, obj: Any) -> Any:
        """ì¬ê·€ì ìœ¼ë¡œ ì§ë ¬í™” ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜"""
        if isinstance(obj, dict):
            return {k: self._convert_to_serializable(v) for k, v in obj.items()}
        elif isinstance(obj, list):
            return [self._convert_to_serializable(item) for item in obj]
        elif hasattr(obj, 'isoformat'):
            return obj.isoformat()
        elif isinstance(obj, (str, int, float, bool, type(None))):
            return obj
        else:
            return str(obj)
    
    def load_context(self) -> Dict[str, Any]:
        """ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ìºì‹œì—ì„œ)"""
        try:
            cache_file = os.path.join(self.project_path, '.cache', f'cache_{self.project_name}.json')
            
            if os.path.exists(cache_file):
                with open(cache_file, 'r', encoding='utf-8') as f:
                    loaded_context = json.load(f)
                
                # ê¸°ì¡´ context ì—…ë°ì´íŠ¸
                self.context.update(loaded_context)
                print(f"âœ… ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ ì™„ë£Œ: {len(loaded_context)} í•­ëª©")
                return loaded_context
            else:
                print(f"âš ï¸ ìºì‹œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {cache_file}")
                return {}
                
        except Exception as e:
            print(f"âŒ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return {}
    
    def get_project_status(self) -> Dict[str, Any]:
        """í”„ë¡œì íŠ¸ ìƒíƒœ ìš”ì•½"""
        tasks = self.context.get('tasks', {})
        done_count = len(tasks.get('done', []))
        next_count = len(tasks.get('next', []))
        total_count = done_count + next_count
        
        return {
            'project_name': self.project_name,
            'current_focus': self.context.get('current_focus', 'Not set'),
            'progress': (done_count / total_count * 100) if total_count > 0 else 0,
            'completed_tasks': done_count,
            'remaining_tasks': next_count,
            'analyzed_files': len(self.context.get('analyzed_files', {})),
            'total_symbols': len(self.context.get('symbol_index', {})),
            'unresolved_errors': len([e for e in self.context.get('error_log', []) if e.get('status') == 'unresolved'])
        }


# ì „ì—­ í•¨ìˆ˜ë“¤ (í˜¸í™˜ì„± ìœ ì§€)
def initialize_vibe_memory(context: Dict[str, Any], project_name: Optional[str] = None) -> VibeMemoryManager:
    """VibeMemoryManager ì´ˆê¸°í™”"""
    return VibeMemoryManager(context, project_name)


def create_save_context(context: Dict[str, Any]) -> Callable[[], bool]:
    """save_context í•¨ìˆ˜ ìƒì„±"""
    vibe_manager = VibeMemoryManager(context)
    
    def save_context():
        return vibe_manager.save_context()
    
    return save_context


# ë ˆê±°ì‹œ í•¨ìˆ˜ë“¤ (í˜¸í™˜ì„±)
def get_vibe_commands() -> List[str]:
    """ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡"""
    return [
        "/flow - í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸",
        "/task [ë‚´ìš©] - ìƒˆ ì‘ì—… ì¶”ê°€",
        "/done [ë²ˆí˜¸/ë‚´ìš©] - ì‘ì—… ì™„ë£Œ",
        "/focus [ë‚´ìš©] - í˜„ì¬ í¬ì»¤ìŠ¤ ì„¤ì •",
        "/save - ì»¨í…ìŠ¤íŠ¸ ì €ì¥"
    ]


def get_memory_bank_root() -> str:
    """ë©”ëª¨ë¦¬ë±…í¬ ë£¨íŠ¸ ê²½ë¡œ"""
    if os.name == 'nt':
        return r"C:\Users\Administrator\Desktop\memory"
    else:
        return os.path.expanduser("~/Desktop/memory")


# í…ŒìŠ¤íŠ¸ ì½”ë“œ
if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸ìš© context
    test_context = {
        'project_name': 'test-project',
        'project_path': os.getcwd(),
        'current_focus': 'í…ŒìŠ¤íŠ¸ ì‘ì—…',
        'tasks': {
            'done': ['ì‘ì—…1', 'ì‘ì—…2'],
            'next': ['ì‘ì—…3', 'ì‘ì—…4']
        }
    }
    
    # VibeMemoryManager í…ŒìŠ¤íŠ¸
    vibe = VibeMemoryManager(test_context)
    
    # ìƒíƒœ í™•ì¸
    status = vibe.get_project_status()
    print(f"\ní”„ë¡œì íŠ¸ ìƒíƒœ: {status}")
    
    # ì €ì¥ í…ŒìŠ¤íŠ¸
    vibe.save_context()
