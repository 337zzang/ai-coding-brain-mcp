import { ExecuteCodeHandler } from './execute-code-handler.js';

// ========== ì„¸ì…˜ ê³µìœ  MCP ë„êµ¬ í•¸ë“¤ëŸ¬ ==========

interface ToolResponse {
    content: Array<{
        type: string;
        text: string;
    }>;
}

// ê¸€ë¡œë²Œ ë³€ìˆ˜ ì €ì¥ì†Œ í‚¤
const GLOBAL_VARS_KEY = '__mcp_shared_vars__';

/**
 * ë³€ìˆ˜ ì €ì¥ ì½”ë“œ ìƒì„±
 */
function generateSaveVars(): string {
    return `
# ì‚¬ìš©ì ì •ì˜ ë³€ìˆ˜ ì €ì¥
_user_vars = {}
for k, v in list(globals().items()):
    if not k.startswith('_') and k not in ['helpers', 'context', 'os', 'sys', 'json', 'datetime']:
        try:
            # JSON ì§ë ¬í™” ê°€ëŠ¥í•œ ê²ƒë§Œ ì €ì¥
            import json
            json.dumps(v)
            _user_vars[k] = v
        except:
            pass
            
if _user_vars:
    helpers.update_cache('${GLOBAL_VARS_KEY}', _user_vars)
    print(f"ğŸ’¾ {len(_user_vars)}ê°œ ë³€ìˆ˜ ì €ì¥ë¨")
`;
}

/**
 * ë³€ìˆ˜ ë³µì› ì½”ë“œ ìƒì„±
 */
function generateLoadVars(): string {
    return `
# ì´ì „ ë³€ìˆ˜ ë³µì›
_saved_vars = helpers.get_value('${GLOBAL_VARS_KEY}', {})
if _saved_vars:
    for k, v in _saved_vars.items():
        globals()[k] = v
    print(f"â™»ï¸ {len(_saved_vars)}ê°œ ë³€ìˆ˜ ë³µì›ë¨")
`;
}

/**
 * ê°œì„ ëœ í”„ë¡œì íŠ¸ ì „í™˜ í•¸ë“¤ëŸ¬ (ë³€ìˆ˜ ìœ ì§€)
 */
export async function handleFlowProject(params: { project_name: string }): Promise<ToolResponse> {
    const code = `
${generateLoadVars()}

# í”„ë¡œì íŠ¸ ì „í™˜
result = helpers.cmd_flow("${params.project_name}")

# ì „ì—­ context ì—…ë°ì´íŠ¸
if result.get('success') and result.get('context'):
    context = result['context']
    print("\nâœ… ì „ì—­ context ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
    print(f"   - í”„ë¡œì íŠ¸: {context.get('project_name')}")
    plan_name = context.get('plan', {}).get('name') if isinstance(context.get('plan'), dict) else context.get('current_plan')
    print(f"   - ê³„íš: {plan_name}")
    print(f"   - í˜„ì¬ ì‘ì—…: {context.get('current_task', 'None')}")

${generateSaveVars()}
`;
    return ExecuteCodeHandler.handleExecuteCode({ code, language: 'python' });
}

/**
 * ê°œì„ ëœ ê³„íš ìˆ˜ë¦½ í•¸ë“¤ëŸ¬ (ë³€ìˆ˜ ìœ ì§€)
 */
export async function handlePlanProject(params: { plan_name?: string, description?: string }): Promise<ToolResponse> {
    const code = `
${generateLoadVars()}

# ê³„íš ìˆ˜ë¦½
result = helpers.cmd_plan(${params.plan_name ? `"${params.plan_name}"` : 'None'}, ${params.description ? `"${params.description}"` : 'None'})
print(result)

${generateSaveVars()}
`;
    return ExecuteCodeHandler.handleExecuteCode({ code, language: 'python' });
}

/**
 * ê°œì„ ëœ ì‘ì—… ê´€ë¦¬ í•¸ë“¤ëŸ¬ (ë³€ìˆ˜ ìœ ì§€)
 */
export async function handleTaskManage(params: { action: string, args?: string[] }): Promise<ToolResponse> {
    const argsStr = params.args ? params.args.map(arg => `"${arg}"`).join(', ') : '';
    const code = `
${generateLoadVars()}

# ì‘ì—… ê´€ë¦¬
helpers.cmd_task("${params.action}"${argsStr ? ', ' + argsStr : ''})

${generateSaveVars()}
`;
    return ExecuteCodeHandler.handleExecuteCode({ code, language: 'python' });
}

/**
 * ê°œì„ ëœ ë‹¤ìŒ ì‘ì—… í•¸ë“¤ëŸ¬ (ë³€ìˆ˜ ìœ ì§€)
 */
export async function handleNextTask(_params: {}): Promise<ToolResponse> {
    const code = `
${generateLoadVars()}

# ë‹¤ìŒ ì‘ì—… ì§„í–‰
helpers.cmd_next()

${generateSaveVars()}
`;
    return ExecuteCodeHandler.handleExecuteCode({ code, language: 'python' });
}

/**
 * ìƒˆë¡œìš´ ë„êµ¬: ë³€ìˆ˜ í™•ì¸
 */
