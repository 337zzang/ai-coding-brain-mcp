import sys

# Auto-tracking wrapper import
try:
    # ìë™ ì¶”ì  ë˜í¼ ìš°ì„  ì‚¬ìš©
    from auto_tracking_wrapper import *
    print("âœ… ìë™ ì¶”ì  ë˜í¼ ë¡œë“œ - ëª¨ë“  íŒŒì¼ ì‘ì—…ì´ ìë™ìœ¼ë¡œ ì¶”ì ë©ë‹ˆë‹¤")
except ImportError:
    # ë˜í¼ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ëª¨ë“ˆ ì‚¬ìš©
    print("âš ï¸ ìë™ ì¶”ì  ë˜í¼ ë¡œë“œ ì‹¤íŒ¨ - ì›ë³¸ ëª¨ë“ˆ ì‚¬ìš©")
    from file_system_helpers import *
    from ast_parser_helpers import *

"""
ğŸ¤– í´ë¡œë“œì½”ë“œ í†µí•© AI Brain ì‹œìŠ¤í…œ v1.1 - íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°
=======================================

í´ë¡œë“œì½”ë“œ execute_code í™˜ê²½ì„ ìœ„í•œ ì™„ì „ í†µí•© AI ë‘ë‡Œ ì‹œìŠ¤í…œ
- ìë™ ì„¸ì…˜ ë³µì›
- í”„ë¡œì íŠ¸ ê´€ë¦¬  
- ì§€ì‹ ë² ì´ìŠ¤
- ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ í†µí•©
-  logger ì´ˆê¸°í™” ë¬¸ì œ í•´ê²°
-  project_path ì´ˆê¸°í™” ë¬¸ì œ í•´ê²°

ì‘ì„±ì: Claude + ì‚¬ìš©ì í˜‘ì—…
ìƒì„±ì¼: 2025-06-04
ìˆ˜ì •ì¼: 2025-06-04 (íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°)
"""

import os
import json
import logging
import datetime as dt
from pathlib import Path
from typing import Union

# Vibe Memory System ë™ì  import (ìˆœí™˜ import ë°©ì§€)
try:
    import vibe_memory_system
except ImportError:
    vibe_memory_system = None



class SimpleLogger:
    """ê°„ë‹¨í•œ ë¡œê±° í´ë˜ìŠ¤ - ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½˜ì†”ì— ì¶œë ¥"""
    def info(self, msg): print(f"[INFO] {msg}")
    def warning(self, msg): print(f"[WARNING] {msg}")
    def error(self, msg): print(f"[ERROR] {msg}")
    def debug(self, msg): print(f"[DEBUG] {msg}")

class ClaudeCodeAIBrain:
    """
    í´ë¡œë“œì½”ë“œ í™˜ê²½ì„ ìœ„í•œ ì™„ì „ í†µí•© AI ë‘ë‡Œ ì‹œìŠ¤í…œ
    ìë™ ì„¸ì…˜ ë³µì› + í”„ë¡œì íŠ¸ ê´€ë¦¬ + ì§€ì‹ ë² ì´ìŠ¤ + ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ
    íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°: logger ë° project_path ì´ˆê¸°í™” ì™„ë£Œ
    """
    
    def __init__(self, project_path=None):
        """AI Brain ì´ˆê¸°í™” - logger ë° ê¸°ë³¸ ì†ì„± ì„¤ì •"""
        # ğŸ”§ ê¸°ë³¸ ì†ì„± ì´ˆê¸°í™”
        self.initialized = False
        self.project_context = None
        self.session_manager = None
        self.task_manager = None
        self.vibe_manager = None
        self.vibe_commands = None
        self.hierarchical_manager = None
        self.knowledge_manager = None
        self.memory_systems = {}
        
        # âœ… logger ì´ˆê¸°í™” (íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°)
        self.logger = self._setup_logger()
        
        # âœ… project_path ì´ˆê¸°í™” (íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°)
        if project_path:
            self.project_path = os.path.abspath(project_path)
        else:
            # ê¸°ë³¸ê°’: í˜„ì¬ íŒŒì¼ì˜ ë¶€ëª¨ ë””ë ‰í† ë¦¬
            self.project_path = os.path.dirname(os.path.abspath(__file__))
        
        self.logger.info(f"ClaudeCodeAIBrain ì´ˆê¸°í™” ì™„ë£Œ - í”„ë¡œì íŠ¸ ê²½ë¡œ: {self.project_path}")
        self.session_file_path = os.path.join(self.project_path, 'session_cache', 'latest_session.json')
        
    def _setup_logger(self):
        """ë¡œê±° ì„¤ì • - íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°"""
        try:
            logger = logging.getLogger('ClaudeCodeAIBrain')
            
            # ì´ë¯¸ ì„¤ì •ëœ ê²½ìš° ì¬ì‚¬ìš©
            if logger.handlers:
                return logger
                
            logger.setLevel(logging.INFO)
            
            # ì½˜ì†” í•¸ë“¤ëŸ¬ ì¶”ê°€
            console_handler = logging.StreamHandler()
            console_handler.setLevel(logging.INFO)
            
            # í¬ë§·í„° ì„¤ì •
            formatter = logging.Formatter(
                '[%(asctime)s] %(name)s - %(levelname)s: %(message)s',
                datefmt='%H:%M:%S'
            )
            console_handler.setFormatter(formatter)
            
            logger.addHandler(console_handler)
            
            return logger
            
        except Exception as e:
            # logger ì„¤ì • ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ì¶œë ¥ìœ¼ë¡œ ëŒ€ì²´
            print(f"Logger ì„¤ì • ì‹¤íŒ¨, ê¸°ë³¸ ì¶œë ¥ ëª¨ë“œ: {e}")
            
            # ê¸°ë³¸ logger ê°ì²´ ìƒì„± (info, error ë©”ì„œë“œ í¬í•¨)
            return SimpleLogger()


    def auto_initialize(self, project_path=None, force_reinit=False):
        """AI Brain ìë™ ì´ˆê¸°í™” - ê°•í™”ëœ ì˜¤ë¥˜ ì²˜ë¦¬"""
        try:
            self.logger.info("=== AI Brain ì´ˆê¸°í™” ì‹œì‘ ===")
            
            # project_path ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
            if project_path:
                self.project_path = os.path.abspath(project_path)
                self.logger.info(f"í”„ë¡œì íŠ¸ ê²½ë¡œ ì—…ë°ì´íŠ¸: {self.project_path}")
            
            # 1. ì´ì „ ì„¸ì…˜ ì •ë³´ í™•ì¸
            self.logger.info("1ë‹¨ê³„: ì´ì „ ì„¸ì…˜ ì •ë³´ í™•ì¸...")
            previous_session = self._check_previous_session()
            
            if previous_session and not force_reinit:
                self.logger.info(f"ì´ì „ ì„¸ì…˜ ë°œê²¬: {previous_session.get('session_id', 'unknown')}")
                
                # 1-1. ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦
                if self._validate_session(previous_session):
                    self.logger.info("ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦ í†µê³¼ - ë³µì› ì‹œì‘")
                    
                    # 1-2. ì„¸ì…˜ ìƒíƒœ ë³µì›
                    self._restore_session_state(previous_session)
                    
                    # 1-3. ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
                    self._initialize_basic_components()
                    
                    self.logger.info("ì´ì „ ì„¸ì…˜ ë³µì› ì™„ë£Œ")
                    self.initialized = True
                    return True
                else:
                    self.logger.warning("ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨ - ìƒˆ ì„¸ì…˜ ìƒì„±")
            
            # 2. ìƒˆ ì„¸ì…˜ ìƒì„±
            self.logger.info("2ë‹¨ê³„: ìƒˆ ì„¸ì…˜ ìƒì„±...")
            
            # 2-1. í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            self._initialize_project_context()
            
            # 2-2. ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
            self._initialize_basic_components()
            
            # 2-3. ì´ˆê¸° ì„¸ì…˜ ë°±ì—…
            self._create_initial_backup()
            
            self.logger.info("ìƒˆ ì„¸ì…˜ ìƒì„± ì™„ë£Œ")
            self.initialized = True
            return True
            
        except Exception as e:
            self.logger.error(f"AI Brain ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            
            # ìµœì†Œí•œì˜ ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œë¼ë„ ì´ˆê¸°í™”
            try:
                self._initialize_minimal_mode()
                self.logger.info("ìµœì†Œ ëª¨ë“œë¡œ ì´ˆê¸°í™” ì™„ë£Œ")
                self.initialized = True
                return True
            except Exception as minimal_error:
                self.logger.error(f"ìµœì†Œ ëª¨ë“œ ì´ˆê¸°í™”ë„ ì‹¤íŒ¨: {minimal_error}")
                return False

    def _check_previous_session(self):
        """ì´ì „ ì„¸ì…˜ ì •ë³´ í™•ì¸ - ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”"""
        try:
            # ì„¸ì…˜ íŒŒì¼ì—ì„œ í™•ì¸
            session_file = os.path.join(self.project_path, 'session_cache', 'latest_session.json')
            if os.path.exists(session_file):
                with open(session_file, 'r', encoding='utf-8') as f:
                    session_data = json.load(f)
                    return {
                        'session_id': session_data.get('session_id'),
                        'project_context': session_data.get('project_context'),
                        'timestamp': session_data.get('timestamp'),
                        'source': 'file'
                    }
            
            return None
            
        except Exception as e:
            self.logger.error(f"ì´ì „ ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨: {e}")
            return None

    def _validate_session(self, session_info):
        """ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦ - ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”"""
        try:
            # ì„¸ì…˜ ID í™•ì¸
            if not session_info.get('session_id'):
                return False
            
            # íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸ (24ì‹œê°„ ì´ë‚´)
            if session_info.get('timestamp'):
                from datetime import datetime, timedelta
                try:
                    last_time = datetime.fromisoformat(session_info['timestamp'])
                    if datetime.now() - last_time > timedelta(hours=24):
                        self.logger.warning("ì„¸ì…˜ì´ 24ì‹œê°„ ì´ìƒ ê²½ê³¼ë¨")
                        return False
                except Exception as time_error:
                    self.logger.warning(f"íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì‹¤íŒ¨: {time_error}")
            
            # project_context êµ¬ì¡° í™•ì¸
            project_context = session_info.get('project_context')
            if not isinstance(project_context, dict):
                self.logger.warning("project_contextê°€ ë”•ì…”ë„ˆë¦¬ê°€ ì•„ë‹˜")
                return False
            
            return True
            
        except Exception as e:
            self.logger.error(f"ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨: {e}")
            return False

    def _restore_session_state(self, session_info):
        """ì„¸ì…˜ ìƒíƒœ ë³µì› - ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”"""
        try:
            project_context = session_info.get('project_context', {})
            
            # ê¸°ë³¸ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ë³µì›
            self.project_context = {
                'session_id': session_info.get('session_id'),
                'name': project_context.get('name', 'ai-coding-brain-mcp'),
                'version': project_context.get('version', 'v1.1'),
                'restored_at': dt.datetime.now().isoformat(),
                'base_path': self.project_path,
                'analyzed_files': project_context.get('analyzed_files', {}),
                'backup_history': project_context.get('backup_history', []),
                'session_stats': project_context.get('session_stats', {})
            }
            
            self.logger.info("ì„¸ì…˜ ìƒíƒœ ë³µì› ì™„ë£Œ")
            
        except Exception as e:
            self.logger.error(f"ì„¸ì…˜ ìƒíƒœ ë³µì› ì‹¤íŒ¨: {e}")
            # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰

    def _initialize_project_context(self):
        """í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” - ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”"""
        try:
            import uuid
            import vibe_memory_system
            
            self.project_context = {
                'session_id': str(uuid.uuid4()),
                'name': 'ai-coding-brain-mcp',
                'version': 'v1.1',
                'created_at': dt.datetime.now().isoformat(),
                'base_path': self.project_path,
                'analyzed_files': {},
                'backup_history': [],
                'session_stats': {
                    'functions_executed': 0,
                    'files_analyzed': 0,
                    'errors_resolved': 0
                }
            }
            
            self.logger.info(f"í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ - ì„¸ì…˜ ID: {self.project_context['session_id']}")
            
        except Exception as e:
            self.logger.error(f"í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            # ìµœì†Œí•œì˜ ì»¨í…ìŠ¤íŠ¸ë¼ë„ ìƒì„±
            self.project_context = {'name': 'ai-coding-brain-mcp', 'base_path': self.project_path}

    def _initialize_basic_components(self):
        """ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” - ì˜¤ë¥˜ í—ˆìš©"""
        try:
            # ê¸°ë³¸ì ì¸ ê´€ë¦¬ìë“¤ë§Œ ì´ˆê¸°í™” (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            self.session_manager = {"status": "basic", "initialized": True}
            self.task_manager = {"status": "basic", "initialized": True}
            self.logger.info("ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ")
            
        except Exception as e:
            self.logger.warning(f"ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨ (ë¬´ì‹œ): {e}")

    def _create_initial_backup(self):
        """ì´ˆê¸° ì„¸ì…˜ ë°±ì—… ìƒì„± - ì˜¤ë¥˜ í—ˆìš©"""
        try:
            # ì„¸ì…˜ ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
            session_cache_dir = os.path.join(self.project_path, 'session_cache')
            os.makedirs(session_cache_dir, exist_ok=True)
            
            # ì„¸ì…˜ ë°±ì—… íŒŒì¼ ìƒì„±
            backup_data = {
                'session_id': self.project_context.get('session_id') if self.project_context else None,
                'timestamp': dt.datetime.now().isoformat(),
                'project_context': self.project_context,
                'status': 'initialized'
            }
            
            backup_file = os.path.join(session_cache_dir, 'latest_session.json')
            with open(backup_file, 'w', encoding='utf-8') as f:
                json.dump(backup_data, f, ensure_ascii=False, indent=2)
            
            self.logger.info(f"ì„¸ì…˜ ë°±ì—… ìƒì„± ì™„ë£Œ: {backup_file}")
            
        except Exception as e:
            self.logger.warning(f"ì„¸ì…˜ ë°±ì—… ìƒì„± ì‹¤íŒ¨ (ë¬´ì‹œ): {e}")

    def _initialize_minimal_mode(self):
        """ìµœì†Œ ëª¨ë“œ ì´ˆê¸°í™” - ë§ˆì§€ë§‰ ë°©ì–´ì„ """
        self.project_context = {
            'name': 'ai-coding-brain-mcp-minimal',
            'mode': 'minimal',
            'base_path': self.project_path,
            'initialized_at': dt.datetime.now().isoformat()
        }
        
        self.session_manager = {"status": "minimal"}
        self.task_manager = {"status": "minimal"}




class DummyAIBrain:
    """
    Fallback AI Brain - ClaudeCodeAIBrain ìƒì„± ì‹¤íŒ¨ì‹œ ì‚¬ìš©
    Pylance íƒ€ì… ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•œ ì •ì‹ í´ë˜ìŠ¤ ì •ì˜
    """
    
    def __init__(self, project_path: str = None):
        """ë”ë¯¸ AI Brain ì´ˆê¸°í™”"""
        self.initialized: bool = False
        self.project_context: dict = {
            'name': 'dummy', 
            'base_path': project_path or '.'
        }
        self.session_manager: dict = {'status': 'dummy'}
        self.task_manager: dict = {'status': 'dummy'}
        self.vibe_manager = None
        self.vibe_commands = None
        self.hierarchical_manager = None
        self.knowledge_manager = None
        self.memory_systems: dict = {}
        self.logger = SimpleLogger()
        self.project_path: str = project_path or '.'
    
    
    def save_session(self) -> bool:
        """ë”ë¯¸ ì„¸ì…˜ ì €ì¥ - í•­ìƒ True ë°˜í™˜"""
        return True
    
    def load_session(self, session_id: str = None) -> dict:
        """ë”ë¯¸ ì„¸ì…˜ ë¡œë“œ"""
        return {'status': 'dummy', 'session_id': session_id}


def create_ai_brain(project_path: str = None, restore_session: bool = None) -> Union[ClaudeCodeAIBrain, DummyAIBrain, None]:
    """
    AI Brain ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™” (2ê³„ì¸µ Context Manager í†µí•©)
    
    Args:
        project_path (str, optional): í”„ë¡œì íŠ¸ ê²½ë¡œ
        restore_session (bool, optional): ì„¸ì…˜ ë³µì› ì—¬ë¶€
    
    Returns:
        Union[ClaudeCodeAIBrain, DummyAIBrain, None]: AI Brain ì¸ìŠ¤í„´ìŠ¤
    """
    try:
        print("AI Brain (2ê³„ì¸µ Context Manager í†µí•©) ì‹œì‘...")
        
        # 1. Context Manager í•¨ìˆ˜ import ì‹œë„
        context_manager_available = False
        try:
            from context_manager import (
                initialize_context,  # 2ê³„ì¸µ êµ¬ì¡° ìƒì„±
                update_cache,        # ìºì‹œ ì—…ë°ì´íŠ¸
                build_index,         # ì¸ë±ìŠ¤ êµ¬ì¶•
                update_file_summary  # íŒŒì¼ ìš”ì•½ ì—…ë°ì´íŠ¸
            )
            context_manager_available = True
            print("âœ… Context Manager (2ê³„ì¸µ) ì‚¬ìš© ê°€ëŠ¥")
        except ImportError:
            print("âš ï¸ Context Managerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. ê¸°ë³¸ ëª¨ë“œë¡œ ì§„í–‰...")
        
        # 2. í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
        if not project_path:
            project_path = os.path.dirname(os.path.abspath(__file__))
        
        # 3. Context Managerë¥¼ ì‚¬ìš©í•œ project_context ì´ˆê¸°í™”
        if context_manager_available:
            # ê¸°ì¡´ project_context í™•ì¸
            if 'project_context' in globals():
                current_context = globals()['project_context']
                # 2ê³„ì¸µ êµ¬ì¡°ì¸ì§€ í™•ì¸
                if 'cache' in current_context and 'storage' in current_context:
                    print("âœ… ê¸°ì¡´ 2ê³„ì¸µ context ì‚¬ìš©")
                    update_cache(current_context, 'current_focus', 'AI Brain ì‹¤í–‰ ì¤‘')
                else:
                    # êµ¬í˜• 3ê³„ì¸µ êµ¬ì¡°ì¸ ê²½ìš° ìƒˆë¡œ ìƒì„±
                    print("âš ï¸ êµ¬í˜• 3ê³„ì¸µ context ë°œê²¬. 2ê³„ì¸µìœ¼ë¡œ ìƒˆë¡œ ìƒì„±...")
                    new_context = initialize_context(project_path=project_path)
                    globals()['project_context'] = new_context
            else:
                # ìƒˆ context ìƒì„±
                print("ìƒˆ 2ê³„ì¸µ context ìƒì„±...")
                new_context = initialize_context(project_path=project_path)
                globals()['project_context'] = new_context
            
            # ìºì‹œ ì—…ë°ì´íŠ¸
            if 'project_context' in globals():
                context = globals()['project_context']
                update_cache(context, 'current_focus', 'AI Brain ì‹¤í–‰ ì¤‘')
                update_cache(context, 'ai_brain_status', 'initializing')
        
        # 4. AI Brain ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        brain = ClaudeCodeAIBrain(project_path=project_path)
        
        # 5. ì´ˆê¸°í™” ì‹œë„
        force_reinit = restore_session is None
        success = brain.auto_initialize(project_path=project_path, force_reinit=force_reinit)
        
        if success:
            print("SUCCESS: ClaudeCodeAIBrain ì´ˆê¸°í™” ì„±ê³µ!")
            
            # Context Manager ì—°ë™ ìƒíƒœ í™•ì¸
            if context_manager_available and 'project_context' in globals():
                print("âœ… Context Manager (2ê³„ì¸µ) í†µí•© ì™„ë£Œ")
                update_cache(globals()['project_context'], 'ai_brain_status', 'active')
            
            return brain
        else:
            print("WARNING: ClaudeCodeAIBrain ì´ˆê¸°í™” ë¶€ë¶„ ì‹¤íŒ¨ - ê¸°ë³¸ ëª¨ë“œ")
            return brain  # ë¶€ë¶„ ì´ˆê¸°í™”ë¼ë„ ë°˜í™˜
            
    except Exception as e:
        print(f"ERROR: ClaudeCodeAIBrain ìƒì„± ì‹¤íŒ¨: {e}")
        
        # ìµœì¢… ë°©ì–´: ê¸°ë³¸ ë”ë¯¸ ê°ì²´ë¼ë„ ë°˜í™˜
        try:
            dummy_brain = DummyAIBrain(project_path=project_path)
            print("INFO: ë”ë¯¸ AI Brain ê°ì²´ ìƒì„±ë¨")
            return dummy_brain
        except:
            return None






# í´ë¡œë“œì½”ë“œ ìë™ ë¶€íŠ¸ìŠ¤íŠ¸ë© í•¨ìˆ˜
def claude_code_bootstrap():
    """execute_code ì²« ì‹¤í–‰ì‹œ ìë™ ë¶€íŠ¸ìŠ¤íŠ¸ë© - ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”"""
    print("INFO: í´ë¡œë“œì½”ë“œ AI Brain ë¶€íŠ¸ìŠ¤íŠ¸ë© ì‹œì‘...")
    
    # 1. project_context ì´ˆê¸°í™” ë˜ëŠ” ë³µì›
    if 'project_context' not in globals():
        globals()['project_context'] = {
            'name': 'ai-coding-brain-mcp',
            'version': 'v1.1', 
            'start_time': dt.datetime.now().isoformat(),
            'base_path': r'C:\Users\Administrator\Desktop\memory_coding\ai-coding-brain-mcp',
            'analyzed_files': {},
            'backup_history': [],
            'session_stats': {'functions_executed': 0, 'files_analyzed': 0}
        }
        print("SUCCESS: project_context ì´ˆê¸°í™” ì™„ë£Œ")

    # 2. ì´ì „ ì„¸ì…˜ ë³µì› ì‹œë„ (ì˜¤ë¥˜ í—ˆìš©)
    try:
        backup_path = os.path.join(globals()['project_context']['base_path'], 'session_backup.json')
        if os.path.exists(backup_path):
            with open(backup_path, 'r', encoding='utf-8') as f:
                backup_data = json.load(f)
            
            # ì¤‘ìš”í•œ ë°ì´í„°ë§Œ ë³µì›
            for key in ['analyzed_files', 'simple_tasks', 'hierarchical_tasks']:
                if key in backup_data.get('project_context', {}):
                    globals()['project_context'][key] = backup_data['project_context'][key]
            
            print(f"SUCCESS: ì´ì „ ì„¸ì…˜ ë³µì›ë¨: {backup_data.get('timestamp', 'unknown')}")
    except Exception as e:
        print(f"WARNING: ì´ì „ ì„¸ì…˜ ë³µì› ì‹¤íŒ¨ (ë¬´ì‹œ): {e}")

    print("COMPLETE: í´ë¡œë“œì½”ë“œ AI Brain ë¶€íŠ¸ìŠ¤íŠ¸ë© ì™„ë£Œ")


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    print("TEST: ClaudeCodeAIBrain í…ŒìŠ¤íŠ¸ ì‹œì‘...")
    brain = create_ai_brain()
    if brain and getattr(brain, 'initialized', False):
        print("SUCCESS: í…ŒìŠ¤íŠ¸ ì„±ê³µ!")
    else:
        print("WARNING: í…ŒìŠ¤íŠ¸ ë¶€ë¶„ ì„±ê³µ")


# === Vibe Memory System Complete Integration ===
def add_vibe_system_to_ai_brain(ai_brain_instance):
    """AI Brain ì¸ìŠ¤í„´ìŠ¤ì— Vibe Memory System ì¶”ê°€"""
    try:
        if not hasattr(ai_brain_instance, 'vibe_manager') or ai_brain_instance.vibe_manager is None:
            if vibe_memory_system is not None:
                ai_brain_instance.vibe_manager, ai_brain_instance.vibe_commands, vibe_success = vibe_memory_system.initialize_vibe_system(
                    ai_brain_instance.project_context,
                    getattr(ai_brain_instance, 'project_name', 'ai-coding-brain-mcp')
                )
            else:
                print("vibe_memory_system ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
                vibe_success = False
            
            if vibe_success:
                print("Vibe Memory System activated in AI Brain!")
                print("    Commands: /task, /flow, /done, /focus, help")
                
                # AI Brainì— vibe ëª…ë ¹ì–´ ì²˜ë¦¬ ë©”ì„œë“œ ì¶”ê°€
                def process_vibe_command(command_text):
                    if hasattr(ai_brain_instance, 'vibe_commands') and ai_brain_instance.vibe_commands:
                        return ai_brain_instance.vibe_commands.execute(command_text)
                    else:
                        return "Vibe system not initialized"
                
                ai_brain_instance.process_vibe_command = process_vibe_command
                return True
            else:
                print(" Vibe system initialization failed")
                return False
    except Exception as e:
        print(f"âŒ Vibe integration error: {e}")
        return False

def test_vibe_integration():
    """Vibe í†µí•© í…ŒìŠ¤íŠ¸"""
    print("testing Vibe Memory System Integration")
    print("="*50)
    
    try:
        # ê¸°ë³¸ project_context ìƒì„±
        test_context = {
            'name': 'ai-coding-brain-mcp',
            'analyzed_files': {},
            'backup_history': [],
            'modification_log': []
        }
        
        # vibe ì‹œìŠ¤í…œ ì§ì ‘ í…ŒìŠ¤íŠ¸
        if vibe_memory_system is not None:
            vibe_manager, vibe_commands, success = vibe_memory_system.initialize_vibe_system(test_context)
        else:
            print("vibe_memory_system ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
            success = False
        
        if success:
            print("Vibe system initialization: SUCCESS")
            
            # ëª…ë ¹ì–´ í…ŒìŠ¤íŠ¸
            test_commands = [
                '/task "Test vibe integration"',
                '/focus "Testing phase"',
                '/flow',
                'help'
            ]
            
            for cmd in test_commands:
                print(f"ğŸ”§ Testing command: {cmd}")
                result = vibe_commands.execute(cmd)
                print(f"   Result: {result[:100]}..." if len(result) > 100 else f"   Result: {result}")
            
            print("All vibe commands tested successfully!")
            return True
        else:
            print("Vibe system initialization failed")
            return False
            
    except Exception as e:
        print(f"Test error: {e}")
        return False

# ì¦‰ì‹œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
if __name__ == "__main__" or True:  # í•­ìƒ ì‹¤í–‰
    print("\n" + "="*70)
    print("VIBE MEMORY SYSTEM - CLAUDE AI BRAIN INTEGRATION COMPLETE")
    print("="*70)
    
    # ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test_result = test_vibe_integration()
    
    if test_result:
        print("\nğŸ‰ INTEGRATION SUCCESS!")
        print("   vibe_memory_system.py created")
        print("    claude_code_ai_brain.py integrated")
        print("   All vibe commands working")
        print("   Cache memory management active")
    else:
        print("\n Integration completed with warnings")


