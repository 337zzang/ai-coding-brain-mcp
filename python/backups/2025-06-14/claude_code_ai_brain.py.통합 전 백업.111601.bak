#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ğŸ§  AI Coding Brain - ê·¹ë‹¨ ê°„ì†Œí™” ë²„ì „ v5.0
==========================================

í•µì‹¬ ê¸°ëŠ¥ë§Œ:
- Claude Desktop ì„¤ì •ì—ì„œ ê²½ë¡œ ì½ê¸°
- /flow í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ì „í™˜
- ë©”ëª¨ë¦¬ ìš°ì„ , ì—†ìœ¼ë©´ í”„ë¡œì íŠ¸ ë£¨íŠ¸

ì‘ì„±ì¼: 2025-06-14
"""

import os
import json
import logging
from pathlib import Path
from typing import Dict, Any, Optional

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO, format='[%(levelname)s] %(message)s')
logger = logging.getLogger(__name__)

# Context Manager ì„í¬íŠ¸
try:
    from context_manager import initialize_context, save_context
    CONTEXT_MANAGER_AVAILABLE = True
    logger.info("âœ… Context Manager ë¡œë“œ ì™„ë£Œ")
except ImportError:
    CONTEXT_MANAGER_AVAILABLE = False
    logger.error("âŒ Context Manager ë¡œë“œ ì‹¤íŒ¨")

# ê¸€ë¡œë²Œ ìƒíƒœ
class GlobalState:
    def __init__(self):
        self.current_project = None
        self.project_path = None
        self.context = None

_global_state = GlobalState()

def get_paths_from_config() -> dict:
    """Claude Desktop ì„¤ì •ì—ì„œ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°"""
    config_path = os.path.expanduser("~/AppData/Roaming/Claude/claude_desktop_config.json")
    paths = {
        'project_root': Path.home() / "Desktop",
        'memory_root': Path.home() / "Desktop" / "memory"
    }
    
    if os.path.exists(config_path):
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                config = json.load(f)
            
            mcp_servers = config.get('mcpServers', {})
            for server_name, server_config in mcp_servers.items():
                if 'ai-coding-brain' in server_name.lower():
                    env = server_config.get('env', {})
                    if 'PROJECT_ROOT' in env:
                        paths['project_root'] = Path(env['PROJECT_ROOT'])
                    if 'MEMORY_BANK_ROOT' in env:
                        paths['memory_root'] = Path(env['MEMORY_BANK_ROOT'])
                    break
        except Exception as e:
            logger.error(f"ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: {e}")
    
    return paths

def cmd_flow(project_name: str = None) -> None:
    """/flow ëª…ë ¹ì–´ - í”„ë¡œì íŠ¸ ì „í™˜"""
    global _global_state
    
    if not project_name:
        # í˜„ì¬ ìƒíƒœ í‘œì‹œ
        if _global_state.current_project:
            print(f"\nğŸ”¥ í˜„ì¬ í”„ë¡œì íŠ¸: {_global_state.current_project}")
            print(f"ğŸ“ ê²½ë¡œ: {_global_state.project_path}")
        else:
            print("\nâš ï¸ í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            print("ì‚¬ìš©ë²•: /flow [í”„ë¡œì íŠ¸ëª…]")
        return
    
    # ì´ì „ ì»¨í…ìŠ¤íŠ¸ ì €ì¥
    if _global_state.context and CONTEXT_MANAGER_AVAILABLE:
        save_context()
    
    # ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
    paths = get_paths_from_config()
    
    # ë©”ëª¨ë¦¬ ë£¨íŠ¸ ìš°ì„  í™•ì¸
    project_path = paths['memory_root'] / project_name
    location = 'memory'
    
    if not project_path.exists():
        # í”„ë¡œì íŠ¸ ë£¨íŠ¸ í™•ì¸
        project_path = paths['project_root'] / project_name
        location = 'project'
        
        if not project_path.exists():
            print(f"\nâŒ í”„ë¡œì íŠ¸ '{project_name}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
            print(f"   â€¢ ë©”ëª¨ë¦¬: {paths['memory_root'] / project_name}")
            print(f"   â€¢ í”„ë¡œì íŠ¸: {paths['project_root'] / project_name}")
            return
    
    # í”„ë¡œì íŠ¸ ì „í™˜
    _global_state.current_project = project_name
    _global_state.project_path = str(project_path)
    
    os.chdir(project_path)
    
    # Context ì´ˆê¸°í™”
    if CONTEXT_MANAGER_AVAILABLE:
        _global_state.context = initialize_context(str(project_path), project_name)
        print(f"\nâœ… í”„ë¡œì íŠ¸ '{project_name}'ë¡œ ì „í™˜ ì™„ë£Œ!")
        print(f"ğŸ“ ê²½ë¡œ: {project_path} ({location}_root)")
    else:
        _global_state.context = None
        print(f"\nâš ï¸ Context Manager ì—†ì´ '{project_name}'ë¡œ ì „í™˜")

# ë©”ì¸ ì§„ì…ì 
def process_command(command: str, *args):
    """ëª…ë ¹ì–´ ì²˜ë¦¬"""
    if command == '/flow':
        return cmd_flow(args[0] if args else None)
    return f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: {command}"

# ì´ˆê¸°í™”
logger.info("ğŸ§  AI Coding Brain v5.0 (ê·¹ë‹¨ ê°„ì†Œí™”) ì¤€ë¹„ ì™„ë£Œ!")
