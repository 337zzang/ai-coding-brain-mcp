#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ğŸ§  AI Coding Brain - ê°„ì†Œí™” ë²„ì „ v4.0
=====================================

í•µì‹¬ ê¸°ëŠ¥ë§Œ í¬í•¨:
- Claude Desktop ì„¤ì •ì—ì„œ ê²½ë¡œ ì½ê¸°
- í”„ë¡œì íŠ¸ ì „í™˜ (/flow ëª…ë ¹ì–´)
- Context ì´ˆê¸°í™” ë° ìºì‹œ ì—…ë°ì´íŠ¸

ì‘ì„±ì¼: 2025-06-14
"""

import os
import json
import logging
from pathlib import Path
from typing import Dict, Any, Optional, List

# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.INFO,
    format='[%(levelname)s] %(message)s'
)
logger = logging.getLogger(__name__)

# Context Manager ì„í¬íŠ¸
try:
    from context_manager import (
        initialize_context,
        save_context,
        get_value
    )
    CONTEXT_MANAGER_AVAILABLE = True
    logger.info("âœ… Context Manager ë¡œë“œ ì™„ë£Œ")
except ImportError as e:
    CONTEXT_MANAGER_AVAILABLE = False
    logger.error(f"âŒ Context Manager ë¡œë“œ ì‹¤íŒ¨: {e}")

# ============================================
# ê¸€ë¡œë²Œ ìƒíƒœ ê´€ë¦¬
# ============================================
class GlobalState:
    """ê¸€ë¡œë²Œ ìƒíƒœ ê´€ë¦¬"""
    def __init__(self):
        self.current_project = None
        self.project_path = None
        self.context = None

_global_state = GlobalState()

# ============================================
# í•µì‹¬ í•¨ìˆ˜ë“¤
# ============================================

def get_paths_from_config() -> dict:
    """Claude Desktop ì„¤ì •ì—ì„œ PROJECT_ROOTì™€ MEMORY_BANK_ROOT ê°€ì ¸ì˜¤ê¸°"""
    config_path = os.path.expanduser("~/AppData/Roaming/Claude/claude_desktop_config.json")
    paths = {
        'project_root': Path.home() / "Desktop",  # ê¸°ë³¸ê°’
        'memory_root': Path.home() / "Desktop" / "memory"  # ê¸°ë³¸ê°’
    }
    
    if os.path.exists(config_path):
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                config = json.load(f)
            
            # ai-coding-brain MCP ì„œë²„ ì„¤ì •ì—ì„œ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            mcp_servers = config.get('mcpServers', {})
            for server_name, server_config in mcp_servers.items():
                if 'ai-coding-brain' in server_name.lower():
                    env = server_config.get('env', {})
                    
                    if 'PROJECT_ROOT' in env:
                        paths['project_root'] = Path(env['PROJECT_ROOT'])
                    if 'MEMORY_BANK_ROOT' in env:
                        paths['memory_root'] = Path(env['MEMORY_BANK_ROOT'])
                    break
        except Exception as e:
            logger.error(f"Claude Desktop ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: {e}")
    
    return paths

def list_available_projects() -> dict:
    """ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸ ëª©ë¡"""
    paths = get_paths_from_config()
    projects = {}
    
    # PROJECT_ROOTì˜ í”„ë¡œì íŠ¸ë“¤
    if paths['project_root'].exists():
        for item in paths['project_root'].iterdir():
            if item.is_dir() and not item.name.startswith('.'):
                projects[item.name] = {
                    'path': item,
                    'location': 'project_root'
                }
    
    # MEMORY_ROOTì˜ í”„ë¡œì íŠ¸ë“¤ (ìš°ì„ ìˆœìœ„ê°€ ë†’ìŒ)
    if paths['memory_root'].exists():
        for item in paths['memory_root'].iterdir():
            if item.is_dir() and not item.name.startswith('.'):
                projects[item.name] = {
                    'path': item,
                    'location': 'memory_root'
                }
    
    return projects

def switch_project(project_name: str) -> bool:
    """í”„ë¡œì íŠ¸ ì „í™˜"""
    global _global_state
    
    # ì´ì „ í”„ë¡œì íŠ¸ ì €ì¥
    if _global_state.context and CONTEXT_MANAGER_AVAILABLE:
        logger.info(f"ì´ì „ í”„ë¡œì íŠ¸ '{_global_state.current_project}' ì €ì¥ ì¤‘...")
        save_context()
    
    # í”„ë¡œì íŠ¸ ì°¾ê¸°
    projects = list_available_projects()
    
    if project_name not in projects:
        logger.error(f"í”„ë¡œì íŠ¸ '{project_name}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        return False
    
    project_info = projects[project_name]
    project_path = project_info['path']
    
    # ìƒíƒœ ì—…ë°ì´íŠ¸
    _global_state.current_project = project_name
    _global_state.project_path = str(project_path)
    
    # ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ê²½
    os.chdir(project_path)
    
    # Context ì´ˆê¸°í™”
    if CONTEXT_MANAGER_AVAILABLE:
        _global_state.context = initialize_context(str(project_path), project_name)
        logger.info(f"âœ… í”„ë¡œì íŠ¸ '{project_name}'ë¡œ ì „í™˜ ì™„ë£Œ ({project_info['location']})")
    else:
        logger.warning("Context Managerë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        _global_state.context = None
    
    return True

def initialize_ai_brain(project_name: str = None) -> Dict[str, Any]:
    """AI Brain ì´ˆê¸°í™”"""
    logger.info("ğŸš€ AI Brain ì´ˆê¸°í™”")
    
    if project_name:
        if switch_project(project_name):
            return _global_state.context
        else:
            logger.warning("í”„ë¡œì íŠ¸ ì „í™˜ ì‹¤íŒ¨")
    
    # ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸ í‘œì‹œ
    projects = list_available_projects()
    if projects:
        logger.info(f"ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸: {len(projects)}ê°œ")
        for name in list(projects.keys())[:5]:
            logger.info(f"   â€¢ {name}")
    
    return None

# ============================================
# ëª…ë ¹ì–´ ì²˜ë¦¬
# ============================================

def cmd_flow(args: List[str]) -> None:
    """/flow ëª…ë ¹ì–´ - í”„ë¡œì íŠ¸ ì „í™˜ ë° ìƒíƒœ í‘œì‹œ"""
    
    # í”„ë¡œì íŠ¸ ì „í™˜
    if args and len(args) > 0:
        project_name = args[0]
        print(f"\nğŸ”„ í”„ë¡œì íŠ¸ '{project_name}'ë¡œ ì „í™˜ ì¤‘...")
        
        if switch_project(project_name):
            print(f"âœ… í”„ë¡œì íŠ¸ '{project_name}'ë¡œ ì „í™˜ ì™„ë£Œ!")
            
            # ìƒíƒœ í‘œì‹œ
            if _global_state.context:
                analyzed = len(get_value(_global_state.context, 'analyzed_files', {}))
                print(f"\nğŸ“Š í”„ë¡œì íŠ¸ ìƒíƒœ:")
                print(f"   â€¢ ê²½ë¡œ: {_global_state.project_path}")
                print(f"   â€¢ ë¶„ì„ëœ íŒŒì¼: {analyzed}ê°œ")
        else:
            print(f"âŒ í”„ë¡œì íŠ¸ ì „í™˜ ì‹¤íŒ¨")
            show_available_projects()
        return
    
    # í˜„ì¬ ìƒíƒœ í‘œì‹œ
    if not _global_state.context:
        print("\nâš ï¸ í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
        print("\nì‚¬ìš©ë²•: /flow [í”„ë¡œì íŠ¸ëª…]")
        show_available_projects()
    else:
        print(f"\nğŸ”¥ í˜„ì¬ í”„ë¡œì íŠ¸: {_global_state.current_project}")
        print(f"ğŸ“ ê²½ë¡œ: {_global_state.project_path}")
        
        if CONTEXT_MANAGER_AVAILABLE:
            analyzed = len(get_value(_global_state.context, 'analyzed_files', {}))
            print(f"ğŸ“Š ë¶„ì„ëœ íŒŒì¼: {analyzed}ê°œ")

def show_available_projects():
    """ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ"""
    projects = list_available_projects()
    if projects:
        print("\nğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸:")
        print("-" * 60)
        
        # ìœ„ì¹˜ë³„ë¡œ ê·¸ë£¹í™”
        project_root_list = []
        memory_root_list = []
        
        for name, info in projects.items():
            if info['location'] == 'project_root':
                project_root_list.append(name)
            else:
                memory_root_list.append(name)
        
        paths = get_paths_from_config()
        
        if project_root_list:
            print(f"\nğŸ“ PROJECT_ROOT ({paths['project_root']}):")
            for name in sorted(project_root_list):
                print(f"   â€¢ {name}")
        
        if memory_root_list:
            print(f"\nğŸ’¾ MEMORY_ROOT ({paths['memory_root']}):")
            for name in sorted(memory_root_list):
                print(f"   â€¢ {name}")

# ============================================
# ë©”ì¸ ëª…ë ¹ì–´ ì²˜ë¦¬
# ============================================

def process_command(command: str, *args) -> Any:
    """ëª…ë ¹ì–´ ì²˜ë¦¬ (ê°„ì†Œí™”)"""
    if command == '/flow':
        return cmd_flow(list(args))
    else:
        return f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: {command}"

# ============================================
# ì´ˆê¸°í™” ë©”ì‹œì§€
# ============================================

logger.info("ğŸ§  AI Coding Brain v4.0 (ê°„ì†Œí™” ë²„ì „) ì¤€ë¹„ ì™„ë£Œ!")
logger.info("ğŸ’¡ ì‚¬ìš©ë²•: /flow [í”„ë¡œì íŠ¸ëª…]")
