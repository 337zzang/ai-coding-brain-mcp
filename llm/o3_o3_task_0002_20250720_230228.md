# o3 Analysis Result

## Task ID: o3_task_0002

### Question
Git 헬퍼 함수들의 반환값 구조를 분석하고 개선 방안을 제시해주세요.

특히 다음 사항에 중점을 두어 분석해주세요:
1. git_commit()이 반환해야 할 정보 (commit hash, message, author, date 등)
2. git_log()가 반환해야 할 commit 객체 구조
3. run_git_command()의 stdout 파싱 전략
4. 모든 함수의 일관된 반환값 패턴 (ok/err 패턴 유지)

각 함수별로 구체적인 반환값 예시와 함께 개선된 코드 구조를 제안해주세요.

### Context
Git 헬퍼 함수 분석 컨텍스트:

현재 문제점:
1. git_commit()이 문자열을 반환 (딕셔너리여야 함)
2. git_log()의 commit 객체에 'date' 키가 없음
3. run_git_command()가 raw stdout 문자열 반환
4. 반환값 구조가 일관되지 않음

발생한 오류들:
- TypeError: string indices must be integers (git_status 결과 처리)
- AttributeError: 'str' has no attribute 'get' (commit 결과 처리)
- KeyError: 'date' (git_log 결과 처리)

현재 git.py 파일 일부:
"""Git 작업 관련 함수들"""
import subprocess
import os
import platform
from typing import Dict, Any, List, Optional
from .util import ok, err

def find_git_executable() -> Optional[str]:
    """Git 실행 파일 찾기"""
    # Windows에서 직접 경로 확인
    if platform.system() == 'Windows':
        common_paths = [
            r"C:\Program Files\Git\bin\git.exe",
            r"C:\Program Files (x86)\Git\bin\git.exe",
            os.path.expanduser(r"~\AppData\Local\Programs\Git\bin\git.exe")
        ]

        for path in common_paths:
            if os.path.exists(path):
                return path

    # where 명령 시도
    try:
        result = subprocess.run(['where', 'git'], 
                              capture_output=True, 
                              text=True)
        if result.returncode == 0:
            return result.stdout.strip().split('\n')[0]
    except:
        pass

    # 기본값
    return 'git'

def run_git_command(args: List[str], cwd: Optional[str] = None) -> Dict[str, Any]:
    """Git 명령 실행"""
    try:
        git_exe = find_git_executable()
        cmd = [git_exe] + args

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=False,  # bytes로 받기
            cwd=cwd or os.getcwd()
        )

        # 출력 디코딩
        if result.returncode == 0:
            try:
                stdout = result.stdout.decode('utf-8')
            except UnicodeDecodeError:
                # Windows 한글 환경 대응
                stdout = result.stdout.decode('cp949', errors='replace')

            try:
                stderr = result.stderr.decode('utf-8') if result.stderr else ''
            except UnicodeDecodeError:
                stderr = result.stderr.decode('cp949', errors='replace') if result.stderr else ''

            return ok(stdout, stderr=stderr)
        else:
            try:
                stderr = result.stderr.decode('utf-8')
            except UnicodeDecodeError:
                stderr = result.stderr.decode('cp949', errors='replace')
 ...

목표:
- 일관된 반환값 구조 설계
- 각 함수가 반환해야 할 정보 정의
- 에러 처리 개선


### Answer
아래 제안은 “ok / err” 패턴은 그대로 두되,  
① run_git_command → “단순 실행 + 디코딩” 만 담당  
② git_* 계열 함수 → “stdout 파싱” 을 담당  
③ 최종적으로 **모든 헬퍼가 data 키에 구조화-객체를 담아 반환** 하도록 맞춘 설계입니다.

────────────────────────────────────────
1. ok / err 헬퍼 (util.py)
────────────────────────────────────────
def ok(data: Any = None,
       stdout: str = '',
       stderr: str = '',
       code: int = 0) -> Dict[str, Any]:
    return {
        'ok': True,
        'data': data,      # 구조화 데이터
        'stdout': stdout,  # 원본 문자열(필요 시 디버깅용)
        'stderr': stderr,
        'code': code
    }

def err(message: str,
        stdout: str = '',
        stderr: str = '',
        code: int = 1) -> Dict[str, Any]:
    return {
        'ok': False,
        'error': message,
        'stdout': stdout,
        'stderr': stderr,
        'code': code
    }

────────────────────────────────────────
2. run_git_command
────────────────────────────────────────
• 역할 : “git 실행 + 인코딩 처리”만 하고 **파싱은 하지 않는다**  
• 성공 시 stdout / stderr를 그대로 돌려주고, 호출자가 data를 채운다.

def run_git_command(args: List[str],
                    cwd: Optional[str] = None) -> Dict[str, Any]:
    git_exe = find_git_executable()
    result  = subprocess.run(
        [git_exe] + args,
        capture_output=True,
        text=False,
        cwd=cwd or os.getcwd()
    )

    # 디코딩
    def _decode(b: bytes) -> str:
        for enc in ('utf-8', 'cp949', 'latin1'):
            try:
                return b.decode(enc)
            except UnicodeDecodeError:
                pass
        return b.decode('utf-8', errors='replace')

    stdout = _decode(result.stdout or b'')
    stderr = _decode(result.stderr or b'')

    if result.returncode == 0:
        return ok(stdout=stdout, stderr=stderr, code=0)
    return err('git command failed',
               stdout=stdout,
               stderr=stderr,
               code=result.returncode)

────────────────────────────────────────
3. commit/로그 파싱용 유틸
────────────────────────────────────────
Git 포매터를 이용해 0x1f/0x1e 구분자를 쓰면 안전하게 필드 분리 가능.

_COMMIT_FORMAT = '%H%x1f%an%x1f%ae%x1f%ad%x1f%s%x1f%b%x1e'

def _parse_commit_block(block: str) -> Dict[str, str]:
    # block == "hash␟name␟email␟date␟subject␟body␞"
    parts = block.strip('\x1e').split('\x1f')
    return {
        'hash'   : parts[0],
        'author' : parts[1],
        'email'  : parts[2],
        'date'   : parts[3],        # RFC-2822 형식 (locale safe)
        'subject': parts[4],
        'body'   : parts[5] if len(parts) > 5 else ''
    }

────────────────────────────────────────
4. git_commit()
────────────────────────────────────────
• 커밋 실행 → 커밋 성공 시 방금 커밋의 메타정보를 git log -1로 가져와 파싱  
• data 키에 “commit 객체”를 넣어서 반환.

def git_commit(message: str,
               cwd: Optional[str] = None,
               additional_args: Optional[List[str]] = None
               ) -> Dict[str, Any]:
    args = ['commit', '-m', message] + (additional_args or [])
    res  = run_git_command(args, cwd)

    if not res['ok']:
        return res                 # 그대로 에러 전파

    # 방금 커밋 정보 확보
    log_res = git_log(n=1, cwd=cwd)
    if not log_res['ok']:
        # 커밋은 성공했는데 로그 파싱 실패한 드문 경우
        return err('commit done, but cannot parse commit info',
                   stdout=res['stdout'],
                   stderr=log_res['stderr'])

    return ok(data=log_res['data'][0],   # 첫 번째(최신) 커밋 객체
              stdout=res['stdout'],
              stderr=res['stderr'])

반환 예시:
{
  'ok': True,
  'data': {
      'hash'   : 'b6f761d',
      'author' : 'Alice',
      'email'  : 'alice@foo.com',
      'date'   : 'Fri, 23 Feb 2024 14:12:33 +0900',
      'subject': 'Fix login bug',
      'body'   : '…멀티라인 body…'
  },
  'stdout': '[master b6f761d] Fix login bug\n 3 files changed, …',
  'stderr': '',
  'code'  : 0
}

────────────────────────────────────────
5. git_log()
────────────────────────────────────────
def git_log(n: int = 10,
            cwd: Optional[str] = None,
            additional_args: Optional[List[str]] = None
           ) -> Dict[str, Any]:
    args = ['log', f'-n{n}',
            f'--pretty=format:{_COMMIT_FORMAT}'] + (additional_args or [])

    res  = run_git_command(args, cwd)
    if not res['ok']:
        return res

    raw = res['stdout']
    # 여러 커밋은 0x1e(레코드 구분자)로 끝남
    commits = []
    for block in raw.strip().split('\x1e'):
        if block.strip():
            commits.append(_parse_commit_block(block))

    return ok(data=commits,
              stdout=raw,
              stderr=res['stderr'])

반환 예시:
{
  'ok'  : True,
  'data': [
      { 'hash': 'b6f761d', 'author': 'Alice', …},
      { 'hash': 'a3c21f4', 'author': 'Bob'  , …},
      …
  ],
  'stdout': 'b6f76…',
  'stderr': '',
  'code'  : 0
}

────────────────────────────────────────
6. git_status() 등 다른 고수준 함수
────────────────────────────────────────
git_status()도 동일 패턴을 따르도록 변경.

def git_status(cwd: Optional[str] = None) -> Dict[str, Any]:
    res = run_git_command(['status', '--porcelain', '-b'], cwd)
    if not res['ok']:
        return res

    data = _parse_status(res['stdout'])   # 별도 구현
    return ok(data=data,
              stdout=res['stdout'],
              stderr=res['stderr'])

────────────────────────────────────────
7. 일관성 체크 리스트
────────────────────────────────────────
• 모든 공개 API는 Dict 반환  
  - 성공 : ok == True, data 키 존재  
  - 실패 : ok == False, error 키 존재  
• commit / log / status 모두 data에 “구조화 딕셔너리(또는 리스트)” 저장  
• run_git_command는 data 미사용 (파싱 책임 없음)  
• Git 출력(원본 문자열)은 stdout 키에 항상 넣어 디버깅 가능  
• date 필드는 git_log, git_commit 공통

이렇게 구성하면 기존 TypeError, AttributeError, KeyError 모두 사라지고, 모든 상위 모듈에서 동일한 방식(res['ok'] 및 res['data'])으로 안전하게 처리할 수 있습니다.

### Metadata
- Reasoning Effort: medium

- Start Time: 2025-07-20 23:01:33.689005
- End Time: 2025-07-20 23:02:13.449023
- Duration: 39.8초

### Token Usage
- Prompt Tokens: 747
- Completion Tokens: 2,292
- Reasoning Tokens: 0
- Total Tokens: 3,039
