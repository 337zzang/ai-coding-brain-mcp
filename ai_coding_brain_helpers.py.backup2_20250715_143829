# AI Coding Brain ì˜ì†ì  í—¬í¼ ì‹œìŠ¤í…œ v1.0
import time, random, json, os
import os
from datetime import datetime

# ===== í•µì‹¬ í—¬í¼ í•¨ìˆ˜ ì •ì˜ =====

# 1. ì„¸ì…˜ ê´€ë¦¬
def init_session():
    """ì„¸ì…˜ ì´ˆê¸°í™” ë˜ëŠ” ê¸°ì¡´ ì„¸ì…˜ í™•ì¸"""
    global session_manager

    if 'session_manager' not in globals():
        session_manager = {
            'session_id': f'ACB_{int(time.time())}_{random.randint(1000,9999)}',
            'start_time': time.time(),
            'state': {},
            'cache': {},
            'history': [],
            'errors': [],
            'performance': {}
        }
        print(f"ğŸ‰ ìƒˆ ì„¸ì…˜ ì‹œì‘: {session_manager['session_id']}")
        return 'new'
    else:
        elapsed = (time.time() - session_manager['start_time']) / 60
        print(f"ğŸ“ ê¸°ì¡´ ì„¸ì…˜ ê³„ì†: {session_manager['session_id']} ({elapsed:.1f}ë¶„ ê²½ê³¼)")
        return 'existing'

def save_checkpoint(name, data):
    """ì²´í¬í¬ì¸íŠ¸ ì €ì¥"""
    if 'session_manager' not in globals():
        init_session()

    session_manager['state'][name] = {
        'data': data,
        'timestamp': time.time(),
        'session_id': session_manager['session_id']
    }
    add_to_history('checkpoint_saved', {'name': name})
    print(f"ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ì €ì¥: {name}")
    return True

def load_checkpoint(name):
    """ì²´í¬í¬ì¸íŠ¸ ë¡œë“œ"""
    if 'session_manager' not in globals():
        return None

    checkpoint = session_manager['state'].get(name)
    if checkpoint:
        add_to_history('checkpoint_loaded', {'name': name})
        print(f"ğŸ“‚ ì²´í¬í¬ì¸íŠ¸ ë¡œë“œ: {name}")
        return checkpoint['data']
    return None

def add_to_history(action, data, max_entries=100):
    """íˆìŠ¤í† ë¦¬ ì¶”ê°€"""
    if 'session_manager' not in globals():
        init_session()

    entry = {
        'timestamp': time.time(),
        'action': action,
        'data': data
    }

    session_manager['history'].append(entry)

    if len(session_manager['history']) > max_entries:
        session_manager['history'] = session_manager['history'][-max_entries:]

def show_history(n=10):
    """ìµœê·¼ íˆìŠ¤í† ë¦¬ í‘œì‹œ"""
    if 'session_manager' not in globals() or not session_manager['history']:
        print("íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    print(f"\nğŸ“œ ìµœê·¼ íˆìŠ¤í† ë¦¬ (ìµœëŒ€ {n}ê°œ):")
    for entry in session_manager['history'][-n:]:
        time_str = datetime.fromtimestamp(entry['timestamp']).strftime('%H:%M:%S')
        print(f"  [{time_str}] {entry['action']}: {entry['data']}")

# 2. ìºì‹± ì‹œìŠ¤í…œ
def cached_operation(key, compute_func, ttl=300):
    """ìºì‹±ëœ ì‘ì—… ì‹¤í–‰ (TTL ì§€ì›)"""
    if 'session_manager' not in globals():
        init_session()

    cache = session_manager.get('cache', {})

    if key in cache:
        entry = cache[key]
        age = time.time() - entry['timestamp']
        if age < ttl:
            print(f"ğŸ¯ ìºì‹œ íˆíŠ¸: {key} (age: {age:.1f}s)")
            add_to_history('cache_hit', {'key': key})
            return entry['data']

    print(f"ğŸ’° ê³„ì‚° ì‹¤í–‰: {key}")
    start_time = time.time()
    result = compute_func()
    duration = time.time() - start_time

    session_manager['cache'][key] = {
        'data': result,
        'timestamp': time.time(),
        'compute_time': duration
    }

    add_to_history('cache_miss', {'key': key, 'compute_time': duration})
    return result

def clear_cache(key=None):
    """ìºì‹œ ì‚­ì œ"""
    if 'session_manager' not in globals():
        return

    if key:
        if key in session_manager.get('cache', {}):
            del session_manager['cache'][key]
            print(f"ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ: {key}")
    else:
        session_manager['cache'] = {}
        print("ğŸ—‘ï¸ ì „ì²´ ìºì‹œ ì´ˆê¸°í™”")

# 3. ì›Œí¬í”Œë¡œìš° í—¬í¼
def show_plan(tasks, require_confirmation=True):
    """ì‘ì—… ê³„íš í‘œì‹œ"""
    print("\n" + "="*70)
    print("ğŸ“‹ AI Coding Brain ì‘ì—… ê³„íš")
    print("="*70)

    total_time = 0
    for i, task in enumerate(tasks, 1):
        if isinstance(task, dict):
            print(f"\n{i}. {task.get('name', 'ì‘ì—…')}")
            if 'desc' in task:
                print(f"   ì„¤ëª…: {task['desc']}")
            if 'time' in task:
                print(f"   ì˜ˆìƒ: {task['time']}")
                try:
                    time_val = int(''.join(filter(str.isdigit, task['time'])))
                    total_time += time_val
                except:
                    pass
            if task.get('subtasks'):
                for j, subtask in enumerate(task.get('subtasks', []), 1):
                    print(f"   {i}.{j} {subtask}")
        else:
            print(f"{i}. {task}")

    if total_time > 0:
        print(f"\nâ±ï¸ ì´ ì˜ˆìƒ ì‹œê°„: {total_time}ë¶„")

    if require_confirmation:
        print("\n[USER_CONFIRMATION_REQUIRED]")
        print("ì´ ê³„íšëŒ€ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        print("ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ ì•Œë ¤ì£¼ì„¸ìš”.")

    print("="*70)

    add_to_history('plan_shown', {'tasks': len(tasks)})
    return True

def update_progress(task_name, percent):
    """ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸"""
    bar_length = 30
    filled = int(bar_length * percent / 100)
    bar = 'â–ˆ' * filled + 'â–‘' * (bar_length - filled)

    print(f"\rğŸ“Š {task_name}: [{bar}] {percent}%", end='')
    if percent >= 100:
        print()

    if 'session_manager' in globals():
        session_manager['state']['current_progress'] = {
            'task': task_name,
            'percent': percent,
            'timestamp': time.time()
        }

    return percent

def request_feedback(message, options=None):
    """ì‚¬ìš©ì í”¼ë“œë°± ìš”ì²­"""
    print(f"\n{'ğŸ” ' + '='*67}")
    print("[FEEDBACK_NEEDED]")
    print(message)

    if options:
        print("\nì„ íƒ ì˜µì…˜:")
        for i, opt in enumerate(options, 1):
            print(f"  {i}. {opt}")

    print("="*70)

    add_to_history('feedback_requested', {'message': message[:50]})
    return True

# 4. ëŒ€ìš©ëŸ‰ ì²˜ë¦¬
def chunk_processor(data, process_func, chunk_size=100):
    """ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬"""
    if not data:
        return []

    total = len(data)
    chunks = [data[i:i+chunk_size] for i in range(0, total, chunk_size)]
    results = []

    print(f"\nğŸ”„ ì²­í¬ ì²˜ë¦¬ ì‹œì‘: {len(chunks)}ê°œ ì²­í¬ (ê° {chunk_size}ê°œ)")

    for i, chunk in enumerate(chunks):
        progress = ((i + 1) / len(chunks)) * 100
        update_progress(f"ì²­í¬ ì²˜ë¦¬", progress)

        try:
            chunk_result = process_func(chunk)
            if isinstance(chunk_result, list):
                results.extend(chunk_result)
            else:
                results.append(chunk_result)
        except Exception as e:
            print(f"\nâŒ ì²­í¬ {i+1} ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
            continue

        if (i + 1) % 10 == 0:
            save_checkpoint(f"chunk_progress_{i+1}", {
                'processed': i + 1,
                'total': len(chunks),
                'results_count': len(results)
            })

    print(f"\nâœ… ì²­í¬ ì²˜ë¦¬ ì™„ë£Œ: {len(results)}ê°œ ê²°ê³¼")
    return results

# 5. ì˜¤ë¥˜ ì²˜ë¦¬
def safe_execute(func, *args, **kwargs):
    """ì•ˆì „í•œ í•¨ìˆ˜ ì‹¤í–‰ (ì˜¤ë¥˜ ì²˜ë¦¬ í¬í•¨)"""
    try:
        result = func(*args, **kwargs)
        return result
    except Exception as e:
        error_info = {
            'function': func.__name__ if hasattr(func, '__name__') else str(func),
            'error': str(e),
            'type': type(e).__name__,
            'timestamp': time.time()
        }

        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {error_info['type']}")
        print(f"   í•¨ìˆ˜: {error_info['function']}")
        print(f"   ë©”ì‹œì§€: {error_info['error']}")

        if 'session_manager' in globals():
            session_manager['errors'].append(error_info)

            recent_errors = [e for e in session_manager['errors'] 
                           if e['type'] == error_info['type']]
            if len(recent_errors) >= 3:
                print(f"   âš ï¸ ê²½ê³ : {error_info['type']} ì˜¤ë¥˜ê°€ {len(recent_errors)}ë²ˆ ë°˜ë³µë¨")

        add_to_history('error_occurred', error_info)
        return None

def try_execute_or_recover(operation_func):
    """execute_code ì‹¤í–‰ ì‹œë„, ì‹¤íŒ¨ì‹œ Desktop Commanderë¡œ ë³µêµ¬ ì œì•ˆ"""
    try:
        return operation_func()
    except PermissionError as e:
        print("\nâŒ ê¶Œí•œ ì˜¤ë¥˜ - Desktop Commander ë³µêµ¬ í•„ìš”")
        print("[DESKTOP_COMMANDER_RECOVERY_NEEDED]")
        print("ë‹¤ìŒ ëª…ë ¹ì„ Desktop Commanderë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”:")
        print(f"  chmod/icacls ëª…ë ¹ìœ¼ë¡œ ê¶Œí•œ ìˆ˜ì •")
        return None
    except (SystemError, OSError) as e:
        print(f"\nâŒ ì‹œìŠ¤í…œ ì˜¤ë¥˜: {e}")
        print("[DESKTOP_COMMANDER_RECOVERY_NEEDED]")
        return None
    except Exception as e:
        return safe_execute(operation_func)

# 6. ì‹œê°„ ì¸¡ì •
class measure_time:
    """ì‹¤í–‰ ì‹œê°„ ì¸¡ì • ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €"""
    def __init__(self, name):
        self.name = name
        self.start = None

    def __enter__(self):
        self.start = time.time()
        print(f"â±ï¸ {self.name} ì‹œì‘...")
        return self

    def __exit__(self, *args):
        duration = time.time() - self.start
        print(f"â±ï¸ {self.name} ì™„ë£Œ: {duration:.2f}ì´ˆ")

        if 'session_manager' in globals():
            if 'performance' not in session_manager:
                session_manager['performance'] = {}

            if self.name not in session_manager['performance']:
                session_manager['performance'][self.name] = []

            session_manager['performance'][self.name].append({
                'duration': duration,
                'timestamp': time.time()
            })

# 7. ì„¸ì…˜ ìš”ì•½
def show_session_summary():
    """í˜„ì¬ ì„¸ì…˜ ìš”ì•½ ì •ë³´ í‘œì‹œ"""
    if 'session_manager' not in globals():
        print("ì„¸ì…˜ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    duration = (time.time() - session_manager['start_time']) / 60

    print("\n" + "="*70)
    print("ğŸ“Š AI Coding Brain ì„¸ì…˜ ìš”ì•½")
    print("="*70)
    print(f"ì„¸ì…˜ ID: {session_manager['session_id']}")
    print(f"ì‹¤í–‰ ì‹œê°„: {duration:.1f}ë¶„")
    print(f"ì²´í¬í¬ì¸íŠ¸: {len(session_manager['state'])}ê°œ")
    print(f"ìºì‹œ í•­ëª©: {len(session_manager.get('cache', {}))}ê°œ")
    print(f"íˆìŠ¤í† ë¦¬: {len(session_manager['history'])}ê°œ")
    print(f"ì˜¤ë¥˜ ë°œìƒ: {len(session_manager.get('errors', []))}íšŒ")

    cache_hits = sum(1 for h in session_manager['history'] 
                    if h['action'] == 'cache_hit')
    cache_misses = sum(1 for h in session_manager['history'] 
                      if h['action'] == 'cache_miss')
    total_cache = cache_hits + cache_misses
    if total_cache > 0:
        print(f"ìºì‹œ íš¨ìœ¨: {(cache_hits/total_cache)*100:.1f}%")

    print("="*70)

# 8. ë„ì›€ë§ ì‹œìŠ¤í…œ
def help_quick():
    """ë¹ ë¥¸ í—¬í¼ ì°¸ì¡°"""
    print("\nâš¡ AI Coding Brain ì£¼ìš” í—¬í¼ í•¨ìˆ˜")
    print("="*50)

    helps = [
        ("ì„¸ì…˜", [
            "init_session() - ì„¸ì…˜ ì‹œì‘/í™•ì¸",
            "save_checkpoint(name, data) - ìƒíƒœ ì €ì¥",
            "load_checkpoint(name) - ìƒíƒœ ë¡œë“œ",
            "show_history(n) - íˆìŠ¤í† ë¦¬ ë³´ê¸°"
        ]),
        ("ìºì‹±", [
            "cached_operation(key, func) - ê²°ê³¼ ìºì‹±",
            "clear_cache(key) - ìºì‹œ ì‚­ì œ"
        ]),
        ("ì›Œí¬í”Œë¡œìš°", [
            "show_plan(tasks) - ê³„íš í‘œì‹œ",
            "update_progress(task, %) - ì§„í–‰ë¥ ",
            "request_feedback(msg) - í”¼ë“œë°± ìš”ì²­"
        ]),
        ("ì²˜ë¦¬", [
            "chunk_processor(data, func) - ì²­í¬ ì²˜ë¦¬",
            "safe_execute(func) - ì•ˆì „í•œ ì‹¤í–‰",
            "measure_time(name) - ì‹œê°„ ì¸¡ì •"
        ])
    ]

    for category, funcs in helps:
        print(f"\n{category}:")
        for func in funcs:
            print(f"  â€¢ {func}")

    print("\nğŸ’¡ ìƒì„¸ ë„ì›€ë§: show_helpers()")
    print("ğŸ’¡ ì„¸ì…˜ ìš”ì•½: show_session_summary()")

def show_helpers(category=None):
    """ìƒì„¸ í—¬í¼ í•¨ìˆ˜ ë„ì›€ë§"""
    categories = {
        'session': {
            'init_session': "ì„¸ì…˜ì„ ì‹œì‘í•˜ê±°ë‚˜ ê¸°ì¡´ ì„¸ì…˜ì„ í™•ì¸í•©ë‹ˆë‹¤.",
            'save_checkpoint': "í˜„ì¬ ìƒíƒœë¥¼ ì²´í¬í¬ì¸íŠ¸ë¡œ ì €ì¥í•©ë‹ˆë‹¤.",
            'load_checkpoint': "ì €ì¥ëœ ì²´í¬í¬ì¸íŠ¸ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.",
            'add_to_history': "ì‘ì—… íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ì„ ì¶”ê°€í•©ë‹ˆë‹¤.",
            'show_history': "ìµœê·¼ ì‘ì—… íˆìŠ¤í† ë¦¬ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤."
        },
        'cache': {
            'cached_operation': "í•¨ìˆ˜ ê²°ê³¼ë¥¼ ìºì‹±í•˜ì—¬ ë°˜ë³µ í˜¸ì¶œì‹œ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.",
            'clear_cache': "ìºì‹œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
        },
        'workflow': {
            'show_plan': "ì‘ì—… ê³„íšì„ í‘œì‹œí•˜ê³  ì‚¬ìš©ì í™•ì¸ì„ ìš”ì²­í•©ë‹ˆë‹¤.",
            'update_progress': "ì‘ì—… ì§„í–‰ë¥ ì„ í‘œì‹œí•©ë‹ˆë‹¤.",
            'request_feedback': "ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°±ì„ ìš”ì²­í•©ë‹ˆë‹¤."
        },
        'utils': {
            'chunk_processor': "ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬í•©ë‹ˆë‹¤.",
            'safe_execute': "ì˜¤ë¥˜ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë©° í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.",
            'try_execute_or_recover': "ì‹¤í–‰ ì‹¤íŒ¨ì‹œ Desktop Commanderë¡œ ë³µêµ¬ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.",
            'measure_time': "ì½”ë“œ ë¸”ë¡ì˜ ì‹¤í–‰ ì‹œê°„ì„ ì¸¡ì •í•©ë‹ˆë‹¤.",
            'show_session_summary': "í˜„ì¬ ì„¸ì…˜ì˜ ìš”ì•½ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤."
        }
    }

    print("\nğŸ“š AI Coding Brain í—¬í¼ í•¨ìˆ˜ ìƒì„¸ ë„ì›€ë§")
    print("="*70)

    if category:
        if category in categories:
            print(f"\nğŸ·ï¸ {category.upper()}")
            for func, desc in categories[category].items():
                print(f"\n  ğŸ“Œ {func}")
                print(f"     {desc}")
        else:
            print(f"'{category}' ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    else:
        for cat, funcs in categories.items():
            print(f"\nğŸ·ï¸ {cat.upper()}")
            for func, desc in funcs.items():
                print(f"\n  ğŸ“Œ {func}")
                print(f"     {desc}")

def search_helper(keyword):
    """í‚¤ì›Œë“œë¡œ í—¬í¼ í•¨ìˆ˜ ê²€ìƒ‰"""
    print(f"\nğŸ” '{keyword}' ê²€ìƒ‰ ê²°ê³¼:")

    found = []
    for name, obj in globals().items():
        if callable(obj) and not name.startswith('_'):
            if keyword.lower() in name.lower():
                found.append(name)

    if found:
        for func in found:
            print(f"  â€¢ {func}()")
    else:
        print(f"  '{keyword}' ê´€ë ¨ í—¬í¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    return found

# ===== í—¬í¼ ìë™ ë¡œë“œ =====
def _load_ai_coding_brain_helpers():
    """ëª¨ë“  í—¬í¼ í•¨ìˆ˜ë¥¼ globals()ì— ë¡œë“œ"""
    helpers = [
        init_session, save_checkpoint, load_checkpoint, 
        add_to_history, show_history,
        cached_operation, clear_cache,
        show_plan, update_progress, request_feedback,
        chunk_processor, safe_execute, try_execute_or_recover,
        measure_time, show_session_summary,
        help_quick, show_helpers, search_helper
    ]

    for func in helpers:
        globals()[func.__name__] = func

    required_imports = ['time', 'random', 'json', 'os', 'datetime']
    for module in required_imports:
        if module not in globals():
            if module == 'datetime':
                from datetime import datetime
                globals()['datetime'] = datetime
            else:
                globals()[module] = __import__(module)

    return len(helpers)

# ìë™ ë¡œë“œ ì‹¤í–‰
if 'AI_CODING_BRAIN_LOADED' not in globals():
    num_loaded = _load_ai_coding_brain_helpers()
    AI_CODING_BRAIN_LOADED = True
    print(f"âœ… {num_loaded}ê°œì˜ í—¬í¼ í•¨ìˆ˜ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!")
    print("\nì‚¬ìš©ë²•:")
    print("  â€¢ help_quick() - ë¹ ë¥¸ ë„ì›€ë§")
    print("  â€¢ show_helpers() - ìƒì„¸ ë„ì›€ë§")
    print("  â€¢ init_session() - ì„¸ì…˜ ì‹œì‘")
else:
    print("âœ… AI Coding Brain í—¬í¼ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")

# ìë™ìœ¼ë¡œ ì„¸ì…˜ ì´ˆê¸°í™”
init_session()
