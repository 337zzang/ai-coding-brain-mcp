# Flow 경로 관리 시스템 분석 보고서

## 분석 일시
2025-07-22T22:23:23.646888

## o3 분석 결과
{'answer': '──────────────────────────────────────────────────\n1. 문제 진단\n──────────────────────────────────────────────────\nA. JsonFlowRepository 가 storage_path 를 __init__ 시점에만 계산  \n   • os.getcwd() 를 호출한 뒤 속성으로 고정 ⇒ run-time 에 디렉토리가 바뀌어도 반영되지 않음  \n   • 동일 인스턴스를 FlowService, FlowManagerUnified 가 캐싱하므로 프로젝트를 바꿔도\n     “예전” flows.json 이 계속 사용됨\n\nB. FlowService 의 “current_flow” 메타 정보가 $HOME/.ai-flow/current_flow.txt\n   에 저장되어 프로젝트 경계를 무시\n\nC. FlowManagerUnified 내부에\n   self._flows / self._current_flow  캐시가 별도로 존재 → 경로가 바뀌어도\n   invalidate 되지 않음\n\nD. 프로젝트 전환 기능(os.chdir 등의 호출)이 코드 상에 전혀 없음\n\n──────────────────────────────────────────────────\n2. 설계 원칙 재정립\n──────────────────────────────────────────────────\n① 저장소(Repository)는 “프로젝트 루트”라는 컨텍스트에 완전히 종속돼야 한다.  \n   같은 프로세스에서 프로젝트가 바뀌면 “새” Repository 인스턴스를 써야 한다.\n\n② 전역 파일( $HOME …)은 최소화하고, 필요한 경우에도\n   프로젝트별 하위 디렉토리에 보조 메타 정보를 둔다.\n\n③ 컨텍스트(프로젝트 루트) → Repository → Service → Facade(FlowManager) 로\n   의존성이 단방향이 되도록 한다. 컨텍스트가 바뀌면 상위 레이어를\n   새로 만드는 것이 가장 단순하고 안전하다.\n\n──────────────────────────────────────────────────\n3. 구조적 변경 제안\n──────────────────────────────────────────────────\n3-1. ProjectContext (또는 Workspace) 객체 도입\n------------------------------------------------\nclass ProjectContext:\n    def __init__(self, root: Path):\n        self.root = Path(root).resolve()\n\n    @property\n    def flow_file(self) -> Path:\n        return self.root / ".ai-brain" / "flows.json"\n\n    @property\n    def meta_dir(self) -> Path:\n        return self.root / ".ai-brain"\n\n이 객체만 바꿔 끼우면 모든 경로가 자동으로 바뀌도록 한다.\n\n3-2. JsonFlowRepository 개선\n------------------------------------------------\nclass JsonFlowRepository(FlowRepository):\n    def __init__(self, context: ProjectContext):\n        self._context = context\n        self._ensure_file()\n\n    @property\n    def storage_path(self) -> Path:\n        # 언제든 context 가 바뀌면 이 프로퍼티가 새 값을 돌려준다\n        return self._context.flow_file\n\n    def set_context(self, context: ProjectContext):\n        self._context = context\n        self._ensure_file()\n\n3-3. FlowService → current_flow.txt 제거\n------------------------------------------------\n• 현재 Flow ID 를 flows.json 안에 별도 필드로 저장하거나  \n  .ai-brain/current_flow.txt 처럼 **프로젝트 내부**에 둔다.\n\n3-4. FlowManagerUnified 리팩터링\n------------------------------------------------\nclass FlowManagerUnified:\n    @classmethod\n    def for_project(cls, project_root: str):\n        ctx = ProjectContext(project_root)\n        repo = JsonFlowRepository(ctx)\n        flow_service = FlowService(repo)\n        ... # 의존성 주입\n        return cls(ctx, repo, flow_service, ...)\n\n    def switch_project(self, new_root: str):\n        self.context = ProjectContext(new_root)\n        self.repository.set_context(self.context)\n        # 캐시 무효화\n        self._sync_flows_from_service()\n\n※ 기존 레거시 API 를 그대로 살리면서 내부적으로만 교체 가능\n\n3-5. CLI / 외부 호출부\n------------------------------------------------\nmanager = FlowManagerUnified.for_project("/path/to/projA")\n...\nmanager.switch_project("/path/to/projB")  # or 새 인스턴스 생성\n...\n\n──────────────────────────────────────────────────\n4. 경로 전환 시나리오 예시\n──────────────────────────────────────────────────\ndef change_project(project_path: str):\n    if not Path(project_path).exists():\n        raise FileNotFoundError(project_path)\n    # 방법 1) 프로세스 전체 전환\n    os.chdir(project_path)\n    global flow_manager\n    flow_manager = FlowManagerUnified.for_project(Path.cwd())\n\n    # 방법 2) 인스턴스 교체 없이 내부 전환\n    flow_manager.switch_project(project_path)\n\n──────────────────────────────────────────────────\n5. Repository 패턴을 유지하며 동적 경로 변경하기\n──────────────────────────────────────────────────\n1) Repository 는 “변하지 않는 저장소”가 아니라 “변할 수 있는 컨텍스트”를 가진\n   ** Stateful Service ** 로 본다.\n\n2) 핵심은 “FlowService 는 ‘현재 Repository’가 무엇이든 사용하면 된다”는 것.  \n   ⇒ Repository 내부에 set_context 혹은 reload 를 제공\n\n3) 장점  \n   • 의존 계층(도메인 로직 ↔ 인프라) 분리는 그대로 유지  \n   • 테스트 시 가짜 context 로 쉽게 주입 가능  \n   • 프로젝트 스위칭은 Repository 만 갈아 끼우면 해결\n\n──────────────────────────────────────────────────\n6. 요약 체크리스트\n──────────────────────────────────────────────────\n☑ ProjectContext(또는 Workspace) 로 프로젝트의 루트 디렉토리를 명시적으로 관리  \n☑ JsonFlowRepository 가 context 변경을 수용할 수 있게 setter / property 제공  \n☑ FlowService 의 전역 current_flow 저장 파일을 프로젝트 내부로 이동  \n☑ FlowManagerUnified 에 “switch_project” API 추가 또는\n   “프로젝트마다 새 인스턴스” 패턴 도입  \n☑ CLI(또는 상위 애플리케이션)에서 프로젝트 전환 시\n   ① os.chdir (선택) ② FlowManager 재생성 or switch_project 호출 수행\n\n이렇게 조정하면 한 프로세스 안에서 여러 프로젝트를 자유롭게 전환하면서\n각 디렉토리의 .ai-brain/flows.json 를 안전하게 사용할 수 있습니다.', 'reasoning_effort': 'high', 'usage': {'prompt_tokens': 1854, 'completion_tokens': 1842, 'total_tokens': 3696, 'reasoning_tokens': 0}}

## 현재 상황
- 프로젝트: ai-coding-brain-mcp
- 경로: C:\Users\82106\Desktop\ai-coding-brain-mcp
- flows.json 위치: C:\Users\82106\Desktop\ai-coding-brain-mcp\.ai-brain\flows.json
