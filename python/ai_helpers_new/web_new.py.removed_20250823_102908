"""
ì›¹ ìë™í™” ëª¨ë“ˆ - í˜¸í™˜ì„± ë˜í¼
ê¸°ì¡´ web.py APIì™€ 100% í˜¸í™˜ë˜ëŠ” ë˜í¼
ìƒˆë¡œìš´ web/ ëª¨ë“ˆ êµ¬ì¡°ë¥¼ í™œìš©í•˜ë©´ì„œ ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ ìœ ì§€
"""

import warnings
from typing import Optional, Dict, Any, List

# ìƒˆë¡œìš´ ëª¨ë“ˆì—ì„œ import
from .web import (
    WebAutomation,
    web_start as _web_start,
    web_goto as _web_goto,
    web_click as _web_click,
    web_type as _web_type,
    web_close as _web_close,
    web_screenshot as _web_screenshot,
    web_execute_js as _web_execute_js,
    web_list_sessions as _web_list_sessions,
)

# í˜¸í™˜ì„±ì„ ìœ„í•œ ì¶”ê°€ import
from .web.types import HelperResult
from .web.utils import safe_get_data

# ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
_web = WebAutomation()

# ============================================
# ê¸°ì¡´ web.pyì™€ 100% í˜¸í™˜ë˜ëŠ” í•¨ìˆ˜ë“¤
# ============================================

def web_start(
    session_id: Optional[str] = None,
    headless: bool = False,
    browser_type: str = "chromium",
    overlay: bool = False,
    overlay_config: Optional[Dict] = None
) -> Dict[str, Any]:
    """
    ë¸Œë¼ìš°ì € ì‹œì‘ - ê¸°ì¡´ API í˜¸í™˜

    Args:
        session_id: ì„¸ì…˜ ID
        headless: í—¤ë“œë¦¬ìŠ¤ ëª¨ë“œ
        browser_type: ë¸Œë¼ìš°ì € íƒ€ì…
        overlay: ì˜¤ë²„ë ˆì´ í™œì„±í™” (ë¯¸êµ¬í˜„ - ì¶”í›„ ì¶”ê°€)
        overlay_config: ì˜¤ë²„ë ˆì´ ì„¤ì • (ë¯¸êµ¬í˜„ - ì¶”í›„ ì¶”ê°€)
    """
    if overlay or overlay_config:
        warnings.warn("Overlay feature not yet implemented in new structure", FutureWarning)

    return _web_start(session_id, headless, browser_type)


def web_goto(
    url: str,
    session_id: Optional[str] = None,
    timeout: Optional[int] = 30000,
    wait_until: str = "load",
    auto_overlay: bool = False
) -> Dict[str, Any]:
    """í˜ì´ì§€ ì´ë™ - ê¸°ì¡´ API í˜¸í™˜"""
    if auto_overlay:
        warnings.warn("auto_overlay not yet implemented", FutureWarning)

    return _web_goto(url, session_id, timeout)


def web_click(
    selector: str,
    session_id: Optional[str] = None,
    force: bool = False,
    timeout: Optional[int] = 10000
) -> Dict[str, Any]:
    """ìš”ì†Œ í´ë¦­ - ê¸°ì¡´ API í˜¸í™˜"""
    return _web_click(selector, session_id, force, timeout)


def web_type(
    selector: str,
    text: str,
    session_id: Optional[str] = None,
    clear: bool = False,
    timeout: Optional[int] = 10000
) -> Dict[str, Any]:
    """í…ìŠ¤íŠ¸ ì…ë ¥ - ê¸°ì¡´ API í˜¸í™˜"""
    return _web_type(selector, text, session_id, clear, timeout)


def web_extract(
    selector: str,
    session_id: Optional[str] = None,
    extract_type: str = "text",
    attribute: Optional[str] = None,
    multiple: bool = False,
    wait_timeout: Optional[int] = 10000
) -> Dict[str, Any]:
    """
    ë°ì´í„° ì¶”ì¶œ - ê¸°ì¡´ API í˜¸í™˜
    (ì¶”í›„ extractor.py ëª¨ë“ˆ êµ¬í˜„ ì‹œ ì—°ê²°)
    """
    # ì„ì‹œ êµ¬í˜„
    result = _web.execute_js(
        f"""
        const element = document.querySelector('{selector}');
        if (!element) return null;

        if ('{extract_type}' === 'text') return element.textContent;
        if ('{extract_type}' === 'html') return element.innerHTML;
        if ('{extract_type}' === 'value') return element.value;
        if ('{extract_type}' === 'attribute' && '{attribute}')
            return element.getAttribute('{attribute}');
        return null;
        """,
        session_id
    )

    return result.to_dict() if hasattr(result, 'to_dict') else result


def web_screenshot(
    path: Optional[str] = None,
    session_id: Optional[str] = None
) -> Dict[str, Any]:
    """ìŠ¤í¬ë¦°ìƒ· - ê¸°ì¡´ API í˜¸í™˜"""
    return _web_screenshot(path, session_id)


def web_close(
    session_id: Optional[str] = None
) -> Dict[str, Any]:
    """ë¸Œë¼ìš°ì € ì¢…ë£Œ - ê¸°ì¡´ API í˜¸í™˜"""
    return _web_close(session_id)


def web_wait(
    seconds: float,
    session_id: Optional[str] = None
) -> Dict[str, Any]:
    """ëŒ€ê¸° - ê¸°ì¡´ API í˜¸í™˜"""
    import time
    time.sleep(seconds)
    return {"ok": True, "data": f"Waited {seconds} seconds"}


def web_execute_js(
    script: str,
    session_id: Optional[str] = None
) -> Dict[str, Any]:
    """JavaScript ì‹¤í–‰ - ê¸°ì¡´ API í˜¸í™˜"""
    return _web_execute_js(script, session_id)


def web_execute_js_safe(
    script: str,
    session_id: Optional[str] = None,
    default_value: Any = None
) -> Dict[str, Any]:
    """ì•ˆì „í•œ JavaScript ì‹¤í–‰ - ê¸°ì¡´ API í˜¸í™˜"""
    try:
        result = _web_execute_js(script, session_id)
        if result.get('ok'):
            return result
        return {"ok": True, "data": default_value}
    except:
        return {"ok": True, "data": default_value}


def web_list_sessions() -> Dict[str, Any]:
    """ì„¸ì…˜ ëª©ë¡ - ê¸°ì¡´ API í˜¸í™˜"""
    return _web_list_sessions()


def web_wait_for_element(
    selector: str,
    session_id: Optional[str] = None,
    timeout: Optional[int] = 10000
) -> Dict[str, Any]:
    """ìš”ì†Œ ëŒ€ê¸° - ê¸°ì¡´ API í˜¸í™˜"""
    result = _web.wait(selector, session_id, timeout)
    return result.to_dict() if hasattr(result, 'to_dict') else result


def web_wait_for_load(
    session_id: Optional[str] = None,
    timeout: Optional[int] = 30000
) -> Dict[str, Any]:
    """í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸° - ê¸°ì¡´ API í˜¸í™˜"""
    # JavaScriptë¡œ ë¡œë“œ ìƒíƒœ í™•ì¸
    result = _web.execute_js(
        "return document.readyState === 'complete'",
        session_id
    )
    return result.to_dict() if hasattr(result, 'to_dict') else result


def web_get_page_metrics(
    session_id: Optional[str] = None
) -> Dict[str, Any]:
    """í˜ì´ì§€ ë©”íŠ¸ë¦­ - ê¸°ì¡´ API í˜¸í™˜"""
    metrics_script = """
    return {
        performance: {
            loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
            domReady: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart,
            resources: performance.getEntriesByType('resource').length
        },
        memory: performance.memory ? {
            used: performance.memory.usedJSHeapSize,
            total: performance.memory.totalJSHeapSize,
            limit: performance.memory.jsHeapSizeLimit
        } : null
    };
    """

    result = _web.execute_js(metrics_script, session_id)
    return result.to_dict() if hasattr(result, 'to_dict') else result


def web_validate_element(
    selector: str,
    session_id: Optional[str] = None,
    checks: Optional[List[str]] = None
) -> Dict[str, Any]:
    """ìš”ì†Œ ê²€ì¦ - ê¸°ì¡´ API í˜¸í™˜"""
    if checks is None:
        checks = ['visible', 'enabled']

    validation_script = f"""
    const element = document.querySelector('{selector}');
    if (!element) return {{"exists": false}};

    const rect = element.getBoundingClientRect();
    const style = window.getComputedStyle(element);

    return {{
        exists: true,
        visible: rect.width > 0 && rect.height > 0 && style.visibility !== 'hidden',
        enabled: !element.disabled,
        editable: element.contentEditable === 'true' || !element.readOnly,
        clickable: !element.disabled && style.pointerEvents !== 'none'
    }};
    """

    result = _web.execute_js(validation_script, session_id)
    return result.to_dict() if hasattr(result, 'to_dict') else result


def web_debug_info(
    session_id: Optional[str] = None
) -> Dict[str, Any]:
    """ë””ë²„ê·¸ ì •ë³´ - ê¸°ì¡´ API í˜¸í™˜"""
    return _web.get_info(session_id).to_dict()


# ============================================
# ì˜¤ë²„ë ˆì´ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì¶”í›„ êµ¬í˜„)
# ============================================

def web_activate_overlay(session_id: Optional[str] = None, **config) -> Dict[str, Any]:
    """ì˜¤ë²„ë ˆì´ í™œì„±í™” - ì¶”í›„ êµ¬í˜„"""
    warnings.warn("Overlay features will be implemented in overlay.py module", FutureWarning)
    return {"ok": True, "data": "Overlay not yet implemented"}


def web_get_overlay_actions(session_id: Optional[str] = None) -> Dict[str, Any]:
    """ì˜¤ë²„ë ˆì´ ì•¡ì…˜ ì¡°íšŒ - ì¶”í›„ êµ¬í˜„"""
    return {"ok": True, "data": []}


def web_minimize_overlay(session_id: Optional[str] = None) -> Dict[str, Any]:
    """ì˜¤ë²„ë ˆì´ ìµœì†Œí™” - ì¶”í›„ êµ¬í˜„"""
    return {"ok": True, "data": "Overlay not yet implemented"}


def web_check_and_activate_overlay(session_id: Optional[str] = None) -> Dict[str, Any]:
    """ì˜¤ë²„ë ˆì´ ì²´í¬ ë° í™œì„±í™” - ì¶”í›„ êµ¬í˜„"""
    return {"ok": True, "data": False}


# ============================================
# ìŠ¤íŠ¸ë¦¬ë° ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì¶”í›„ êµ¬í˜„)
# ============================================

def web_stream_to_ai(session_id: Optional[str] = None, **kwargs) -> Dict[str, Any]:
    """AI ìŠ¤íŠ¸ë¦¬ë° - ì¶”í›„ êµ¬í˜„"""
    warnings.warn("Streaming features will be implemented separately", FutureWarning)
    return {"ok": True, "data": "Streaming not yet implemented"}


def web_get_stream_data(session_id: Optional[str] = None) -> Dict[str, Any]:
    """ìŠ¤íŠ¸ë¦¼ ë°ì´í„° ì¡°íšŒ - ì¶”í›„ êµ¬í˜„"""
    return {"ok": True, "data": None}


# ============================================
# í—¬í¼ í•¨ìˆ˜ë“¤
# ============================================

# ê¸°ì¡´ web.pyì˜ safe_get_data í•¨ìˆ˜ ì¬export
from .web.utils import safe_get_data


# ============================================
# í´ë˜ìŠ¤ë“¤ (ê¸°ì¡´ í˜¸í™˜ì„±)
# ============================================

# SessionManagerì™€ BrowserManagerëŠ” ìƒˆ ëª¨ë“ˆì—ì„œ import
from .web.session import SessionManager, get_session_manager
from .web.browser import BrowserManager, get_browser_manager

# WebNamespaceì™€ WebRecorderëŠ” ì¶”í›„ êµ¬í˜„
class WebNamespace:
    """ì›¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ - ì¶”í›„ êµ¬í˜„"""
    pass

class WebRecorder:
    """ì›¹ ë ˆì½”ë” - ì¶”í›„ êµ¬í˜„"""
    def __init__(self, session_id: str):
        self.session_id = session_id
        warnings.warn("WebRecorder will be implemented in recorder.py module", FutureWarning)


# ============================================
# ëª¨ë“ˆ ë ˆë²¨ ë³€ìˆ˜ë“¤ (ê¸°ì¡´ í˜¸í™˜ì„±)
# ============================================

browser_manager = get_browser_manager()
session_manager = get_session_manager()
current_session_id = None


print("âœ… Web automation module loaded with new architecture")
print("ğŸ“‹ Available functions: web_start, web_goto, web_click, web_type, web_close, etc.")
print("âš ï¸ Some features (overlay, streaming) are pending implementation")
