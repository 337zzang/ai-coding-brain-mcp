#!/usr/bin/env python3
"""
Hooks System Optimization Script
Generated by SUPERPLAN v9.0
"""

import os
import json
import subprocess
from pathlib import Path
from concurrent.futures import ThreadPoolExecutor
import hashlib
import time

class HooksOptimizer:
    """Hooks ì‹œìŠ¤í…œ ìµœì í™” êµ¬í˜„"""

    def __init__(self):
        self.hooks_dir = Path(r"C:\Users\82106\.claude\hooks")
        self.cache = {}
        self.git_cache = {}
        self.git_cache_ttl = 60  # 60ì´ˆ ìºì‹œ

    def implement_git_caching(self):
        """Git ì‘ì—… ìºì‹± êµ¬í˜„"""
        def git_status_cached():
            cache_key = "git_status"
            now = time.time()

            if cache_key in self.git_cache:
                cached_time, cached_result = self.git_cache[cache_key]
                if now - cached_time < self.git_cache_ttl:
                    return cached_result

            # ì‹¤ì œ git status ì‹¤í–‰
            result = subprocess.run(
                ["git", "status", "--porcelain"],
                capture_output=True,
                text=True,
                cwd=os.getcwd()
            )

            self.git_cache[cache_key] = (now, result.stdout)
            return result.stdout

        return git_status_cached

    def parallelize_post_hooks(self):
        """Post-hook ë³‘ë ¬ ì‹¤í–‰ êµ¬í˜„"""
        post_hooks = [
            "post-tool-use.py",
            "post-tool-use-real-flow.py",
            "post_execute_code_think.py"
        ]

        def execute_parallel():
            with ThreadPoolExecutor(max_workers=3) as executor:
                futures = []
                for hook in post_hooks:
                    hook_path = self.hooks_dir / hook
                    if hook_path.exists():
                        future = executor.submit(self.execute_hook, hook_path)
                        futures.append(future)

                # ê²°ê³¼ ìˆ˜ì§‘
                results = [f.result() for f in futures]
                return results

        return execute_parallel

    def execute_hook(self, hook_path):
        """ê°œë³„ hook ì‹¤í–‰"""
        try:
            result = subprocess.run(
                ["python", str(hook_path)],
                capture_output=True,
                text=True,
                timeout=30
            )
            return {"hook": hook_path.name, "success": result.returncode == 0}
        except Exception as e:
            return {"hook": hook_path.name, "error": str(e)}

    def secure_api_keys(self):
        """API í‚¤ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì´ë™"""
        settings_file = Path(r"C:\Users\82106\.claude\settings.json")

        if settings_file.exists():
            with open(settings_file, 'r', encoding='utf-8') as f:
                settings = json.load(f)

            # API í‚¤ ì¶”ì¶œ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì•ˆë‚´
            api_keys = {
                "OPENAI_API_KEY": None,
                "GITHUB_TOKEN": None,
                "PERPLEXITY_API_KEY": None
            }

            print("ë‹¤ìŒ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”:")
            print("=" * 50)
            for key in api_keys:
                print(f"export {key}='your-key-here'")
            print("=" * 50)

            # settings.json ì—…ë°ì´íŠ¸ (í‚¤ ì œê±°)
            # ì‹¤ì œ êµ¬í˜„ ì‹œ ì£¼ì˜ í•„ìš”

        return True

if __name__ == "__main__":
    optimizer = HooksOptimizer()

    print("ğŸš€ Hooks System Optimization Starting...")

    # 1. Git ìºì‹± êµ¬í˜„
    print("âœ… Implementing Git caching...")
    git_cached = optimizer.implement_git_caching()

    # 2. Post-hook ë³‘ë ¬í™”
    print("âœ… Setting up parallel post-hooks...")
    parallel_executor = optimizer.parallelize_post_hooks()

    # 3. API í‚¤ ë³´ì•ˆ
    print("âœ… Securing API keys...")
    optimizer.secure_api_keys()

    print("âœ¨ Optimization complete!")
