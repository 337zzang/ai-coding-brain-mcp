
# 🎯 AI Coding Brain MCP 핵심 모듈 개선 상세 설계

## 📋 개요
AI Coding Brain MCP 프로젝트의 핵심 모듈들에 대한 코드 분석 결과, 즉시 수정이 필요한 치명적 오류와 중장기 개선이 필요한 설계 문제들이 발견되었습니다.

## 🔍 분석 결과 요약

### 1. 즉시 수정 필요한 치명적 오류 (Critical)
1. **`.h.append` 문법 오류** - AttributeError 발생으로 모듈 전체 작동 불가
2. **flow() 함수 반환값 누락** - 일부 명령어에서 None 반환으로 오류 발생
3. **플랫폼별 경로 하드코딩** - Linux 및 비표준 환경에서 작동 불가

### 2. 설계 개선 필요 사항 (Important)
1. **전역 상태 의존** - 확장성과 동시성 처리 제한
2. **문자열 파싱 기반 API** - 오류 발생 가능성 높음
3. **os.chdir 사용** - 예측 불가능한 부작용

### 3. 중장기 개선 사항 (Enhancement)
1. **AST/텍스트 혼용** - 일관성 부족
2. **순환 의존 가능성** - 모듈 구조 개선 필요

## 📐 개선 우선순위 및 범위

### Phase 1: 즉시 수정 (1-2시간)
#### 1.1 `.h.append` 오류 수정
- **영향 파일**: project.py, code.py, safe_wrappers.py
- **수정 방법**: `lines.h.append(line)` → `lines.append(line)`
- **검증**: 각 파일 import 테스트

#### 1.2 flow() 함수 반환값 보완
- **영향 파일**: simple_flow_commands.py
- **수정 방법**: 모든 명령어 경로에 표준 응답 형식 반환
- **검증**: 각 명령어별 반환값 테스트

#### 1.3 플랫폼 독립적 경로 처리
- **영향 파일**: project.py
- **수정 방법**: 
  - 환경변수 활용: `PROJECT_BASE_PATH`
  - 기본값: `Path.home() / "Desktop"`
  - 플랫폼별 대체 경로 자동 탐색

### Phase 2: 구조 개선 (3-4시간)
#### 2.1 전역 상태 제거
- **목표**: 상태 비저장(Stateless) 설계
- **방법**: 
  - Context 객체 도입
  - 명시적 plan_id 전달
  - Manager 인스턴스별 상태 관리

#### 2.2 Pythonic API 제공
- **목표**: 문자열 파싱 의존도 감소
- **방법**:
  ```python
  # 기존: flow("/create 새 계획")
  # 개선: 
  manager = get_flow_manager()
  plan = manager.create_plan("새 계획")
  task = manager.add_task(plan.id, "태스크 1")
  ```

#### 2.3 os.chdir 제거
- **목표**: 부작용 없는 프로젝트 전환
- **방법**: 
  - 프로젝트 경로를 컨텍스트에 저장
  - 모든 파일 작업에서 절대경로 사용

### Phase 3: 품질 개선 (2-3시간)
#### 3.1 일관된 코드 수정 API
- AST 기반으로 통일
- 텍스트 폴백 제거 또는 명시적 경고

#### 3.2 테스트 스위트 구축
- 단위 테스트 작성
- 통합 테스트 시나리오

## 🛠️ 구현 계획

### Task 1: 치명적 오류 수정 (긴급)
1. TODO #1: .h.append 오류 전체 수정
2. TODO #2: flow() 반환값 표준화
3. TODO #3: 플랫폼 독립적 경로 처리
4. TODO #4: 수정사항 테스트 및 검증

### Task 2: 전역 상태 제거 및 API 개선
1. TODO #1: FlowContext 클래스 설계
2. TODO #2: 전역 변수를 Context로 마이그레이션
3. TODO #3: Pythonic API 래퍼 구현
4. TODO #4: 기존 flow() 함수 호환성 유지
5. TODO #5: 통합 테스트

### Task 3: 프로젝트 관리 개선
1. TODO #1: ProjectManager 클래스 설계
2. TODO #2: os.chdir 제거 및 경로 관리 개선
3. TODO #3: 다양한 프로젝트 위치 지원
4. TODO #4: 마이그레이션 및 테스트

### Task 4: 코드 수정 API 일관성 확보
1. TODO #1: AST 기반 수정 함수 통합
2. TODO #2: 텍스트 폴백 제거 또는 경고 추가
3. TODO #3: 검색 함수 AST 기반으로 통일
4. TODO #4: 성능 테스트 및 최적화

## ⚠️ 위험 관리
| 위험 요소 | 대응 방안 |
|----------|----------|
| 기존 API 호환성 | 점진적 마이그레이션, 기존 함수 유지 |
| 성능 저하 | 프로파일링 및 최적화 |
| 예상치 못한 의존성 | 철저한 영향 분석 및 테스트 |

## 📊 예상 효과
1. **안정성 향상**: 치명적 오류 제거로 즉시 안정성 확보
2. **확장성 개선**: 전역 상태 제거로 동시성 지원 가능
3. **유지보수성**: 명확한 API와 일관된 설계
4. **사용성**: 직관적인 Pythonic API 제공

## ✅ 승인 요청
위 설계안 중 Phase 1(치명적 오류 수정)을 우선적으로 진행하고자 합니다.
이후 Phase 2, 3는 순차적으로 진행할 예정입니다.

**Phase 1 작업을 시작해도 될까요? (Y/N)**
