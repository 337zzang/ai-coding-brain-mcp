# JSON REPL Session 리팩토링 전략 (by o3)

생성일: 2025-07-19 11:32:20

## 근본 원인 분석
파일 복잡성의 주된 원인은 **단일 책임 원칙 위반**과 **증분적 발전 과정**에서 비롯됐습니다:
1. **기능 집적화**: REPL 세션 관리 + AI 헬퍼 + JSON 통신 + 유틸리티 기능 등 서로 다른 추상화 계층이 단일 파일에 혼재함
2. **시간 압박**: 신속한 기능 추가로 인해 중복 코드 검증 및 리팩터링 기회 상실
3. **메타프로그래밍 부재**: 동적 코드 생성/관리를 위한 체계적 프레임워크 부재

## 단계별 리팩토링 전략 (우선순위)

### 📌 Phase 1: 구조 안정화 (1-2일)
1. **중복 코드 즉시 처리** (우선순위 ★★★★)
   - `AIHelpersV2` 클래스 통합: 상속 구조로 중복 제거
   - `safe_json_write()` 유틸리티 함수 모듈 이동

2. **내부 모듈 분리** (우선순위 ★★★☆)
   ```python
   ├── session/
   │   ├── core.py           # REPL 세션 핵심 로직
   │   ├── ai_helpers.py     # AI 헬퍼 기능
   │   └── json_utils.py     # JSON 핸들링
   ```

3. **대형 메서드 분해** (우선순위 ★★☆☆)
   - 100+ 라인 메서드를 화살표 함수 단위로 분할
   - 파라미터 7개 이상인 메서드 재설계

### 📌 Phase 2: 아키텍처 재정립 (3-5일)
1. **추상화 계층 도입**
   - `SessionProtocol` 인터페이스 생성
   - `AsyncJSONHandler` 추상 클래스 구현

2. **의존성 역전**:
   ```python
   class AIHelpersV2:
       def __init__(self, json_handler: JSONHandlerProtocol):
           self.handler = json_handler
   ```

### 📌 Phase 3: 지속적 개선 (2-3일)
1. **테스트 커버리지** 85% 이상 달성
2. **타입 힌트 강화**: `mypy --strict` 통과 목표
3. **독스트링 표준화**: Google 스타일 적용

## 모듈 분리 기준
| 모듈명               | 포함 기능                      | 라인 예상 |
|----------------------|-------------------------------|-----------|
| `session/core.py`    | REPL 상태머신, 이벤트 루프    | ~900라인  |
| `ai/helpers.py`      | 프롬프트 엔진, 함수 관리      | ~700라인  |
| `io/json_rpc.py`     | JSON 직렬화/역직렬화          | ~400라인  |
| `utils/decorators.py`| 공유 데코레이터               | ~200라인  |

## 중복 코드 처리 전략
1. **병합 후 상속**:
   ```python
   class BaseAIHelpers:
       def safe_json_write(self, ...): ...

   class AIHelpersV2(BaseAIHelpers): ...
   ```

2. **데코레이터 추출**:
   ```python
   def retry_on_fail(max_retries=3):
       def decorator(func):
           @wraps(func)
           async def wrapper(*args, **kwargs):
               ...
           return wrapper
       return decorator
   ```

## 기능 보존 전략
1. **레드-그린 테스트 사이클**
2. **단계적 롤아웃**: 모듈 단위로 구현체 교체
3. **기능 플래그(F1~F4)로 점진적 전환**

## 테스트 전략
| 테스트 유형       | 목표 커버리지 | 도구          |
|-------------------|---------------|--------------|
| 단위 테스트       | 80%+          | pytest       |
| 통합 테스트       | 주요 시나리오 | Docker Compose|
| 성능 테스트       | 99.9% latency | locust       |

## 예상 소요 시간 및 위험 요소
| 단계          | 소요시간 | 주요 위험 요인              | 완화 방안                     |
|---------------|----------|--------------------------|------------------------------|
| 구조 안정화   | 3일      | 기능 회귀              | 스냅샷 테스트 활용           |
| 아키텍처 개선 | 5일      | 인터페이스 불일치      | 프로토콜 버저닝              |
| 테스트 강화   | 2일      | 테스트 누락            | 커버리지 게이트(>85%)        |

**총 예상 시간**: 10인일 (2주)  
**핵심 리스크**:  
- 동시성 버그 발생 가능성
- 레거시 호환성 문제  

**리스크 완화**:  
1. `asyncio` 디버거 활성화  
2. 버전 브리지(V1Compat) 구현  

리팩토링 후 기대 효과:
- 유지보수성 40% 향상  
- 새 기능 추가 시간 60% 단축  
- 코드 복잡도 점수 62.6 → 28.4 개선
