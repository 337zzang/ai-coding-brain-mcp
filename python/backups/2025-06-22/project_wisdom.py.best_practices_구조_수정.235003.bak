#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n"""\nProject Wisdom Manager - AI Coding Brain MCP\ní”„ë¡œì íŠ¸ ì‘ì—… ì¤‘ ì¶•ì ë˜ëŠ” ì§€í˜œì™€ êµí›ˆì„ ê´€ë¦¬í•˜ëŠ” ëª¨ë“ˆ\n\nì‘ì„±ì¼: 2025-06-22\n"""\n\nimport os\nimport json\nimport re\nfrom datetime import datetime\nfrom typing import Dict, List, Any, Optional\nfrom pathlib import Path\n\nclass ProjectWisdomManager:\n    """í”„ë¡œì íŠ¸ ì§€í˜œ ê´€ë¦¬ í´ë˜ìŠ¤"""\n    \n    def __init__(self, project_root: str = "."):\n        self.project_root = Path(project_root)\n        self.wisdom_file = self.project_root / "project_wisdom.md"\n        self.vision_file = self.project_root / "project_vision.md"\n        self.wisdom_data = {\n            'error_patterns': {},\n            'common_mistakes': {},\n            'best_practices': [],\n            'last_updated': datetime.now().isoformat()\n        }\n        self.load_wisdom()\n    \n    def load_wisdom(self):\n        """ê¸°ì¡´ wisdom ë°ì´í„° ë¡œë“œ"""\n        if self.wisdom_file.exists():\n            # MD íŒŒì¼ íŒŒì‹±í•˜ì—¬ ë°ì´í„° ì¶”ì¶œ\n            content = self.wisdom_file.read_text(encoding='utf-8')\n            self._parse_wisdom_md(content)\n    \n    def _parse_wisdom_md(self, content: str):\n        """MD íŒŒì¼ì—ì„œ wisdom ë°ì´í„° ì¶”ì¶œ"""\n        lines = content.split('\n')\n        current_section = None\n        current_category = 'general'\n        \n        for i, line in enumerate(lines):\n            # ì„¹ì…˜ ê°ì§€\n            if '## ğŸ› ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ íŒ¨í„´' in line:\n                current_section = 'errors'\n            elif '## âŒ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜ë“¤' in line:\n                current_section = 'mistakes'\n            elif '## âœ… ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤' in line:\n                current_section = 'practices'\n            \n            # ì˜¤ë¥˜ íŒ¨í„´ ì¶”ì¶œ\n            if current_section == 'errors' and '###' in line:\n                error_name = line.replace('###', '').strip()\n                # ë‹¤ìŒ ì¤„ë“¤ì—ì„œ ì •ë³´ ì¶”ì¶œ\n                for j in range(i+1, min(i+5, len(lines))):\n                    if 'ë°œìƒ íšŸìˆ˜' in lines[j]:\n                        try:\n                            count = int(re.search(r'(\d+)íšŒ', lines[j]).group(1))\n                            self.wisdom_data['error_patterns'][error_name] = {'count': count}\n                        except:\n                            pass\n                        break\n            \n            # ì‹¤ìˆ˜ íŒ¨í„´ ì¶”ì¶œ\n            elif current_section == 'mistakes' and re.match(r'^\d+\.', line):\n                # ì‹¤ìˆ˜ ì´ë¦„ ì¶”ì¶œ\n                match = re.search(r'^\d+\.\s*\*\*(.*?)\*\*', line)\n                if match:\n                    mistake_name = match.group(1)\n                    # ë‹¤ìŒ ì¤„ë“¤ì—ì„œ ì •ë³´ ì¶”ì¶œ\n                    for j in range(i+1, min(i+5, len(lines))):\n                        if 'ë°œìƒ íšŸìˆ˜' in lines[j]:\n                            try:\n                                count = int(re.search(r'(\d+)íšŒ', lines[j]).group(1))\n                                if mistake_name not in self.wisdom_data['common_mistakes']:\n                                    self.wisdom_data['common_mistakes'][mistake_name] = {'count': count}\n                                else:\n                                    self.wisdom_data['common_mistakes'][mistake_name]['count'] = count\n                            except:\n                                pass\n                            break\n            \n            # ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì¶”ì¶œ\n            elif current_section == 'practices':\n                # ì¹´í…Œê³ ë¦¬ ê°ì§€\n                if '###' in line and line.strip() != '###':\n                    current_category = line.replace('###', '').strip().lower()\n                # í”„ë™í‹°ìŠ¤ í•­ëª© ê°ì§€\n                elif line.strip().startswith('-') and line.strip() != '-':\n                    practice_text = line.strip()[1:].strip()\n                    if practice_text:\n                        # ì¤‘ë³µ ì²´í¬ í›„ ì¶”ê°€\n                        if not any(isinstance(p, dict) and p.get('text') == practice_text \n                                  for p in self.wisdom_data['best_practices']):\n                            self.wisdom_data['best_practices'].append({\n                                'text': practice_text,\n                                'category': current_category\n                            })\n    def track_error(self, error_type: str, error_msg: str):\n        """ì˜¤ë¥˜ ë°œìƒ ì¶”ì """\n        if error_type not in self.wisdom_data['error_patterns']:\n            self.wisdom_data['error_patterns'][error_type] = {\n                'count': 0,\n                'first_seen': datetime.now().isoformat(),\n                'messages': []\n            }\n        \n        pattern = self.wisdom_data['error_patterns'][error_type]\n        pattern['count'] += 1\n        pattern['last_seen'] = datetime.now().isoformat()\n        \n        # ë©”ì‹œì§€ ì €ì¥ (ìµœëŒ€ 5ê°œ)\n        if error_msg not in pattern['messages']:\n            pattern['messages'].append(error_msg)\n            pattern['messages'] = pattern['messages'][-5:]\n        \n        self.save_wisdom()\n        \n        # ê²½ê³  ë©”ì‹œì§€\n        if pattern['count'] > 2:\n            print(f"âš ï¸ '{error_type}' ì˜¤ë¥˜ê°€ {pattern['count']}ë²ˆì§¸ ë°œìƒí–ˆìŠµë‹ˆë‹¤!")\n            print(f"ğŸ’¡ íŒ: {self._get_error_tip(error_type)}")\n    \n    def track_mistake(self, mistake_type: str, context: str = ""):\n        """ì‹¤ìˆ˜ ì¶”ì """\n        if mistake_type not in self.wisdom_data['common_mistakes']:\n            self.wisdom_data['common_mistakes'][mistake_type] = {\n                'count': 0,\n                'first_seen': datetime.now().isoformat(),\n                'contexts': []\n            }\n        \n        mistake = self.wisdom_data['common_mistakes'][mistake_type]\n        mistake['count'] += 1\n        mistake['last_seen'] = datetime.now().isoformat()\n        \n        if context and context not in mistake['contexts']:\n            mistake['contexts'].append(context)\n            mistake['contexts'] = mistake['contexts'][-3:]\n        \n        self.save_wisdom()\n        \n        # ì‹¤ì‹œê°„ ê²½ê³ \n        self._show_mistake_warning(mistake_type, mistake['count'])\n    \n    def _show_mistake_warning(self, mistake_type: str, count: int):\n        """ì‹¤ìˆ˜ì— ëŒ€í•œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ"""\n        warnings = {\n            'console_usage': f"ë˜ consoleì„ ì‚¬ìš©í•˜ì…¨ë„¤ìš”! ({count}ë²ˆì§¸) TypeScriptì—ì„œëŠ” loggerë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.",\n            'no_backup': f"ë°±ì—… ì—†ì´ íŒŒì¼ì„ ìˆ˜ì •í•˜ë ¤ê³  í•˜ì‹œë‚˜ìš”? ({count}ë²ˆì§¸) í•­ìƒ ë°±ì—… ë¨¼ì €!",\n            'direct_flow': f"flow_projectë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì…¨ë„¤ìš”! ({count}ë²ˆì§¸) execute_codeë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."\n        }\n        \n        if mistake_type in warnings:\n            print(f"\nâš ï¸ {warnings[mistake_type]}")\n            print(f"ğŸ’¡ ì˜¬ë°”ë¥¸ ë°©ë²•: {self._get_correct_way(mistake_type)}")\n    \n    def _get_correct_way(self, mistake_type: str) -> str:\n        """ì˜¬ë°”ë¥¸ ë°©ë²• ì œì‹œ"""\n        correct_ways = {\n            'console_usage': "import { logger } from '../utils/logger'; logger.info('ë©”ì‹œì§€');",\n            'no_backup': "backup = helpers.backup_file('file.py', 'ìˆ˜ì •_ì „')",\n            'direct_flow': "execute_code: helpers.cmd_flow_with_context('project-name')"\n        }\n        return correct_ways.get(mistake_type, "ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”")\n    \n    def _get_error_tip(self, error_type: str) -> str:\n        """ì˜¤ë¥˜ì— ëŒ€í•œ íŒ ì œê³µ"""\n        tips = {\n            'TypeError': "íƒ€ì…ì„ í™•ì¸í•˜ì„¸ìš”. TypeScriptë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ° ì˜¤ë¥˜ë¥¼ ì˜ˆë°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",\n            'FileNotFoundError': "íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”. os.path.join()ì„ ì‚¬ìš©í•˜ë©´ ì•ˆì „í•©ë‹ˆë‹¤.",\n            'KeyError': "ë”•ì…”ë„ˆë¦¬ í‚¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. dict.get('key', default)ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."\n        }\n        return tips.get(error_type, "ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìì„¸íˆ ì½ì–´ë³´ì„¸ìš”")\n    \n    def add_best_practice(self, practice: str, category: str = "general"):\n        """ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì¶”ê°€"""\n        practice_entry = {\n            'text': practice,\n            'category': category,\n            'added_at': datetime.now().isoformat()\n        }\n        \n        # ì¤‘ë³µ ì²´í¬\n        if not any(p['text'] == practice for p in self.wisdom_data['best_practices']):\n            self.wisdom_data['best_practices'].append(practice_entry)\n            self.save_wisdom()\n            print(f"âœ… ìƒˆë¡œìš´ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: {practice}")\n    \n    def save_wisdom(self):\n        """wisdom ë°ì´í„°ë¥¼ MD íŒŒì¼ë¡œ ì €ì¥"""\n        content = self._generate_wisdom_md()\n        self.wisdom_file.write_text(content, encoding='utf-8')\n        \n    def _generate_wisdom_md(self) -> str:\n        """wisdom ë°ì´í„°ë¥¼ MD í˜•ì‹ìœ¼ë¡œ ë³€í™˜"""\n        lines = [\n            "# ğŸ§  Project Wisdom - ai-coding-brain-mcp",\n            "",\n            "> ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ ì‘ì—… ì¤‘ ì¶•ì ëœ ì§€í˜œì™€ êµí›ˆì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.",\n            "",\n            "## ğŸ“Œ í”„ë¡œì íŠ¸ ë¹„ì „",\n            f"- í”„ë¡œì íŠ¸ëª…: {self.project_root.name}",\n            f"- ê²½ë¡œ: {self.project_root.absolute()}",\n            "- ì£¼ìš” ëª©ì : AI ê¸°ë°˜ ì½”ë”© ë„ìš°ë¯¸ MCP ì„œë²„",\n            "",\n            "## ğŸ› ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ íŒ¨í„´",\n            ""\n        ]\n        \n        # ì˜¤ë¥˜ íŒ¨í„´\n        for error_type, data in sorted(self.wisdom_data['error_patterns'].items(), \n                                     key=lambda x: x[1]['count'], reverse=True):\n            lines.extend([\n                f"### {error_type}",\n                f"- **ë°œìƒ íšŸìˆ˜**: {data['count']}íšŒ",\n                f"- **ìµœì´ˆ ë°œìƒ**: {data.get('first_seen', 'N/A')}",\n                f"- **ìµœê·¼ ë°œìƒ**: {data.get('last_seen', 'N/A')}",\n                f"- **í•´ê²° íŒ**: {self._get_error_tip(error_type)}",\n                ""\n            ])\n        \n        # ì‹¤ìˆ˜ íŒ¨í„´\n        lines.extend(["", "## âŒ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜ë“¤", ""])\n        for i, (mistake_type, data) in enumerate(sorted(self.wisdom_data['common_mistakes'].items(),\n                                                       key=lambda x: x[1]['count'], reverse=True), 1):\n            lines.extend([\n                f"{i}. **{mistake_type}**",\n                f"   - ë°œìƒ íšŸìˆ˜: {data['count']}íšŒ",\n                f"   - ìµœì´ˆ ë°œìƒ: {data.get('first_seen', 'N/A')}",\n                f"   - ì˜¬ë°”ë¥¸ ë°©ë²•: `{self._get_correct_way(mistake_type)}`",\n                ""\n            ])\n        \n        # ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤\n        lines.extend(["", "## âœ… ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤", ""])\n        categories = {}\n        for practice in self.wisdom_data['best_practices']:\n            cat = practice.get('category', 'general')\n            if cat not in categories:\n                categories[cat] = []\n            categories[cat].append(practice['text'])\n        \n        for category, practices in categories.items():\n            lines.append(f"### {category.title()}")\n            for practice in practices:\n                lines.append(f"- {practice}")\n            lines.append("")\n        \n        lines.extend([\n            "",\n            "---",\n            f"*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*"\n        ])\n        \n        return '\n'.join(lines)\n\n# ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤\n_wisdom_manager = None\n\ndef get_wisdom_manager(project_root: str = ".") -> ProjectWisdomManager:\n    """Wisdom Manager ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜"""\n    global _wisdom_manager\n    if _wisdom_manager is None:\n        _wisdom_manager = ProjectWisdomManager(project_root)\n    return _wisdom_manager\n